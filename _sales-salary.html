<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Tính lương Sale - StreamCargo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="p-6 border-b border-gray-200">
                <h1 class="text-2xl font-bold text-gray-800">QUẢN LÝ TÍNH LƯƠNG BỘ PHẬN SALE STREAMCARGO</h1>
                <p class="text-gray-600 mt-2">Hệ thống tính toán lương và hoa hồng dựa trên doanh số bán hàng</p>
                
                <!-- Key Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-money-bill-wave text-blue-600 text-2xl mr-3"></i>
                            <div>
                                <p class="text-sm text-gray-600">Lương cơ bản</p>
                                <p class="text-xl font-bold text-blue-600">6,700,000 ₫</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-exchange-alt text-green-600 text-2xl mr-3"></i>
                            <div>
                                <p class="text-sm text-gray-600">Tỷ giá bình quân</p>
                                <p class="text-xl font-bold text-green-600">186 ₫/¥</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-weight text-purple-600 text-2xl mr-3"></i>
                            <div>
                                <p class="text-sm text-gray-600">Lợi nhuận/kg</p>
                                <p class="text-xl font-bold text-purple-600">9,000 ₫</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-percentage text-orange-600 text-2xl mr-3"></i>
                            <div>
                                <p class="text-sm text-gray-600">Hoa hồng tối đa</p>
                                <p class="text-xl font-bold text-orange-600">20%</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column - Commission Structure -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">
                            <i class="fas fa-chart-line mr-2"></i>Bảng Tính Lương Theo Cấp Bậc
                        </h3>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-3 text-left font-semibold">Cấp bậc</th>
                                        <th class="p-3 text-center font-semibold">Doanh số tối thiểu (¥)</th>
                                        <th class="p-3 text-center font-semibold">Doanh số VND</th>
                                        <th class="p-3 text-center font-semibold">Chỉ số tính lương</th>
                                        <th class="p-3 text-center font-semibold">% Hoa hồng</th>
                                        <th class="p-3 text-center font-semibold">Phí dịch vụ</th>
                                        <th class="p-3 text-center font-semibold">Phí vận chuyển/kg</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <tr>
                                        <td class="p-3 font-medium text-gray-600">SALE Mới</td>
                                        <td class="p-3 text-center">100</td>
                                        <td class="p-3 text-center font-semibold">18,600 ₫</td>
                                        <td class="p-3 text-center">2%</td>
                                        <td class="p-3 text-center"><span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs">0%</span></td>
                                        <td class="p-3 text-center">300 ₫</td>
                                        <td class="p-3 text-center">Không có</td>
                                    </tr>
                                    <tr class="bg-blue-50">
                                        <td class="p-3 font-medium text-blue-800">SALE Level 1</td>
                                        <td class="p-3 text-center font-bold">200</td>
                                        <td class="p-3 text-center font-semibold text-blue-600">938,000 ₫</td>
                                        <td class="p-3 text-center">50%</td>
                                        <td class="p-3 text-center"><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full font-semibold">14%</span></td>
                                        <td class="p-3 text-center">350 ₫</td>
                                        <td class="p-3 text-center">1,260 ₫</td>
                                    </tr>
                                    <tr class="bg-green-50">
                                        <td class="p-3 font-medium text-green-800">SALE Level 2</td>
                                        <td class="p-3 text-center font-bold">300</td>
                                        <td class="p-3 text-center font-semibold text-green-600">1,072,000 ₫</td>
                                        <td class="p-3 text-center">50%</td>
                                        <td class="p-3 text-center"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full font-semibold">16%</span></td>
                                        <td class="p-3 text-center">500 ₫</td>
                                        <td class="p-3 text-center">1,440 ₫</td>
                                    </tr>
                                    <tr class="bg-purple-50">
                                        <td class="p-3 font-medium text-purple-800">SALE Level 3</td>
                                        <td class="p-3 text-center font-bold">400</td>
                                        <td class="p-3 text-center font-semibold text-purple-600">1,206,000 ₫</td>
                                        <td class="p-3 text-center">50%</td>
                                        <td class="p-3 text-center"><span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full font-semibold">18%</span></td>
                                        <td class="p-3 text-center">650 ₫</td>
                                        <td class="p-3 text-center">1,620 ₫</td>
                                    </tr>
                                    <tr class="bg-orange-50">
                                        <td class="p-3 font-medium text-orange-800">SALE Level 4</td>
                                        <td class="p-3 text-center font-bold">500</td>
                                        <td class="p-3 text-center font-semibold text-orange-600">1,340,000 ₫</td>
                                        <td class="p-3 text-center">50%</td>
                                        <td class="p-3 text-center"><span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full font-semibold">20%</span></td>
                                        <td class="p-3 text-center">800 ₫</td>
                                        <td class="p-3 text-center">1,800 ₫</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-4 text-xs text-gray-500">
                            <p><strong>Ghi chú:</strong></p>
                            <ul class="list-disc list-inside mt-1">
                                <li>Chỉ số tính lương tối đa 20% doanh thu</li>
                                <li>Phí dịch vụ: 2-5% giá trị đơn hàng</li>
                                <li>Phí thanh toán bên Nhật: 14-20% tùy cấp bậc</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Sales Performance Tracking -->
                <div class="bg-white rounded-lg shadow-md mt-6">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">
                                <i class="fas fa-users mr-2"></i>Theo dõi Hiệu suất Sale
                            </h3>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                                <i class="fas fa-plus mr-2"></i>Thêm Sale
                            </button>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-3 text-left font-semibold">Tên Sale</th>
                                        <th class="p-3 text-center font-semibold">Doanh số tháng (¥)</th>
                                        <th class="p-3 text-center font-semibold">Cấp bậc</th>
                                        <th class="p-3 text-center font-semibold">Hoa hồng ước tính</th>
                                        <th class="p-3 text-center font-semibold">Tổng lương</th>
                                        <th class="p-3 text-center font-semibold">Hành động</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200" id="sales-performance-tbody">
                                    <tr>
                                        <td class="p-3">
                                            <div class="flex items-center">
                                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-semibold mr-3">
                                                    NV
                                                </div>
                                                <div>
                                                    <p class="font-semibold">Nguyễn Văn A</p>
                                                    <p class="text-xs text-gray-500">ID: SALE001</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="p-3 text-center font-semibold text-green-600">850</td>
                                        <td class="p-3 text-center">
                                            <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-semibold">Level 4</span>
                                        </td>
                                        <td class="p-3 text-center font-semibold text-green-600">3,162,000 ₫</td>
                                        <td class="p-3 text-center font-bold text-blue-600">9,862,000 ₫</td>
                                        <td class="p-3 text-center">
                                            <button class="text-blue-600 hover:underline text-xs mr-2">Chi tiết</button>
                                            <button class="text-green-600 hover:underline text-xs">Tính lương</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="p-3">
                                            <div class="flex items-center">
                                                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-xs font-semibold mr-3">
                                                    TB
                                                </div>
                                                <div>
                                                    <p class="font-semibold">Trần Thị B</p>
                                                    <p class="text-xs text-gray-500">ID: SALE002</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="p-3 text-center font-semibold text-green-600">420</td>
                                        <td class="p-3 text-center">
                                            <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-semibold">Level 3</span>
                                        </td>
                                        <td class="p-3 text-center font-semibold text-green-600">1,409,760 ₫</td>
                                        <td class="p-3 text-center font-bold text-blue-600">8,109,760 ₫</td>
                                        <td class="p-3 text-center">
                                            <button class="text-blue-600 hover:underline text-xs mr-2">Chi tiết</button>
                                            <button class="text-green-600 hover:underline text-xs">Tính lương</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="p-3">
                                            <div class="flex items-center">
                                                <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center text-white text-xs font-semibold mr-3">
                                                    LC
                                                </div>
                                                <div>
                                                    <p class="font-semibold">Lê Văn C</p>
                                                    <p class="text-xs text-gray-500">ID: SALE003</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="p-3 text-center font-semibold text-green-600">180</td>
                                        <td class="p-3 text-center">
                                            <span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">Chưa đạt</span>
                                        </td>
                                        <td class="p-3 text-center font-semibold text-red-600">0 ₫</td>
                                        <td class="p-3 text-center font-bold text-blue-600">6,700,000 ₫</td>
                                        <td class="p-3 text-center">
                                            <button class="text-blue-600 hover:underline text-xs mr-2">Chi tiết</button>
                                            <button class="text-yellow-600 hover:underline text-xs">Cảnh báo</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Calculator & Statistics -->
            <div class="space-y-6">
                <!-- Salary Calculator -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-calculator mr-2"></i>Máy tính Lương
                        </h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Doanh số tháng (¥)</label>
                                <input type="number" id="sales-input" class="w-full p-3 border rounded-lg" placeholder="Nhập doanh số..." value="0">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Trọng lượng hàng (kg)</label>
                                <input type="number" id="weight-input" class="w-full p-3 border rounded-lg" placeholder="Nhập trọng lượng..." value="0">
                            </div>
                            
                            <button onclick="calculateSalary()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-semibold">
                                <i class="fas fa-calculator mr-2"></i>Tính Lương
                            </button>
                            
                            <div id="calculation-result" class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-gray-800 mb-3">Kết quả tính toán:</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>Cấp bậc:</span>
                                        <span id="result-level" class="font-semibold">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Lương cơ bản:</span>
                                        <span id="result-base" class="font-semibold">6,700,000 ₫</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Hoa hồng:</span>
                                        <span id="result-commission" class="font-semibold text-green-600">0 ₫</span>
                                    </div>
                                    <div class="flex justify-between border-t pt-2">
                                        <span class="font-semibold">Tổng lương:</span>
                                        <span id="result-total" class="font-bold text-blue-600">6,700,000 ₫</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Statistics -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-chart-bar mr-2"></i>Thống kê tháng này
                        </h3>
                        
                        <div class="space-y-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600">Tổng doanh số</p>
                                        <p class="text-2xl font-bold text-blue-600">1,450¥</p>
                                    </div>
                                    <i class="fas fa-yen-sign text-3xl text-blue-400"></i>
                                </div>
                            </div>
                            
                            <div class="bg-green-50 p-4 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600">Tổng tiền lương</p>
                                        <p class="text-2xl font-bold text-green-600">24,671,760 ₫</p>
                                    </div>
                                    <i class="fas fa-money-bill-wave text-3xl text-green-400"></i>
                                </div>
                            </div>
                            
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600">Số Sale hoạt động</p>
                                        <p class="text-2xl font-bold text-purple-600">3</p>
                                    </div>
                                    <i class="fas fa-users text-3xl text-purple-400"></i>
                                </div>
                            </div>
                            
                            <div class="bg-orange-50 p-4 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600">Sale đạt KPI</p>
                                        <p class="text-2xl font-bold text-orange-600">2/3</p>
                                    </div>
                                    <i class="fas fa-target text-3xl text-orange-400"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Chart -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-chart-line mr-2"></i>Biểu đồ Hiệu suất
                        </h3>
                        <canvas id="performanceChart" width="300" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Commission structure từ index.html
        const commissionStructure = [
            { level: 'Chưa đạt', minSales: 0, maxSales: 199, commission: 0, baseSalary: 6700000, serviceFee: 300, shippingFee: 0, color: 'red' },
            { level: 'Level 1', minSales: 200, maxSales: 299, commission: 0.14, baseSalary: 6700000, serviceFee: 350, shippingFee: 1260, color: 'blue' },
            { level: 'Level 2', minSales: 300, maxSales: 399, commission: 0.16, baseSalary: 6700000, serviceFee: 500, shippingFee: 1440, color: 'green' },
            { level: 'Level 3', minSales: 400, maxSales: 499, commission: 0.18, baseSalary: 6700000, serviceFee: 650, shippingFee: 1620, color: 'purple' },
            { level: 'Level 4', minSales: 500, maxSales: Infinity, commission: 0.20, baseSalary: 6700000, serviceFee: 800, shippingFee: 1800, color: 'orange' }
        ];
        const exchangeRate = 186;
        const profitPerKg = 9000;

        function calculateSalary() {
            const salesYen = parseFloat(document.getElementById('sales-input').value) || 0;
            const level = commissionStructure.find(tier => salesYen >= tier.minSales && salesYen <= tier.maxSales);
            
            if (!level) {
                alert('Không tìm thấy cấp bậc phù hợp');
                return;
            }
            
            const salesVND = salesYen * exchangeRate;
            const commission = salesVND * level.commission;
            const totalSalary = level.baseSalary + commission;
            
            document.getElementById('result-level').textContent = level.level;
            document.getElementById('result-base').textContent = level.baseSalary.toLocaleString('vi-VN') + ' ₫';
            document.getElementById('result-commission').textContent = commission.toLocaleString('vi-VN') + ' ₫';
            document.getElementById('result-total').textContent = totalSalary.toLocaleString('vi-VN') + ' ₫';
        }

        function initChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Nguyễn Văn A', 'Trần Thị B', 'Lê Văn C'],
                    datasets: [{
                        label: 'Doanh số (¥)',
                        data: [850, 420, 180],
                        backgroundColor: [
                            'rgba(249, 115, 22, 0.8)',
                            'rgba(147, 51, 234, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderColor: [
                            'rgba(249, 115, 22, 1)',
                            'rgba(147, 51, 234, 1)',
                            'rgba(239, 68, 68, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Doanh số (¥)' }
                        }
                    }
                }
            });
        }

        function viewSalesDetail(saleId) {
            console.log('Clicking viewSalesDetail with saleId:', saleId);
            alert('Đang mở chi tiết cho ' + saleId);
            // Thử cả 2 cách: same tab và new tab
            try {
                window.location.href = '_sales-detail.html?id=' + saleId;
            } catch (e) {
                window.open('_sales-detail.html?id=' + saleId, '_blank');
            }
        }
        
        function calculateDetailSalary(saleId) {
            const saleData = {
                'SALE001': { totalProfit: 437185422, salesYen: 2350445 },
                'SALE002': { totalProfit: 200000000, salesYen: 1200000 },
                'SALE003': { totalProfit: 0, salesYen: 180 }
            };
            
            const data = saleData[saleId];
            if (!data) return;
            
            const salesVND = data.salesYen * exchangeRate;
            const level = commissionStructure.find(tier => data.salesYen >= tier.minSales && data.salesYen <= tier.maxSales);
            
            if (level) {
                const commission = data.totalProfit * level.commission;
                const totalSalary = level.baseSalary + commission;
                
                alert(`Chi tiết lương cho ${saleId}:\n` +
                      `Lương cơ bản: ${level.baseSalary.toLocaleString('vi-VN')} ₫\n` +
                      `Tổng lợi nhuận: ${data.totalProfit.toLocaleString('vi-VN')} ₫\n` +
                      `Hoa hồng (${(level.commission*100).toFixed(0)}%): ${commission.toLocaleString('vi-VN')} ₫\n` +
                      `Tổng lương: ${totalSalary.toLocaleString('vi-VN')} ₫`);
            }
        }
        
        function showWarning(saleId) {
            alert('Cảnh báo: Sale ' + saleId + ' chưa đạt doanh số tối thiểu. Cần hỗ trợ và theo dõi thêm.');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded - initializing...');
            calculateSalary();
            initChart();
            
            // Auto-calculate when input changes
            document.getElementById('sales-input').addEventListener('input', calculateSalary);
            document.getElementById('weight-input').addEventListener('input', calculateSalary);
            
            // Add click event listeners to buttons
            console.log('Adding event listeners to buttons...');
            
            // Find all buttons and add event listeners
            const buttons = document.querySelectorAll('button');
            console.log('Found buttons:', buttons.length);
            
            buttons.forEach((button, index) => {
                console.log(`Button ${index}:`, button.textContent.trim());
                
                if (button.textContent.includes('Chi tiết')) {
                    console.log('Adding click listener to Chi tiết button');
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log('Chi tiết button clicked!');
                        
                        // Get the parent row to identify which sale
                        const row = button.closest('tr');
                        const nameElement = row.querySelector('p.font-semibold');
                        let saleId = 'SALE001'; // default
                        
                        if (nameElement) {
                            const name = nameElement.textContent.trim();
                            if (name === 'Nguyễn Văn A') saleId = 'SALE001';
                            else if (name === 'Trần Thị B') saleId = 'SALE002';
                            else if (name === 'Lê Văn C') saleId = 'SALE003';
                        }
                        
                        viewSalesDetail(saleId);
                    });
                }
                
                if (button.textContent.includes('Tính lương') && !button.textContent.includes('Tính Lương')) {
                    console.log('Adding click listener to Tính lương button');
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log('Tính lương button clicked!');
                        
                        const row = button.closest('tr');
                        const nameElement = row.querySelector('p.font-semibold');
                        let saleId = 'SALE001';
                        
                        if (nameElement) {
                            const name = nameElement.textContent.trim();
                            if (name === 'Nguyễn Văn A') saleId = 'SALE001';
                            else if (name === 'Trần Thị B') saleId = 'SALE002';
                        }
                        
                        calculateDetailSalary(saleId);
                    });
                }
                
                if (button.textContent.includes('Cảnh báo')) {
                    console.log('Adding click listener to Cảnh báo button');
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log('Cảnh báo button clicked!');
                        showWarning('SALE003');
                    });
                }
            });
        });
    </script>
</body>
</html>