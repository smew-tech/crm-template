<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrderSystem - Hệ thống Quản lý</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        .main-content {
            transition: margin-left 0.3s ease;
        }

        .active-nav {
            background-color: #EFF6FF;
            color: #3B82F6;
            font-weight: 600;
        }

        .active-nav i {
            color: #3B82F6;
        }

        .nav-item:hover {
            background-color: #F3F4F6;
        }

        .active-tab {
            border-bottom-color: #3B82F6;
            color: #3B82F6;
            font-weight: 600;
        }

        .modal-overlay {
            transition: opacity 0.3s ease;
        }

        .modal-content {
            transition: transform 0.3s ease;
        }

        /* CÀI ĐẶT CHO DROPDOWN */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            /* Mặc định ẩn đi */
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 180px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.1);
            z-index: 50;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        /* Class .show sẽ được thêm/xóa bằng JavaScript để hiển thị/ẩn dropdown */
        .dropdown-content.show {
            display: block;
        }

        .dropdown-content a {
            color: #374151;
            padding: 12px 16px;
            text-decoration: none;
            display: flex;
            align-items: center;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .dropdown-content a:hover {
            background-color: #f3f4f6;
        }

        .dropdown-content a i {
            margin-right: 12px;
            width: 16px;
            text-align: center;
            color: #6b7280;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans">
    <div class="flex">
        <aside id="sidebar" class="fixed h-full bg-white shadow-lg w-64 p-4 z-30">
            <div class="flex items-center space-x-2 mb-6">
                <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white text-lg"><i
                        class="fas fa-store"></i></div><span class="font-bold text-xl text-gray-800">OrderSystem</span>
            </div>
            <nav id="main-nav" class="space-y-2">
                <a href="_dashboard.html" data-title="Dashboard"
                    class="nav-item flex items-center px-4 py-3 text-gray-700 rounded-lg active-nav"><i
                        class="fas fa-tachometer-alt w-6 text-center text-gray-500"></i><span
                        class="ml-3">Dashboard</span></a>
                <a href="_order-management.html" data-title="Quản lý Đơn hàng"
                    class="nav-item flex items-center px-4 py-3 text-gray-700 rounded-lg"><i
                        class="fas fa-shopping-cart w-6 text-center text-gray-500"></i><span class="ml-3">Quản lý Đơn
                        hàng</span></a>
                <a href="_package-management.html" data-title="Quản lý Kho & Vận hành"
                    class="nav-item flex items-center px-4 py-3 text-gray-700 rounded-lg"><i
                        class="fas fa-warehouse w-6 text-center text-gray-500"></i><span class="ml-3">Quản lý Vận
                        hành</span></a>
                <a href="_financial-management.html" data-title="Quản lý Tài chính"
                    class="nav-item flex items-center px-4 py-3 text-gray-700 rounded-lg"><i
                        class="fas fa-wallet w-6 text-center text-gray-500"></i><span class="ml-3">Quản lý Tài
                        chính</span></a>
                <a href="_raw-materials-management.html" data-title="Quản lý Nguyên liệu (JPY)"
                    class="nav-item flex items-center px-4 py-3 text-gray-700 rounded-lg"><i
                        class="fas fa-yen-sign w-6 text-center text-gray-500"></i><span class="ml-3">Quản lý Nguyên liệu (JPY)</span></a>
                <a href="_sales-salary.html" data-title="Quản lý Lương Sale"
                    class="nav-item flex items-center px-4 py-3 text-gray-700 rounded-lg"><i
                        class="fas fa-wallet w-6 text-center text-gray-500"></i><span class="ml-3">Quản lý Lương Sale</span></a>
                <a href="_user-management.html" data-title="Quản lý Người dùng"
                    class="nav-item flex items-center px-4 py-3 text-gray-700 rounded-lg"><i
                        class="fas fa-users w-6 text-center text-gray-500"></i><span class="ml-3">Quản lý Người
                        dùng</span></a>
                <a href="_telesales-management.html" data-title="Quản lý Telesales"
                    class="nav-item flex items-center px-4 py-3 text-gray-700 rounded-lg"><i
                        class="fas fa-headset w-6 text-center text-gray-500"></i><span class="ml-3">Quản lý
                        Telesales</span></a>
                <a href="_auction-management.html" data-title="Hệ thống Đấu giá"
                    class="nav-item flex items-center px-4 py-3 text-gray-700 rounded-lg"><i
                        class="fas fa-gavel w-6 text-center text-gray-500"></i><span class="ml-3">Hệ thống Đấu
                        giá</span></a>
                <a href="_product-category-management.html" data-title="Quản lý Loại sản phẩm"
                    class="nav-item flex items-center px-4 py-3 text-gray-700 rounded-lg"><i
                        class="fas fa-tags w-6 text-center text-gray-500"></i><span class="ml-3">Loại sản phẩm &
                        Phí</span></a>

                <a href="_settings.html" data-title="Cài đặt Hệ thống"
                    class="nav-item flex items-center px-4 py-3 text-gray-700 rounded-lg"><i
                        class="fas fa-cog w-6 text-center text-gray-500"></i><span class="ml-3">Cài đặt Hệ
                        thống</span></a>
            </nav>
        </aside>

        <div id="main-content-container" class="main-content ml-64 w-full min-h-screen">
            <header
                class="sticky top-0 bg-white/80 backdrop-blur-sm z-20 flex justify-between items-center p-6 border-b">
                <h1 id="page-title" class="text-2xl font-bold text-gray-800">Dashboard</h1>

                <div class="dropdown">
                    <button id="profile-btn" class="flex items-center space-x-2 cursor-pointer">
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-500">
                            <i class="fas fa-user"></i>
                        </div>
                    </button>
                    <div id="profile-dropdown" class="dropdown-content">
                        <a href="#" class="nav-link" data-target-page="_my-profile.html" data-target-title="My Profile">
                            <i class="fas fa-user-circle"></i>My Profile
                        </a>
                        <a href="#">
                            <i class="fas fa-sign-out-alt"></i>Logout
                        </a>
                    </div>
                </div>
            </header>

            <main id="page-content-area" class="p-6">
            </main>
        </div>
    </div>

    <div id="view-reason-modal"
        class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg transform scale-95">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">Chi tiết Lý do Hủy/Từ chối</h3>
                <button type="button"
                    class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-sm">Lý do được cung cấp cho giao dịch <strong id="view-reason-transaction-id"
                        class="text-blue-600 font-mono"></strong>:</p>
                <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg text-gray-800 min-h-[80px]">
                    <p id="view-reason-text" class="whitespace-pre-wrap"></p>
                </div>
            </div>
            <div class="p-6 border-t bg-gray-50 text-right">
                <button type="button"
                    class="close-modal-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Đóng</button>
            </div>
        </div>
    </div>

    <div id="rejection-reason-modal"
        class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md transform scale-95">
            <form id="rejection-reason-form">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 id="rejection-modal-title" class="text-xl font-bold">Lý do Hủy/Từ chối</h3>
                    <button type="button"
                        class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                </div>
                <div class="p-6 space-y-4">
                    <p class="text-sm">Vui lòng nhập lý do <span id="rejection-action-text"></span> cho giao dịch
                        <strong id="rejection-transaction-id" class="text-blue-600"></strong>.
                    </p>
                    <div>
                        <label for="rejection_reason" class="block text-sm font-medium text-gray-700">Lý do</label>
                        <textarea id="rejection_reason" name="rejection_reason" rows="4" required
                            class="mt-1 w-full p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            placeholder="VD: Thông tin chuyển khoản không khớp..."></textarea>
                    </div>
                </div>
                <div class="p-6 border-t bg-gray-50 text-right space-x-2">
                    <button type="button"
                        class="close-modal-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Hủy
                        bỏ</button>
                    <button type="submit"
                        class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Xác nhận</button>
                </div>
            </form>
        </div>
    </div>

    <div id="reason-modal"
        class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md transform scale-95">
            <form id="reason-form">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 id="reason-modal-title" class="text-xl font-bold"></h3>
                    <button type="button"
                        class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                </div>
                <div class="p-6 space-y-4">
                    <p class="text-sm">Vui lòng nhập lý do <span id="reason-action-text" class="font-semibold"></span>
                        cho giao dịch <strong id="reason-transaction-id" class="text-blue-600 font-mono"></strong>.</p>
                    <div>
                        <label for="reason_text" class="block text-sm font-medium text-gray-700">Lý do</label>
                        <textarea id="reason_text" name="reason_text" rows="4" required
                            class="mt-1 w-full p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Nhập lý do..."></textarea>
                    </div>
                </div>
                <div class="p-6 border-t bg-gray-50 text-right space-x-2">
                    <button type="button"
                        class="close-modal-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Hủy
                        bỏ</button>
                    <button type="submit" id="reason-submit-btn" class="text-white font-bold py-2 px-4 rounded-lg">Xác
                        nhận</button>
                </div>
            </form>
        </div>
    </div>

    <div id="transaction-history-modal"
        class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl transform scale-95">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">Lịch sử Giao dịch: <span id="history-transaction-id"
                        class="text-blue-600 font-mono"></span></h3>
                <button type="button"
                    class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-6 max-h-[60vh] overflow-y-auto">
                <div id="history-timeline-container" class="space-y-6 border-l-2 border-gray-200 ml-3 pl-6">
                </div>
            </div>
            <div class="p-6 border-t bg-gray-50 text-right">
                <button type="button"
                    class="close-modal-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Đóng</button>
            </div>
        </div>
    </div>

    <div id="create-order-modal"
        class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div
            class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-full overflow-y-auto transform scale-95">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Tạo Đơn hàng mới</h3>
                <button class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div class="relative"><input type="text" placeholder="Dán link sản phẩm từ website (Amazon, Yahoo...)"
                        class="w-full pl-4 pr-20 py-2 border rounded-lg"><button
                        class="absolute right-1 top-1 bg-blue-500 text-white px-3 py-1 rounded-md text-sm">Lấy thông
                        tin</button></div>
                <input type="text" placeholder="Tên sản phẩm (sẽ được tự động điền)"
                    class="w-full p-2 border rounded-lg bg-gray-100" disabled>
                <div class="grid grid-cols-3 gap-4">
                    <input type="number" placeholder="Số lượng" class="w-full p-2 border rounded-lg">
                    <input type="text" placeholder="Giá (USD/JPY)" class="w-full p-2 border rounded-lg bg-gray-100"
                        disabled>
                    <select class="w-full p-2 border rounded-lg">
                        <option>Khu vực (Mỹ/Nhật)</option>
                        <option>Mỹ</option>
                        <option>Nhật</option>
                    </select>
                </div>
                <textarea placeholder="Ghi chú cho đơn hàng..." rows="3"
                    class="w-full p-2 border rounded-lg"></textarea>
            </div>
            <div class="p-6 border-t bg-gray-50 text-right space-x-2">
                <button
                    class="close-modal-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Hủy</button>
                <button class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Lưu Đơn
                    hàng</button>
            </div>
        </div>
    </div>

    <div id="order-detail-modal"
        class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div
            class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-full overflow-y-auto transform scale-95">
            <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                <h3 class="text-xl font-bold">Chi tiết Đơn hàng <span id="detail-order-id" class="text-blue-600"></span>
                </h3>
                <button class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="border rounded-lg">
                        <h4 class="font-bold p-3 bg-gray-50 border-b">Bảng chiết tính tài chính</h4>
                        <div class="p-3 text-sm space-y-2">
                            <div><span>Tiền hàng:</span><span class="float-right font-medium">15,000,000 đ</span></div>
                            <div><span>Phí mua hộ:</span><span class="float-right font-medium">150,000 đ</span></div>
                            <div><span>Phí vận chuyển QT:</span><span class="float-right font-medium">100,000 đ</span>
                            </div>
                            <div class="border-t pt-2 mt-2"><span>Tổng tiền:</span><span
                                    class="float-right font-bold text-lg text-blue-600">15,250,000 đ</span></div>
                            <div><span>Đã cọc:</span><span class="float-right font-medium text-green-600">9,150,000
                                    đ</span></div>
                            <div class="mt-2"><span>Còn lại phải trả:</span><span
                                    class="float-right font-bold text-lg text-red-600">6,100,000 đ</span></div>
                        </div>
                    </div>
                    <div class="border rounded-lg">
                        <h4 class="font-bold p-3 bg-gray-50 border-b">Danh sách sản phẩm</h4>
                        <div class="p-3">Sản phẩm A, Sản phẩm B...</div>
                    </div>
                    <div class="border rounded-lg">
                        <h4 class="font-bold p-3 bg-gray-50 border-b">Thông tin kiện hàng</h4>
                        <div class="p-3">Mã kiện: <span class="font-medium">MK12345</span>, Cân nặng: <span
                                class="font-medium">2.5 Kg</span></div>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="border rounded-lg">
                        <h4 class="font-bold p-3 bg-gray-50 border-b">Thông tin chung</h4>
                        <div class="p-3 text-sm space-y-1">
                            <p>Khách hàng: <strong id="detail-customer-name"></strong></p>
                            <p><strong>Nguồn:</strong> Amazon (Mỹ)</p>
                            <p><strong>Vận chuyển:</strong> SEA</p>
                            <p>Ngày tạo: <strong>05/08/2025</strong></p>
                            <p>Sales: <strong>Nguyễn Văn An</strong></p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm space-y-2">
                            <h4 class="font-bold text-base mb-2">Bảng chiết tính tài chính</h4>
                            <div><span>Tiền hàng:</span><span class="float-right font-medium">15,000,000 đ</span></div>
                            <div class="border-t pt-2 mt-2"><span>Tổng tiền:</span><span
                                    class="float-right font-bold text-lg text-blue-600">15,250,000 đ</span></div>
                        </div>
                    </div>
                    <div class="border rounded-lg">
                        <h4 class="font-bold p-3 bg-gray-50 border-b">Timeline trạng thái</h4>
                        <ul class="p-3 space-y-2 text-sm">
                            <li><i class="fas fa-check-circle text-green-500 mr-2"></i>Đã đặt cọc</li>
                            <li><i class="fas fa-check-circle text-green-500 mr-2"></i>Đã mua hàng</li>
                            <li><i class="far fa-circle text-gray-400 mr-2"></i>Hàng về kho</li>
                        </ul>
                    </div>
                    <div class="border rounded-lg">
                        <h4 class="font-bold p-3 bg-gray-50 border-b">Ghi chú nội bộ</h4>
                        <div class="p-3"><textarea rows="3"
                                class="w-full p-2 border rounded-lg text-sm"></textarea><button
                                class="mt-2 text-sm bg-gray-200 px-3 py-1 rounded">Lưu</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="bank-account-modal"
        class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg transform scale-95">
            <form id="bank-account-form">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 id="bank-modal-title" class="text-xl font-bold">Thêm tài khoản Ngân hàng mới</h3>
                    <button type="button"
                        class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                </div>
                <div class="p-6 space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700">Tên ngân hàng</label><input type="text"
                            name="bank_name" placeholder="VD: Vietcombank" class="mt-1 w-full p-2 border rounded-lg">
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700">Số tài khoản</label><input type="text"
                            name="account_number" placeholder="VD: 0123456789"
                            class="mt-1 w-full p-2 border rounded-lg"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Tên chủ tài khoản</label><input
                            type="text" name="account_name" placeholder="VD: CTY TNHH ORDER SYSTEM"
                            class="mt-1 w-full p-2 border rounded-lg"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Hạn mức/ngày (VND)</label><input
                            type="number" name="limit" placeholder="VD: 500000000"
                            class="mt-1 w-full p-2 border rounded-lg"></div>
                    <div><label class="block text-sm font-medium text-gray-700">Trạng thái</label><select name="status"
                            class="mt-1 w-full p-2 border rounded-lg">
                            <option value="active">Hoạt động</option>
                            <option value="paused">Tạm dừng</option>
                        </select></div>
                </div>
                <div class="p-6 border-t bg-gray-50 text-right space-x-2">
                    <button type="button"
                        class="close-modal-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Hủy</button>
                    <button type="submit"
                        class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <div id="assign-permission-modal"
        class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md transform scale-95">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 id="permission-modal-title" class="text-xl font-bold">Phân quyền Quản lý</h3>
                <button class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-6 text-left">
                <p class="text-sm text-gray-600 mb-4">Chọn các Admin được phép quản lý tài chính cho tài khoản <strong
                        id="permission-modal-bank-info" class="font-mono text-blue-700"></strong>.</p>
                <div class="space-y-3 max-h-60 overflow-y-auto p-2 border rounded-md bg-gray-50">
                    <label class="flex items-center space-x-3 p-2 hover:bg-gray-100 rounded-md cursor-pointer">
                        <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                        <span class="text-gray-800">admin@yourcompany.com (Super Admin)</span>
                    </label>
                    <label class="flex items-center space-x-3 p-2 hover:bg-gray-100 rounded-md cursor-pointer">
                        <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500"
                            checked>
                        <span class="text-gray-800">ketoan.1@yourcompany.com</span>
                    </label>
                    <label class="flex items-center space-x-3 p-2 hover:bg-gray-100 rounded-md cursor-pointer">
                        <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                        <span class="text-gray-800">ketoan.2@yourcompany.com</span>
                    </label>
                    <label class="flex items-center space-x-3 p-2 hover:bg-gray-100 rounded-md cursor-pointer">
                        <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500"
                            checked>
                        <span class="text-gray-800">quanly.td@yourcompany.com</span>
                    </label>
                </div>
            </div>
            <div class="p-6 border-t bg-gray-50 text-right space-x-2">
                <button
                    class="close-modal-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Hủy</button>
                <button id="save-permissions-btn"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Lưu thay
                    đổi</button>
            </div>
        </div>
    </div>

    <div id="customer-detail-modal"
        class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div
            class="modal-content bg-gray-100 rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] flex flex-col transform scale-95">
            <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10 flex-shrink-0">
                <h3 class="text-xl font-bold">Chi tiết Khách hàng: <span id="detail-customer-modal-name"
                        class="text-blue-600"></span></h3>
                <button class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto tab-container">
                <div class="border-b border-gray-200 mb-4 bg-white rounded-t-lg p-2 sticky top-0">
                    <nav class="flex space-x-6 -mb-px" aria-label="Tabs">
                        <a href="#detail-overview"
                            class="tab-link shrink-0 border-b-2 px-1 pb-3 text-sm font-medium active-tab">Tổng quan</a>
                        <a href="#detail-orders"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-3 text-sm font-medium text-gray-500">Lịch
                            sử Đơn hàng</a>
                        <a href="#detail-transactions"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-3 text-sm font-medium text-gray-500">Lịch
                            sử Giao dịch</a>
                        <a href="#detail-fees"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-3 text-sm font-medium text-gray-500">Cài
                            đặt Phí riêng</a>
                        <a href="#detail-notes"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-3 text-sm font-medium text-gray-500">Ghi
                            chú Nội bộ</a>
                    </nav>
                </div>
                <div id="detail-fees" class="tab-content hidden">
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h4 class="font-bold text-xl mb-2 text-gray-800">Cài đặt Phí & Vận chuyển Riêng</h4>
                        <p class="text-sm text-gray-600 mb-6">Gán các mức phí dịch vụ đặc biệt cho khách hàng này. Các
                            cài đặt này sẽ **ghi đè** lên chính sách mặc định của hệ thống.</p>

                        <div class="space-y-6">

                            <div class="border rounded-lg">
                                <div class="p-3 bg-gray-50 border-b flex justify-between items-center">
                                    <h4 class="font-bold text-gray-800">
                                        <i class="fas fa-tags fa-fw mr-2"></i>Chính sách Phí theo Loại Hàng Hóa
                                    </h4>
                                    <button
                                        class="text-sm bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-lg flex items-center shadow-sm">
                                        <i class="fas fa-plus mr-2"></i>Thêm
                                    </button>
                                </div>
                                <div class="p-4">
                                    <p class="text-xs text-gray-500 mb-4">Áp dụng mức phí dịch vụ khác nhau cho từng
                                        loại mặt hàng mà khách kinh doanh.</p>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full text-sm">
                                            <thead class="bg-gray-100">
                                                <tr>
                                                    <th class="p-2 font-semibold text-left">Loại Hàng Hóa</th>
                                                    <th class="p-2 font-semibold text-left">Mức Phí Áp Dụng</th>
                                                    <th class="p-2 font-semibold text-center">Hành động</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y">
                                                <tr>
                                                    <td class="p-2"><input type="text" value="Máy tính"
                                                            class="w-full p-1 border rounded"></td>
                                                    <td class="p-2">
                                                        <select class="w-full p-1 border rounded">
                                                            <option>Mặc định (3%)</option>
                                                            <option selected>Phí 2%</option>
                                                            <option>Phí 1%</option>
                                                            <option>Phí 0%</option>
                                                        </select>
                                                    </td>
                                                    <td class="p-2 text-center">
                                                        <button class="text-red-500 hover:text-red-700"><i
                                                                class="fas fa-trash"></i></button>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="p-2"><input type="text" value="Audio"
                                                            class="w-full p-1 border rounded"></td>
                                                    <td class="p-2">
                                                        <select class="w-full p-1 border rounded">
                                                            <option selected>Mặc định (3%)</option>
                                                            <option>Phí 2%</option>
                                                            <option>Phí 1%</option>
                                                            <option>Phí 0%</option>
                                                        </select>
                                                    </td>
                                                    <td class="p-2 text-center">
                                                        <button class="text-red-500 hover:text-red-700"><i
                                                                class="fas fa-trash"></i></button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="border rounded-lg">
                                <h4 class="font-bold p-3 bg-blue-50 border-b text-blue-800">
                                    <i class="fas fa-plane fa-fw mr-2"></i>Chính sách Vận chuyển AIR
                                </h4>
                                <div class="p-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                    <div><label class="font-semibold text-gray-600">Phí Dịch vụ</label><input
                                            type="text" value="3%" class="w-full p-2 border rounded mt-1"
                                            placeholder="Mặc định"></div>
                                    <div><label class="font-semibold text-gray-600">Giá Vận chuyển</label><input
                                            type="text" value="180.000" class="w-full p-2 border rounded mt-1"></div>
                                    <div><label class="font-semibold text-gray-600">Phụ Phí</label><input type="text"
                                            value="60.000" class="w-full p-2 border rounded mt-1"></div>
                                    <div><label class="font-semibold text-gray-600">Tỷ lệ cọc</label><input type="text"
                                            value="100%" class="w-full p-2 border rounded mt-1"></div>
                                </div>
                            </div>

                            <div class="border rounded-lg">
                                <h4 class="font-bold p-3 bg-green-50 border-b text-green-800">
                                    <i class="fas fa-ship fa-fw mr-2"></i>Chính sách Vận chuyển SEA
                                </h4>
                                <div class="p-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                    <div><label class="font-semibold text-gray-600">Phí Dịch vụ</label><input
                                            type="text" value="2%" class="w-full p-2 border rounded mt-1"
                                            placeholder="Mặc định"></div>
                                    <div><label class="font-semibold text-gray-600">Giá Vận chuyển</label><input
                                            type="text" value="90.000" class="w-full p-2 border rounded mt-1"></div>
                                    <div><label class="font-semibold text-gray-600">Phụ Phí</label><input type="text"
                                            value="100.000" class="w-full p-2 border rounded mt-1"></div>
                                    <div><label class="font-semibold text-gray-600">Tỷ lệ cọc</label><input type="text"
                                            value="100%" class="w-full p-2 border rounded mt-1"></div>
                                </div>
                            </div>
                        </div>

                        <div class="text-right mt-6 border-t pt-4">
                            <button
                                class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700 shadow-sm">
                                Lưu Tất Cả Cài Đặt
                            </button>
                        </div>
                    </div>
                </div>

                <div id="detail-overview" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <p class="text-sm text-gray-500">Tổng số Đơn hàng</p>
                            <p class="text-2xl font-bold">25</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <p class="text-sm text-gray-500">Tổng chi tiêu</p>
                            <p class="text-2xl font-bold">152.750.000đ</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <p class="text-sm text-gray-500">Công nợ hiện tại</p>
                            <p class="text-2xl font-bold text-red-600">5.450.000đ</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <div class="lg:col-span-2 space-y-4">
                            <div class="bg-white p-4 rounded-lg shadow-sm">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="font-bold">Sổ địa chỉ</h4><button
                                        class="text-sm text-blue-600 font-semibold">+
                                        Thêm địa chỉ</button>
                                </div>
                                <div class="border-t pt-2">
                                    <p class="font-semibold">Nhà riêng</p>
                                    <p class="text-sm text-gray-600">123 Đường ABC, Phường 4, Quận 5, TP. Hồ Chí Minh
                                    </p>
                                    <p class="text-sm text-gray-600">0987 654 321</p><span
                                        class="text-xs bg-gray-200 px-2 py-0.5 rounded-full">Mặc định</span>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-sm">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="font-bold">Tài khoản ngân hàng</h4><button
                                        class="text-sm text-blue-600 font-semibold">+ Thêm tài khoản</button>
                                </div>
                                <div class="border-t pt-2">
                                    <p class="font-semibold">Vietcombank</p>
                                    <p class="text-sm text-gray-600">STK: 0123456789</p>
                                    <p class="text-sm text-gray-600">Chủ TK: NGUYEN VAN AN</p>
                                </div>
                            </div>
                        </div>
                        <div class="lg:col-span-1 space-y-4">
                            <div class="bg-white p-4 rounded-lg shadow-sm">
                                <h4 class="font-bold mb-2">Thông tin liên hệ</h4>
                                <p class="text-sm text-gray-600">an.nguyen@email.com</p>
                                <p class="text-sm text-gray-600">0987 654 321</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-sm">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="font-bold">Nhân viên phụ trách</h4><button
                                        class="text-sm text-blue-600 font-semibold">Thay đổi</button>
                                </div>
                                <p class="text-sm font-semibold">John Doe</p>
                                <p class="text-xs text-gray-500">Sales Manager</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="detail-orders" class="tab-content hidden">
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <div class="grid grid-cols-3 gap-4 mb-4">
                            <input type="text" placeholder="Tìm theo mã đơn..."
                                class="col-span-3 md:col-span-1 px-2 py-1 border rounded">
                            <select class="px-2 py-1 border rounded">
                                <option>-- Lọc trạng thái --</option>
                            </select>
                            <input type="date" class="px-2 py-1 border rounded text-gray-500">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-2 text-left">Mã Đơn</th>
                                        <th class="p-2 text-left">Ngày tạo</th>
                                        <th class="p-2 text-right">Tổng tiền</th>
                                        <th class="p-2 text-center">Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">
                                    <tr>
                                        <td class="p-2 text-blue-600">#DH-0805-1</td>
                                        <td class="p-2">05/08/2025</td>
                                        <td class="p-2 text-right">15,250,000 đ</td>
                                        <td class="p-2 text-center"><span
                                                class="px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded-full font-medium">Chờ
                                                thanh toán đủ</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="detail-transactions" class="tab-content hidden">
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <div class="grid grid-cols-3 gap-4 mb-4">
                            <input type="text" placeholder="Tìm theo mã GD..."
                                class="col-span-3 md:col-span-1 px-2 py-1 border rounded">
                            <select class="px-2 py-1 border rounded">
                                <option>-- Lọc loại GD --</option>
                                <option>Nạp tiền</option>
                                <option>Thanh toán</option>
                                <option>Rút tiền</option>
                            </select>
                            <input type="date" class="px-2 py-1 border rounded text-gray-500">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-2 text-left">Mã GD</th>
                                        <th class="p-2 text-left">Loại</th>
                                        <th class="p-2 text-right">Số tiền</th>
                                        <th class="p-2 text-left">Ghi chú</th>
                                        <th class="p-2 text-left">Ngày</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">
                                    <tr>
                                        <td class="p-2">N-0805-1</td>
                                        <td class="p-2"><span class="text-green-600 font-medium">Nạp tiền</span></td>
                                        <td class="p-2 text-right text-green-600">+5,000,000 đ</td>
                                        <td class="p-2">CK thanh toán</td>
                                        <td class="p-2">05/08/2025</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="detail-notes" class="tab-content hidden">
                    <div class="bg-white rounded-lg shadow-sm p-4">
                        <h4 class="font-bold text-base mb-2">Thêm Ghi chú mới</h4>
                        <textarea rows="3" class="w-full p-2 border rounded-lg text-sm"
                            placeholder="Nhân viên thêm ghi chú về khách hàng tại đây..."></textarea>
                        <div class="text-right mt-2"><button
                                class="text-sm bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Lưu ghi
                                chú</button></div>
                        <hr class="my-4">
                        <h4 class="font-bold text-base mb-2">Lịch sử Ghi chú</h4>
                        <div class="space-y-6 border-l-2 border-gray-200 ml-3 pl-6">
                            <div class="relative">
                                <div
                                    class="absolute -left-[30px] top-1 w-4 h-4 bg-blue-500 rounded-full border-2 border-white">
                                </div>
                                <p class="font-medium">John Doe <span class="text-gray-500 font-normal text-sm">-
                                        2025-08-01 14:20</span></p>
                                <p class="text-gray-700 mt-1">Đã liên hệ khách hàng tư vấn về chính sách VIP. Khách hàng
                                    rất quan tâm.</p>
                            </div>
                            <div class="relative">
                                <div
                                    class="absolute -left-[30px] top-1 w-4 h-4 bg-gray-400 rounded-full border-2 border-white">
                                </div>
                                <p class="font-medium">Jane Smith <span class="text-gray-500 font-normal text-sm">-
                                        2025-07-25 09:00</span></p>
                                <p class="text-gray-700 mt-1">Khách hàng hỏi về tình trạng đơn hàng #OD2240, đã báo hàng
                                    đang trên đường về VN.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tier-policy-modal"
        class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg transform scale-95">
            <form>
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="text-xl font-bold">Chính sách cho Loại khách hàng: <span id="policy-tier-name"
                            class="text-yellow-500"></span></h3>
                    <button type="button"
                        class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                </div>
                <div class="p-6 space-y-4 text-sm">
                    <div><label class="font-medium text-gray-700">% Đặt cọc (Vận chuyển AIR)</label><input type="number"
                            value="70" class="mt-1 w-full p-2 border rounded-lg"></div>
                    <div><label class="font-medium text-gray-700">Phí dịch vụ (%)</label><input type="number" value="3"
                            class="mt-1 w-full p-2 border rounded-lg"></div>
                    <div><label class="font-medium text-gray-700">Phí hủy đơn (VND)</label><input type="number"
                            value="50000" class="mt-1 w-full p-2 border rounded-lg"></div>
                </div>
                <div class="p-6 border-t bg-gray-50 text-right space-x-2">
                    <button type="button"
                        class="close-modal-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Hủy</button>
                    <button type="submit"
                        class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Lưu Chính
                        sách</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-tier-modal"
        class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg transform scale-95">
            <form>
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="text-xl font-bold">Thêm Loại khách hàng mới</h3>
                    <button type="button"
                        class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                </div>
                <div class="p-6 space-y-4 text-sm">
                    <div><label class="font-medium text-gray-700">Tên Loại</label><input type="text"
                            placeholder="VD: Vàng" class="mt-1 w-full p-2 border rounded-lg"></div>
                    <div><label class="font-medium text-gray-700">Mô tả</label><input type="text"
                            placeholder="VD: Khách hàng tiềm năng" class="mt-1 w-full p-2 border rounded-lg"></div>
                    <div><label class="font-medium text-gray-700">% Đặt cọc (Vận chuyển AIR)</label><input type="number"
                            placeholder="VD: 80" class="mt-1 w-full p-2 border rounded-lg"></div>
                </div>
                <div class="p-6 border-t bg-gray-50 text-right space-x-2">
                    <button type="button"
                        class="close-modal-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Hủy</button>
                    <button type="submit"
                        class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Thêm
                        Loại</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-role-modal"
        class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md transform scale-95">
            <form>
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="text-xl font-bold">Thêm Vai trò mới</h3>
                    <button type="button"
                        class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                </div>
                <div class="p-6 space-y-4 text-sm">
                    <div><label class="font-medium text-gray-700">Tên Vai trò</label><input type="text"
                            placeholder="VD: Quản lý Kho" class="mt-1 w-full p-2 border rounded-lg"></div>
                </div>
                <div class="p-6 border-t bg-gray-50 text-right space-x-2">
                    <button type="button"
                        class="close-modal-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Hủy</button>
                    <button type="submit"
                        class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Thêm Vai
                        trò</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-yahoo-account-modal"
        class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md transform scale-95">
            <form>
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="text-xl font-bold">Thêm tài khoản Yahoo</h3>
                    <button type="button"
                        class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                </div>
                <div class="p-6 space-y-4 text-sm">
                    <div><label class="font-medium text-gray-700">Tên đăng nhập</label><input type="text"
                            placeholder="VD: yahoo_account_1" class="mt-1 w-full p-2 border rounded-lg"></div>
                    <div><label class="font-medium text-gray-700">Mật khẩu</label><input type="password"
                            class="mt-1 w-full p-2 border rounded-lg"></div>
                </div>
                <div class="p-6 border-t bg-gray-50 text-right space-x-2">
                    <button type="button"
                        class="close-modal-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Hủy</button>
                    <button type="submit"
                        class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Lưu tài
                        khoản</button>
                </div>
            </form>
        </div>
    </div>

    <div id="auction-detail-modal"
        class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div
            class="modal-content bg-gray-100 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col transform scale-95">
            <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10 flex-shrink-0">
                <h3 class="text-xl font-bold">Chi tiết Phiên đấu giá</h3>
                <button class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto space-y-4">
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <p><strong>Sản phẩm:</strong> Vintage Camera a7</p>
                    <p><strong>Link gốc:</strong> <a href="#"
                            class="text-blue-600 hover:underline">auctions.yahoo.co.jp/....</a></p>
                    <p><strong>Kết quả:</strong> <span class="font-bold text-green-600">Thắng bởi "Nguyễn Văn A" với giá
                            ¥25,000</span></p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold">Lịch sử Đấu giá (Nội bộ)</h4>
                        <button
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-lg flex items-center shadow-sm text-xs"><i
                                class="fas fa-file-excel mr-2"></i>Export Excel</button>
                    </div>
                    <div class="space-y-2 text-sm h-32 overflow-y-auto border p-2 rounded-lg bg-gray-50">
                        <p>[14:38:10] <span class="font-semibold text-blue-600">Trần Thị B</span> đặt Max Bid: <span
                                class="font-bold">¥25,000</span>. (Trở thành người dẫn đầu mới)</p>
                        <p>[14:35:05] <span class="font-semibold text-gray-600">Nguyễn Văn A</span> đặt Max Bid: <span
                                class="font-bold">¥22,000</span>.</p>
                        <p>[14:32:15] <span class="font-semibold text-blue-600">Trần Thị B</span> đặt Max Bid: <span
                                class="font-bold">¥20,000</span>. (Trở thành người dẫn đầu mới)</p>
                        <p>[14:30:00] <span class="font-semibold text-gray-600">Nguyễn Văn A</span> đặt Max Bid: <span
                                class="font-bold">¥18,000</span>.</p>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <h4 class="font-bold mb-2">Lịch sử Hoạt động của Bot</h4>
                    <div
                        class="space-y-2 text-sm h-32 overflow-y-auto border p-2 rounded-lg bg-gray-50 font-mono text-xs">
                        <p><span class="text-gray-500">[14:39:00]</span> [INFO] Bot (tk: yahoo_1) đặt giá thành công:
                            ¥25,000.</p>
                        <p><span class="text-gray-500">[14:38:15]</span> [INFO] Nhận lệnh mới từ "Trần Thị B", cập nhật
                            Max Bid lên ¥25,000.</p>
                        <p><span class="text-gray-500">[14:36:00]</span> [INFO] Bot (tk: yahoo_1) đặt giá thành công:
                            ¥22,500.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="product-category-modal"
        class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg transform scale-95">
            <form id="product-category-form">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 id="product-category-modal-title" class="text-xl font-bold">Thêm Loại sản phẩm mới</h3>
                    <button type="button"
                        class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                </div>
                <div class="p-6 space-y-4 text-sm">
                    <div><label class="font-medium text-gray-700">Tên Loại sản phẩm</label><input type="text"
                            name="category_name" placeholder="VD: Đồ điện tử" class="mt-1 w-full p-2 border rounded-lg">
                    </div>
                    <div><label class="font-medium text-gray-700">Mô tả</label><input type="text" name="description"
                            placeholder="VD: Các mặt hàng điện tử, công nghệ" class="mt-1 w-full p-2 border rounded-lg">
                    </div>
                    <div><label class="font-medium text-gray-700">Phụ phí (%)</label><input type="number"
                            name="surcharge" placeholder="VD: 5" class="mt-1 w-full p-2 border rounded-lg"></div>
                </div>
                <div class="p-6 border-t bg-gray-50 text-right space-x-2">
                    <button type="button"
                        class="close-modal-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Hủy</button>
                    <button type="submit"
                        class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <div id="assign-category-modal"
        class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md transform scale-95">
            <div class="p-6 border-b">
                <h3 class="text-xl font-bold">Gán Loại sản phẩm cho Đơn hàng</h3>
            </div>
            <div class="p-6 space-y-4">
                <p>Chọn loại sản phẩm phù hợp cho đơn hàng <strong id="assign-category-order-id"
                        class="text-blue-600"></strong>.</p>
                <select class="w-full p-2 border rounded-lg">
                    <option>-- Chọn loại sản phẩm --</option>
                    <option>Laptop</option>
                    <option>Mỹ phẩm</option>
                    <option>Quần áo</option>
                </select>
            </div>
            <div class="p-6 border-t bg-gray-50 text-right space-x-2">
                <button type="button"
                    class="close-modal-btn bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Hủy</button>
                <button type="button" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg">Xác nhận</button>
            </div>
        </div>
    </div>

    <div id="staff-modal"
        class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl transform scale-95">
            <form id="staff-form">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 id="staff-modal-title" class="text-xl font-bold">Thêm Nhân viên mới</h3>
                    <button type="button"
                        class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                </div>
                <div class="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Họ và tên <span
                                    class="text-red-500">*</span></label>
                            <input type="text" name="staff_name" required class="mt-1 w-full p-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email <span
                                    class="text-red-500">*</span></label>
                            <input type="email" name="staff_email" required class="mt-1 w-full p-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Số điện thoại</label>
                            <input type="tel" name="staff_phone" class="mt-1 w-full p-2 border rounded-lg">
                        </div>
                        <div>
                             <label class="block text-sm font-medium text-gray-700">Mật khẩu</label>
                             <input type="password" name="staff_password" placeholder="Để trống nếu không thay đổi" class="mt-1 w-full p-2 border rounded-lg">
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700">Trạng thái</label>
                             <select name="staff_status" class="mt-1 w-full p-2 border rounded-lg">
                                 <option value="active">Hoạt động</option>
                                 <option value="locked">Đã khóa</option>
                             </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mt-4">Vai trò</label>
                        <div class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-4 p-4 border rounded-lg bg-gray-50">
                            <label class="flex items-center"><input type="checkbox" name="roles" value="admin"
                                    class="rounded h-4 w-4"> <span class="ml-2">Admin</span></label>
                            <label class="flex items-center"><input type="checkbox" name="roles" value="sales"
                                    class="rounded h-4 w-4"> <span class="ml-2">Sales</span></label>
                            <label class="flex items-center"><input type="checkbox" name="roles" value="accountant"
                                    class="rounded h-4 w-4"> <span class="ml-2">Kế toán</span></label>
                            <label class="flex items-center"><input type="checkbox" name="roles" value="warehouse"
                                    class="rounded h-4 w-4"> <span class="ml-2">Nhân viên kho</span></label>
                        </div>
                    </div>
                </div>
                <div class="p-6 border-t bg-gray-50 text-right space-x-2">
                    <button type="button"
                        class="close-modal-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Hủy</button>
                    <button type="submit"
                        class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Lưu</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-sales-modal"
        class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg transform scale-95">
            <form id="add-sales-form">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 id="add-sales-modal-title" class="text-xl font-bold">Thêm Nhân viên Sales mới</h3>
                    <button type="button"
                        class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label for="sales-search" class="block text-sm font-medium text-gray-700">Tìm kiếm và chọn Nhân
                            viên</label>
                        <p class="text-xs text-gray-500 mb-2">Chỉ các nhân viên chưa có vai trò "Sales" mới được hiển thị.
                        </p>
                        <input type="text" id="sales-search" name="sales-search"
                            placeholder="Nhập tên hoặc email để tìm kiếm..." class="mt-1 w-full p-2 border rounded-lg">
                    </div>
                    <div class="max-h-60 overflow-y-auto border rounded-md p-2 bg-gray-50 space-y-2">
                        <label class="flex items-center p-2 rounded-md hover:bg-gray-100 cursor-pointer">
                            <input type="checkbox" name="sales_staff" value="staff1"
                                class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <div class="ml-3 text-sm">
                                <p class="font-medium text-gray-900">Lê Minh Tuấn</p>
                                <p class="text-gray-500">tuan.lm@company.com</p>
                            </div>
                        </label>
                        <label class="flex items-center p-2 rounded-md hover:bg-gray-100 cursor-pointer">
                            <input type="checkbox" name="sales_staff" value="staff2"
                                class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <div class="ml-3 text-sm">
                                <p class="font-medium text-gray-900">Phạm Thị Mai</p>
                                <p class="text-gray-500">mai.pt@company.com</p>
                            </div>
                        </label>
                    </div>
                </div>
                <div class="p-6 border-t bg-gray-50 text-right space-x-2">
                    <button type="button"
                        class="close-modal-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Hủy
                        bỏ</button>
                    <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Thêm làm
                        Sales</button>
                </div>
            </form>
        </div>
    </div>


    <div id="item-detail-modal"
        class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div
            class="modal-content bg-gray-50 rounded-lg shadow-xl w-full max-w-5xl max-h-[95vh] flex flex-col transform scale-95">
            <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                <h3 class="text-xl font-bold">Chi tiết Sản phẩm: <span id="item-detail-stt"
                        class="text-blue-600 font-mono"></span></h3><button
                    class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6">
                <div class="bg-white p-4 rounded-lg shadow-sm border">
                    <h4 class="font-semibold text-base mb-4 border-b pb-2 text-gray-700">Thông tin Vận hành & Logistics
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                        <div><label class="font-medium text-gray-600">Ngày TT</label><input type="text"
                                placeholder="dd/mm" class="mt-1 w-full p-2 border rounded-lg"></div>
                        <div><label class="font-medium text-gray-600">Ngày về</label><input type="text"
                                placeholder="dd/mm" class="mt-1 w-full p-2 border rounded-lg"></div>
                        <div><label class="font-medium text-gray-600">Mã Kiện</label><input type="text"
                                class="mt-1 w-full p-2 border rounded-lg"></div>
                        <div class="col-span-full"><label class="font-medium text-gray-600">Mã Tracking</label><input
                                type="text" class="mt-1 w-full p-2 border rounded-lg"></div>
                        <div class="col-span-full"><label class="font-medium text-gray-600">Link sản phẩm</label><input
                                type="text" class="mt-1 w-full p-2 border rounded-lg"></div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border">
                    <h4 class="font-semibold text-base mb-4 border-b pb-2 text-gray-700">Chi phí Gốc</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div><label class="font-medium text-gray-600">Giá Mua (¥)</label><input type="number"
                                class="mt-1 w-full p-2 border rounded-lg"></div>
                        <div><label class="font-medium text-gray-600">Ship (¥)</label><input type="number"
                                class="mt-1 w-full p-2 border rounded-lg"></div>
                        <div><label class="font-medium text-gray-600">Phí DV (¥)</label><input type="number"
                                class="mt-1 w-full p-2 border rounded-lg"></div>
                        <div><label class="font-medium text-gray-600">Phụ Phí (VND)</label><input type="number"
                                class="mt-1 w-full p-2 border rounded-lg"></div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border">
                    <h4 class="font-semibold text-base mb-4 border-b pb-2 text-gray-700">Tổng kết & Thanh toán</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-x-6 gap-y-4 text-sm">
                        <div class="text-blue-700"><label class="font-bold">Tổng Chi Phí</label><input type="text"
                                value="0" class="mt-1 w-full p-2 border bg-blue-50 rounded-lg font-bold" readonly></div>
                        <div class="text-yellow-700"><label class="font-bold">Cần Cọc</label><input type="text"
                                value="0" class="mt-1 w-full p-2 border bg-yellow-50 rounded-lg font-bold" readonly>
                        </div>
                        <div class="text-red-700"><label class="font-bold">Công Nợ</label><input type="text" value="0"
                                class="mt-1 w-full p-2 border bg-red-50 rounded-lg font-bold" readonly></div>
                        <div></div>
                        <div class="col-span-full border-t mt-2 pt-4 grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div><label class="font-medium text-green-600">Cọc đã TT</label><input type="number"
                                    class="mt-1 w-full p-2 border rounded-lg text-green-600"></div>
                            <div><label class="font-medium text-green-600">Thanh toán sau cọc</label><input
                                    type="number" class="mt-1 w-full p-2 border rounded-lg text-green-600"></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border">
                    <h4 class="font-semibold text-base mb-4 border-b pb-2 text-gray-700">Kiểm duyệt & Ghi chú</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="font-medium text-gray-600">Ghi chú vận hành</label>
                            <textarea rows="3" class="mt-1 w-full p-2 border rounded-lg text-sm"></textarea>
                        </div>
                        <div class="space-y-3">
                            <label class="font-medium text-gray-600">Checklist Kiểm duyệt</label>
                            <label class="flex items-center"><input type="checkbox" class="rounded h-4 w-4"> <span
                                    class="ml-2 text-sm">Đối Kiểm</span></label>
                            <label class="flex items-center"><input type="checkbox" class="rounded h-4 w-4"> <span
                                    class="ml-2 text-sm">Yêu Cầu Ảnh</span></label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-100 border-t text-right sticky bottom-0"><button
                    class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700 shadow-sm">Lưu Thay
                    Đổi</button></div>
        </div>
    </div>

    <div id="manual-deposit-modal"
        class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg transform scale-95">
            <form>
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="text-xl font-bold">Nạp tiền Thủ công cho User</h3>
                    <button type="button"
                        class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tìm kiếm Khách hàng</label>
                        <input type="text" placeholder="Nhập UserID, Tên, hoặc Email..."
                            class="mt-1 w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Số tiền nạp (VND)</label>
                        <input type="number" placeholder="VD: 5000000" class="mt-1 w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tài khoản công ty đã nhận</label>
                        <select class="mt-1 w-full p-2 border rounded-lg">
                            <option>Vietcombank - 0123456789</option>
                            <option>Techcombank - 9876543210</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Mã giao dịch (từ sao kê)</label>
                        <input type="text" placeholder="VD: FT240814..." class="mt-1 w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Lý do nạp tiền <span
                                class="text-red-500">*</span></label>
                        <textarea rows="3" required class="mt-1 w-full p-2 border rounded-lg"
                            placeholder="VD: Khách chuyển khoản sai cú pháp, đã đối soát và nạp tay."></textarea>
                    </div>
                </div>
                <div class="p-6 border-t bg-gray-50 text-right space-x-2">
                    <button type="button"
                        class="close-modal-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Hủy
                        bỏ</button>
                    <button type="submit"
                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Xác nhận Nạp
                        tiền</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const pageContentArea = document.getElementById('page-content-area');
            const pageTitle = document.getElementById('page-title');
            const mainNavLinks = document.querySelectorAll('#main-nav .nav-item');

            // --- LOGIC MODAL ---
            const modals = document.querySelectorAll('.modal-overlay');
            modals.forEach(modal => {
                const closeButtons = modal.querySelectorAll('.close-modal-btn');
                closeButtons.forEach(btn => btn.addEventListener('click', () => modal.classList.add('hidden')));
                modal.addEventListener('click', e => { if (e.target === modal) modal.classList.add('hidden'); });
            });
            function openModal(modalId) {
                document.getElementById(modalId)?.classList.remove('hidden');
            }

            // Initialize tabs on page load
            function initializeTabs() {
                // Simple tab initialization - just ensure active tabs show their content
                document.querySelectorAll('.tab-container').forEach(container => {
                    const navs = container.querySelectorAll('nav');
                    navs.forEach(nav => {
                        const activeTab = nav.querySelector('.tab-link.active-tab');
                        if (activeTab) {
                            const targetId = activeTab.getAttribute('href');
                            if (targetId && targetId.startsWith('#')) {
                                // Find all tab links in this nav and their corresponding content
                                const allLinks = nav.querySelectorAll('.tab-link');
                                allLinks.forEach(link => {
                                    const linkTarget = link.getAttribute('href');
                                    if (linkTarget && linkTarget.startsWith('#')) {
                                        const content = document.querySelector(linkTarget);
                                        if (content) {
                                            if (linkTarget === targetId) {
                                                // Show active content
                                                content.classList.remove('hidden');
                                            } else {
                                                // Hide inactive content
                                                content.classList.add('hidden');
                                            }
                                        }
                                    }
                                });
                            }
                        }
                    });
                });
            }

            // Sales Detail Functions - MUST BE BEFORE loadContent
            window.salesDetailData = [
                { code: "SC247", kg: 0, serviceFee: 0, totalPayment: 0, profitVC: 0, profitFee: 0, profitRate: 0, total: 0, status: "inactive" },
                { code: "SC208", kg: 0, serviceFee: 0, totalPayment: 0, profitVC: 0, profitFee: 0, profitRate: 0, total: 0, status: "inactive" },
                { code: "SC191", kg: 2.4, serviceFee: 2333, totalPayment: 77760, profitVC: 52800, profitFee: 438659, profitRate: 657228, total: 15492624, status: "active" },
                { code: "SC231", kg: 55.5, serviceFee: 1003, totalPayment: 33420, profitVC: 4400, profitFee: 188489, profitRate: 703048, total: 10931449, status: "active" },
                { code: "SC168", kg: 3.3, serviceFee: 0, totalPayment: 594025, profitVC: 72600, profitFee: 0, profitRate: 7070272, total: 111021778, status: "vip" }
            ];
            
            window.formatCurrencyInIndex = function(amount, currency = 'VND') {
                if (currency === 'VND') {
                    return amount.toLocaleString('vi-VN') + ' ₫';
                } else if (currency === 'JPY') {
                    return '¥' + amount.toLocaleString('vi-VN');
                }
                return amount.toLocaleString('vi-VN');
            };

            window.getStatusBadgeInIndex = function(status) {
                const statusConfig = {
                    'inactive': { class: 'bg-gray-200 text-gray-800', text: 'Không hoạt động' },
                    'active': { class: 'bg-green-100 text-green-800', text: 'Hoạt động' },
                    'vip': { class: 'bg-purple-100 text-purple-800', text: 'VIP' }
                };
                const config = statusConfig[status] || statusConfig.inactive;
                return `<span class="px-2 py-1 ${config.class} rounded-full text-xs font-medium">${config.text}</span>`;
            };

            window.populateDetailTableInIndex = function() {
                console.log('populateDetailTableInIndex called, data:', window.salesDetailData);
                const tbody = document.getElementById('sales-tbody');
                if (!tbody) {
                    console.error('tbody not found');
                    return;
                }
                tbody.innerHTML = window.salesDetailData.map(item => `
                    <tr class="${item.status === 'inactive' ? 'bg-gray-50 opacity-60' : 'hover:bg-gray-50'}">
                        <td class="p-3 font-semibold sticky left-0 ${item.status === 'inactive' ? 'bg-gray-50' : 'bg-white'}">${item.code}</td>
                        <td class="p-3 text-center">${item.kg}</td>
                        <td class="p-3 text-center">${window.formatCurrencyInIndex(item.serviceFee, 'JPY')}</td>
                        <td class="p-3 text-center">${window.formatCurrencyInIndex(item.totalPayment, 'JPY')}</td>
                        <td class="p-3 text-right">${window.formatCurrencyInIndex(item.profitVC)}</td>
                        <td class="p-3 text-right">${window.formatCurrencyInIndex(item.profitFee)}</td>
                        <td class="p-3 text-right">${window.formatCurrencyInIndex(item.profitRate)}</td>
                        <td class="p-3 text-right font-bold ${item.total > 0 ? 'text-green-600' : 'text-gray-400'} bg-yellow-50">${window.formatCurrencyInIndex(item.total)}</td>
                        <td class="p-3 text-center">${window.getStatusBadgeInIndex(item.status)}</td>
                    </tr>
                `).join('');
                console.log('Table populated successfully');
            };

            window.initDetailChartsInIndex = function() {
                console.log('initDetailChartsInIndex called');
                const profitCtx = document.getElementById('profitChart');
                if (!profitCtx) {
                    console.log('profitChart not found');
                    return;
                }
                
                const totalProfitVC = window.salesDetailData.reduce((sum, item) => sum + item.profitVC, 0);
                const totalProfitFee = window.salesDetailData.reduce((sum, item) => sum + item.profitFee, 0);
                const totalProfitRate = window.salesDetailData.reduce((sum, item) => sum + item.profitRate, 0);
                
                new Chart(profitCtx.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: ['Lợi nhuận VC', 'Lợi nhuận Phí TT', 'Lợi nhuận Tỷ giá'],
                        datasets: [{
                            data: [totalProfitVC, totalProfitFee, totalProfitRate],
                            backgroundColor: ['#3B82F6', '#10B981', '#F59E0B'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
                console.log('Charts initialized successfully');
            };

            // --- HÀM TẢI VÀ HIỂN THỊ NỘI DUNG ---
            const loadContent = async (url, title, targetTab = null) => {
                console.log('loadContent called with:', { url, title, targetTab });
                try {
                    pageContentArea.innerHTML = '<p class="text-center text-gray-500">Đang tải...</p>';
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status} - Could not find file ${url}`);
                    const content = await response.text();
                    pageContentArea.innerHTML = content;
                    if (title) pageTitle.textContent = title;

                    // Initialize tabs for the new content
                    setTimeout(() => {
                        initializeTabs();
                        
                        console.log('Content loaded, URL:', url);
                        
                        // Initialize sales-detail page if loaded
                        if (url.includes('_sales-detail.html')) {
                            console.log('Detected sales-detail.html, initializing...');
                            
                            // Check if elements exist
                            const tbody = document.getElementById('sales-tbody');
                            const profitChart = document.getElementById('profitChart');
                            const topCustomersChart = document.getElementById('topCustomersChart');
                            
                            console.log('Found elements:', {
                                tbody: !!tbody,
                                profitChart: !!profitChart,
                                topCustomersChart: !!topCustomersChart
                            });
                            
                            if (tbody) {
                                console.log('Populating table...');
                                console.log('Sales data:', window.salesDetailData);
                                window.populateDetailTableInIndex();
                                console.log('Table populated. New tbody HTML:', tbody.innerHTML.substring(0, 200) + '...');
                            } else {
                                console.error('Table body not found!');
                            }
                            
                            if (profitChart || topCustomersChart) {
                                console.log('Initializing charts...');
                                try {
                                    window.initDetailChartsInIndex();
                                    console.log('Charts initialized successfully');
                                } catch (error) {
                                    console.error('Error initializing charts:', error);
                                }
                            } else {
                                console.error('Chart canvases not found!');
                            }
                        } else {
                            console.log('URL does not contain _sales-detail.html:', url);
                            
                            // Force check for sales table regardless of URL
                            const forceTbody = document.getElementById('sales-tbody');
                            if (forceTbody) {
                                console.log('Found sales-tbody in other page, force populating...');
                                window.populateDetailTableInIndex();
                                window.initDetailChartsInIndex();
                            }
                        }
                        
                        if (targetTab) {
                            const tabLink = pageContentArea.querySelector(`.tab-link[href="${targetTab}"]`);
                            if (tabLink) {
                                tabLink.click();
                            }
                        }
                    }, 200);
                } catch (error) {
                    console.error('Lỗi tải trang:', error);
                    pageContentArea.innerHTML = `<div class="text-center text-red-500"><p class="font-bold">Không thể tải nội dung.</p></div>`;
                }
            };

            // --- XỬ LÝ CLICK MENU CHÍNH ---
            mainNavLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    mainNavLinks.forEach(item => item.classList.remove('active-nav'));
                    this.classList.add('active-nav');
                    const contentUrl = this.getAttribute('href');
                    const title = this.getAttribute('data-title');
                    loadContent(contentUrl, title);
                });
            });

            // --- LOGIC CHO PROFILE DROPDOWN ---
            const profileBtn = document.getElementById('profile-btn');
            const profileDropdown = document.getElementById('profile-dropdown');

            profileBtn.addEventListener('click', function (event) {
                event.stopPropagation(); // Ngăn sự kiện click lan ra ngoài
                profileDropdown.classList.toggle('show');
            });

            // Đóng dropdown khi click ra ngoài
            window.addEventListener('click', function (event) {
                if (!profileBtn.contains(event.target)) {
                    if (profileDropdown.classList.contains('show')) {
                        profileDropdown.classList.remove('show');
                    }
                }
            });

            // --- SỬ DỤNG EVENT DELEGATION CHO TẤT CẢ HÀNH ĐỘNG BÊN TRONG CONTENT ---
            document.addEventListener('click', function (event) {
                const target = event.target;

                // XỬ LÝ ADMIN ORDER CREATION
                if (target.closest('#create-order-btn')) {
                    event.preventDefault();
                    openCreateOrderModal();
                    return;
                }

                if (target.closest('.close-modal-btn') && target.closest('#admin-create-order-modal')) {
                    event.preventDefault();
                    closeCreateOrderModal();
                    return;
                }

                const navLink = target.closest('.nav-link');
                if (navLink && navLink.dataset.targetPage) {
                    event.preventDefault();
                    const targetPage = navLink.dataset.targetPage;
                    const targetTab = navLink.dataset.targetTab;
                    const targetTitle = navLink.dataset.targetTitle;

                    mainNavLinks.forEach(item => item.classList.remove('active-nav'));
                    const correspondingNavLink = document.querySelector(`#main-nav a[href="${targetPage}"]`);
                    if (correspondingNavLink) correspondingNavLink.classList.add('active-nav');

                    loadContent(targetPage, targetTitle, targetTab);
                    return;
                }

                const tabLink = target.closest('.tab-link');
                if (tabLink) {
                    event.preventDefault();

                    const tabContainer = tabLink.closest('.tab-container');
                    const nav = tabLink.closest('nav');

                    if (!tabContainer || !nav) return;

                    const allTabsInGroup = nav.querySelectorAll('.tab-link');

                    allTabsInGroup.forEach(link => {
                        link.classList.remove('active-tab');
                        link.classList.add('text-gray-500', 'border-transparent', 'hover:border-gray-300', 'hover:text-gray-700');

                        const contentId = link.getAttribute('href');
                        if (contentId && contentId.startsWith('#')) {
                            const pane = tabContainer.querySelector(contentId);
                            if (pane) {
                                pane.classList.add('hidden');
                            }
                        }
                    });

                    tabLink.classList.add('active-tab');
                    tabLink.classList.remove('text-gray-500', 'border-transparent', 'hover:border-gray-300', 'hover:text-gray-700');

                    const targetContentId = tabLink.getAttribute('href');
                    if (targetContentId) {
                        const targetContent = tabContainer.querySelector(targetContentId);
                        if (targetContent) {
                            targetContent.classList.remove('hidden');
                        }
                    }

                    return;
                }

                // XỬ LÝ ORDER MANAGEMENT ACTIONS FIRST (before sales buttons)
                // Handle order management buttons using data attributes
                const orderButton = target.closest('button[data-action][data-order-id]');
                if (orderButton) {
                    event.preventDefault();
                    const action = orderButton.getAttribute('data-action');
                    const orderId = orderButton.getAttribute('data-order-id');
                    
                    console.log('Order button clicked - Action:', action, 'Order ID:', orderId);
                    
                    if (action === 'warehouse') {
                        console.log('Opening warehouse actions for:', orderId);
                        if (window.showWarehouseActions) {
                            window.showWarehouseActions(orderId);
                        } else {
                            console.error('showWarehouseActions function not available');
                        }
                    } else if (action === 'detail') {
                        console.log('Opening order detail for:', orderId);
                        if (window.showOrderDetail) {
                            window.showOrderDetail(orderId);
                        } else {
                            console.error('showOrderDetail function not available');
                        }
                    } else if (action === 'ship_to_vn') {
                        console.log('Ship to VN action for:', orderId);
                        // Handle ship to VN action here
                        alert(`Chuyển đơn hàng ${orderId} sang kho VN`);
                    } else if (action === 'approve') {
                        console.log('Approve action for:', orderId);
                        if (window.showApproveModal) {
                            window.showApproveModal(orderId);
                        }
                    } else if (action === 'edit') {
                        console.log('Edit action for:', orderId);
                        alert(`Chỉnh sửa đơn hàng ${orderId}`);
                    } else if (action === 'add_tracking') {
                        console.log('Add tracking action for:', orderId);
                        alert(`Thêm tracking cho đơn hàng ${orderId}`);
                    } else if (action === 'check_goods') {
                        console.log('Check goods action for:', orderId);
                        alert(`Kiểm hàng cho đơn hàng ${orderId}`);
                    } else if (action === 'complete_check') {
                        console.log('Complete check action for:', orderId);
                        alert(`Hoàn thành kiểm hàng cho đơn hàng ${orderId}`);
                    } else if (action === 'ship_order') {
                        console.log('Ship order action for:', orderId);
                        alert(`Giao hàng cho đơn hàng ${orderId}`);
                    } else if (action === 'update_status') {
                        console.log('Update status action for:', orderId);
                        alert(`Cập nhật trạng thái cho đơn hàng ${orderId}`);
                    }
                    return;
                }

                // XỬ LÝ SALES BUTTONS
                const salesDetailBtn = target.closest('button');
                if (salesDetailBtn && salesDetailBtn.textContent.includes('Chi tiết')) {
                    event.preventDefault();
                    console.log('Sales Chi tiết button clicked from index.html');
                    console.log('Button element:', salesDetailBtn);
                    console.log('Button text:', salesDetailBtn.textContent);
                    
                    // Get the parent row to identify which sale
                    const row = salesDetailBtn.closest('tr');
                    const nameElement = row ? row.querySelector('p.font-semibold') : null;
                    let saleId = 'SALE001'; // default
                    
                    if (nameElement) {
                        const name = nameElement.textContent.trim();
                        if (name === 'Nguyễn Văn A') saleId = 'SALE001';
                        else if (name === 'Trần Thị B') saleId = 'SALE002';
                        else if (name === 'Lê Văn C') saleId = 'SALE003';
                    }
                    
                    console.log('Opening sales detail for:', saleId);
                    console.log('About to call loadContent...');
                    loadContent('_sales-detail.html?id=' + saleId, 'Chi tiết Doanh số Sale');
                    return;
                }
                
                if (salesDetailBtn && salesDetailBtn.textContent.includes('Tính lương') && !salesDetailBtn.textContent.includes('Tính Lương')) {
                    event.preventDefault();
                    console.log('Sales Tính lương button clicked from index.html');
                    
                    const row = salesDetailBtn.closest('tr');
                    const nameElement = row ? row.querySelector('p.font-semibold') : null;
                    let saleId = 'SALE001';
                    
                    if (nameElement) {
                        const name = nameElement.textContent.trim();
                        if (name === 'Nguyễn Văn A') saleId = 'SALE001';
                        else if (name === 'Trần Thị B') saleId = 'SALE002';
                    }
                    
                    window.calculateDetailSalaryInIndex(saleId);
                    return;
                }
                
                if (salesDetailBtn && salesDetailBtn.textContent.includes('Cảnh báo')) {
                    event.preventDefault();
                    console.log('Sales Cảnh báo button clicked from index.html');
                    alert('Cảnh báo: Sale SALE003 chưa đạt doanh số tối thiểu. Cần hỗ trợ và theo dõi thêm.');
                    return;
                }
                
                // XỬ LÝ BACK BUTTON TRONG SALES DETAIL
                const backToSalesBtn = target.closest('.back-to-sales-btn');
                if (backToSalesBtn) {
                    event.preventDefault();
                    console.log('Back to sales button clicked');
                    loadContent('_sales-salary.html', 'Quản lý Lương Sale');
                    return;
                }
                
                // XỬ LÝ SALE SELECTOR TRONG SALES DETAIL
                if (target.id === 'sale-selector') {
                    console.log('Sale selector changed:', target.value);
                    const selectedSale = target.value;
                    window.updateSalesDetailPageInIndex(selectedSale);
                    return;
                }

                // XỬ LÝ MỞ POPUP TẠO ĐƠN
                const createOrderBtn = target.closest('#create-order-btn');
                if (createOrderBtn) {
                    openModal('create-order-modal');
                    return;
                }

                // XỬ LÝ MỞ POPUP XEM CHI TIẾT
                const viewDetailLink = target.closest('.view-detail-link');
                if (viewDetailLink) {
                    event.preventDefault();
                    const orderRow = viewDetailLink.closest('tr');
                    if (orderRow) {
                        const orderId = orderRow.dataset.orderId;
                        const customerName = orderRow.dataset.customer;
                        document.getElementById('detail-order-id').textContent = orderId || '';
                        document.getElementById('detail-customer-name').textContent = customerName || '';
                    }
                    openModal('order-detail-modal');
                    return;
                }

                // XỬ LÝ MỞ POPUP TẠO/SỬA NGÂN HÀNG
                const bankModalTitle = document.getElementById('bank-modal-title');
                const bankForm = document.getElementById('bank-account-form');

                // Mở popup để THÊM MỚI
                const addBankBtn = target.closest('#add-bank-account-btn');
                if (addBankBtn) {
                    bankModalTitle.textContent = 'Thêm tài khoản Ngân hàng mới';
                    bankForm.reset(); // Xóa trắng form
                    openModal('bank-account-modal');
                    return;
                }

                // Mở popup để SỬA
                const editBankLink = target.closest('.edit-bank-link');
                if (editBankLink) {
                    event.preventDefault();
                    bankModalTitle.textContent = 'Chỉnh sửa tài khoản Ngân hàng';
                    // Lấy dữ liệu từ data attributes và điền vào form
                    const row = editBankLink.closest('tr');
                    bankForm.elements['bank_name'].value = row.dataset.bankName;
                    bankForm.elements['account_number'].value = row.dataset.accountNumber;
                    bankForm.elements['account_name'].value = row.dataset.accountName;
                    bankForm.elements['limit'].value = row.dataset.limit;
                    bankForm.elements['status'].value = row.dataset.status;
                    openModal('bank-account-modal');
                    return;
                }

                const assignPermissionLink = target.closest('.assign-permission-link');
                if (assignPermissionLink) {
                    event.preventDefault();
                    const row = assignPermissionLink.closest('tr');
                    const bankName = row.dataset.bankName;
                    const accountNumber = row.dataset.accountNumber;

                    document.getElementById('permission-modal-bank-info').textContent = `${bankName} - ${accountNumber}`;
                    openModal('assign-permission-modal');
                    return;
                }

                // XỬ LÝ MỞ DIALOG XEM LÝ DO
                const viewReasonBtn = target.closest('.view-reason-btn');
                if (viewReasonBtn) {
                    event.preventDefault();
                    const row = viewReasonBtn.closest('tr');
                    const transactionId = row.dataset.transactionId;
                    const reason = row.dataset.rejectionReason;

                    document.getElementById('view-reason-transaction-id').textContent = transactionId;
                    document.getElementById('view-reason-text').textContent = reason || 'Không có lý do được cung cấp.';

                    openModal('view-reason-modal');
                    return;
                }

                // XỬ LÝ MỞ DIALOG NHẬP LÝ DO KHI HỦY LỆNH NẠP TIỀN
                const cancelDepositBtn = target.closest('.cancel-deposit-btn');
                if (cancelDepositBtn) {
                    event.preventDefault();
                    const transactionId = cancelDepositBtn.closest('tr').dataset.transactionId;

                    document.getElementById('rejection-action-text').textContent = 'hủy';
                    document.getElementById('rejection-transaction-id').textContent = transactionId;
                    document.getElementById('rejection-reason-form').reset();

                    openModal('rejection-reason-modal');
                    return;
                }

                // XỬ LÝ MỞ DIALOG NHẬP LÝ DO KHI TỪ CHỐI LỆNH RÚT TIỀN
                const rejectWithdrawalBtn = target.closest('.reject-withdrawal-btn');
                if (rejectWithdrawalBtn) {
                    event.preventDefault();
                    const transactionId = rejectWithdrawalBtn.closest('tr').dataset.transactionId;

                    document.getElementById('rejection-action-text').textContent = 'từ chối';
                    document.getElementById('rejection-transaction-id').textContent = transactionId;
                    document.getElementById('rejection-reason-form').reset();

                    openModal('rejection-reason-modal');
                    return;
                }

                // --- LOGIC MỚI CHO DIALOG NHẬP LÝ DO (DÙNG CHUNG) ---
                const cancelBtn = target.closest('.cancel-deposit-btn');
                const rejectBtn = target.closest('.reject-withdrawal-btn');
                const restoreBtn = target.closest('.restore-btn');

                if (cancelBtn || rejectBtn || restoreBtn) {
                    event.preventDefault();
                    const row = target.closest('tr');
                    const transactionId = row.dataset.transactionId;

                    const modalTitleEl = document.getElementById('reason-modal-title');
                    const actionTextEl = document.getElementById('reason-action-text');
                    const submitBtn = document.getElementById('reason-submit-btn');

                    if (cancelBtn || rejectBtn) {
                        modalTitleEl.textContent = 'Lý do Hủy/Từ chối';
                        actionTextEl.textContent = cancelBtn ? 'hủy' : 'từ chối';
                        submitBtn.className = 'bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg';
                        submitBtn.textContent = 'Xác nhận';
                    } else if (restoreBtn) {
                        modalTitleEl.textContent = 'Lý do Khôi phục';
                        actionTextEl.textContent = 'khôi phục';
                        submitBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg';
                        submitBtn.textContent = 'Xác nhận Khôi phục';
                    }

                    document.getElementById('reason-transaction-id').textContent = transactionId;
                    document.getElementById('reason-form').reset();
                    openModal('reason-modal');
                    return;
                }

                // XỬ LÝ MỞ DIALOG XEM LỊCH SỬ
                const viewHistoryBtn = target.closest('.view-history-btn');
                if (viewHistoryBtn) {
                    event.preventDefault();
                    const row = viewHistoryBtn.closest('tr');
                    const transactionId = row.dataset.transactionId;
                    const historyData = JSON.parse(row.dataset.history || '[]');

                    document.getElementById('history-transaction-id').textContent = transactionId;

                    const timelineContainer = document.getElementById('history-timeline-container');
                    timelineContainer.innerHTML = ''; // Xóa lịch sử cũ

                    if (historyData.length > 0) {
                        historyData.forEach(item => {
                            const actionColor = item.action.includes('Hủy') || item.action.includes('Từ chối') ? 'red' : 'blue';
                            const historyItem = `
                                <div class="relative">
                                    <div class="absolute -left-[31px] top-1 w-4 h-4 bg-${actionColor}-500 rounded-full border-2 border-white"></div>
                                    <p class="font-medium text-gray-800">${item.action} <span class="text-gray-500 font-normal text-sm">- ${item.timestamp}</span></p>
                                    <p class="text-sm text-gray-600 mt-1"><strong>Người thực hiện:</strong> ${item.performer}</p>
                                    ${item.reason ? `<div class="mt-2 p-2 bg-gray-100 rounded-md text-sm"><strong class="text-gray-700">Ghi chú/Lý do:</strong><p class='mt-1 text-gray-600'>${item.reason}</p></div>` : ''}
                                </div>`;
                            timelineContainer.insertAdjacentHTML('beforeend', historyItem);
                        });
                    } else {
                        timelineContainer.innerHTML = '<p class="text-gray-500">Không có lịch sử cho giao dịch này.</p>';
                    }

                    openModal('transaction-history-modal');
                    return;
                }

                // MỞ POPUP XEM CHI TIẾT KHÁCH HÀNG
                const viewCustomerLink = target.closest('.view-customer-link');
                if (viewCustomerLink) {
                    event.preventDefault();
                    const row = viewCustomerLink.closest('tr');
                    document.getElementById('detail-customer-modal-name').textContent = row.dataset.customerName;
                    openModal('customer-detail-modal');
                    return;
                }

                // MỞ POPUP SỬA CHÍNH SÁCH
                const editPolicyLink = target.closest('.edit-policy-link');
                if (editPolicyLink) {
                    event.preventDefault();
                    const row = editPolicyLink.closest('tr');
                    document.getElementById('policy-tier-name').textContent = row.dataset.tierName;
                    openModal('tier-policy-modal');
                    return;
                }

                // MỞ POPUP THÊM LOẠI KHÁCH HÀNG
                const addTierBtn = target.closest('#add-tier-btn');
                if (addTierBtn) {
                    openModal('add-tier-modal');
                    return;
                }

                // MỞ POPUP THÊM VAI TRÒ MỚI
                const addRoleBtn = target.closest('#add-role-btn');
                if (addRoleBtn) {
                    openModal('add-role-modal');
                    return;
                }

                // MỞ POPUP THÊM TÀI KHOẢN YAHOO
                const addYahooBtn = target.closest('#add-yahoo-account-btn');
                if (addYahooBtn) {
                    openModal('add-yahoo-account-modal');
                    return;
                }

                // MỞ POPUP CHI TIẾT PHIÊN ĐẤU GIÁ
                const viewAuctionLink = target.closest('.view-auction-link');
                if (viewAuctionLink) {
                    event.preventDefault();
                    openModal('auction-detail-modal');
                    return;
                }

                // MỞ POPUP THÊM/SỬA LOẠI SẢN PHẨM
                const productCategoryModal = document.getElementById('product-category-modal');
                const productCategoryForm = document.getElementById('product-category-form');
                const productCategoryModalTitle = document.getElementById('product-category-modal-title');

                // Mở popup để THÊM MỚI
                const addCategoryBtn = target.closest('#add-product-category-btn');
                if (addCategoryBtn) {
                    productCategoryModalTitle.textContent = 'Thêm Loại sản phẩm mới';
                    productCategoryForm.reset();
                    openModal('product-category-modal');
                    return;
                }

                // Mở popup để SỬA
                const editCategoryLink = target.closest('.edit-product-category-link');
                if (editCategoryLink) {
                    event.preventDefault();
                    productCategoryModalTitle.textContent = 'Chỉnh sửa Loại sản phẩm';
                    const row = editCategoryLink.closest('tr');
                    // Điền dữ liệu vào form
                    productCategoryForm.elements['category_name'].value = row.dataset.categoryName;
                    productCategoryForm.elements['description'].value = row.dataset.description;
                    productCategoryForm.elements['surcharge'].value = row.dataset.surcharge;
                    openModal('product-category-modal');
                    return;
                }

                // MỞ POPUP GÁN LOẠI SẢN PHẨM
                const assignCategoryBtn = target.closest('.assign-category-btn');
                if (assignCategoryBtn) {
                    event.preventDefault();
                    const orderId = assignCategoryBtn.closest('tr').dataset.orderId;
                    document.getElementById('assign-category-order-id').textContent = orderId;
                    openModal('assign-category-modal');
                    return;
                }


                // --- XỬ LÝ CHO POPUP NHÂN VIÊN & VAI TRÒ ---
                const staffModal = document.getElementById('staff-modal');
                const staffForm = document.getElementById('staff-form');
                const staffModalTitle = document.getElementById('staff-modal-title');

                // Mở popup để THÊM MỚI NHÂN VIÊN
                const addStaffBtn = target.closest('#add-staff-btn');
                if (addStaffBtn) {
                    staffModalTitle.textContent = 'Thêm Nhân viên mới';
                    staffForm.reset();
                    openModal('staff-modal');
                    return;
                }
                
                // MỞ POPUP THÊM SALES
                const addSalesBtn = target.closest('#add-sales-btn');
                if (addSalesBtn) {
                    openModal('add-sales-modal');
                    return;
                }


                // Mở popup để SỬA NHÂN VIÊN
                const editStaffLink = target.closest('.edit-staff-link');
                if (editStaffLink) {
                    event.preventDefault();
                    staffModalTitle.textContent = 'Chỉnh sửa Nhân viên';
                    const row = editStaffLink.closest('tr');
                    // Điền dữ liệu vào form
                    staffForm.elements['staff_name'].value = row.dataset.staffName;
                    staffForm.elements['staff_email'].value = row.dataset.staffEmail;
                    // Reset all checkboxes before setting new ones
                    staffForm.querySelectorAll('input[name="roles"]').forEach(checkbox => checkbox.checked = false);
                    const roles = row.dataset.roles.split(',');
                    roles.forEach(role => {
                        const checkbox = staffForm.querySelector(`input[value="${role.trim()}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                    openModal('staff-modal');
                    return;
                }

                // --- LOGIC MỚI CHO VIỆC CHỌN NHÂN VIÊN --- 
                const staffCard = target.closest('.staff-card');
                if (staffCard) {
                    event.preventDefault();

                    const staffListContainer = staffCard.closest('.staff-list-container');
                    if (!staffListContainer) return;

                    staffListContainer.querySelectorAll('.staff-card').forEach(card => {
                        card.classList.remove('bg-blue-100', 'border-l-4', 'border-blue-500');
                        card.classList.add('hover:bg-gray-100');
                    });
                    staffCard.classList.add('bg-blue-100', 'border-l-4', 'border-blue-500');
                    staffCard.classList.remove('hover:bg-gray-100');

                    const staffDetailContainer = document.querySelector('#staff-detail-container');
                    if (staffDetailContainer) {
                        const staffName = staffCard.dataset.staffName;
                        staffDetailContainer.querySelector('#staff-detail-name').textContent = staffName;

                        const detailTabContainer = staffDetailContainer.querySelector('.tab-container');
                        if (detailTabContainer) {
                            const allTabs = detailTabContainer.querySelectorAll('.tab-link');
                            const allContents = detailTabContainer.querySelectorAll('.tab-content');

                            allTabs.forEach(tab => tab.classList.remove('active-tab'));
                            allContents.forEach(content => content.classList.add('hidden'));

                            const firstTab = detailTabContainer.querySelector('.tab-link');
                            if (firstTab) {
                                firstTab.classList.add('active-tab');
                                const firstContentId = firstTab.getAttribute('href').substring(1);
                                const firstContent = detailTabContainer.querySelector(`#${firstContentId}`);
                                if (firstContent) firstContent.classList.remove('hidden');
                            }
                        }
                    }
                    return;
                }

                // --- LOGIC CHO TRANG QUẢN LÝ KHO & VẬN HÀNH ---

                // Thêm dòng mới
                const saveNewItemBtn = target.closest('#save-new-item-btn');
                if (saveNewItemBtn) {
                    const form = document.getElementById('add-item-form');
                    const tableBody = document.getElementById('item-ledger-tbody');
                    if (form && tableBody) {
                        const stt = form.querySelector('#new-stt').value.trim() || 'N/A';
                        const ma_kh = form.querySelector('#new-ma-kh').value.trim() || 'N/A';
                        const san_pham = form.querySelector('#new-san-pham').value.trim() || 'Chưa có tên';
                        const ma_kien = form.querySelector('#new-ma-kien').value.trim() || '-';
                        const newRowHTML = `<tr class="hover:bg-gray-50 bg-yellow-50"><td class="p-2 font-mono font-medium">${stt}</td><td class="p-2">${san_pham}</td><td class="p-2 font-mono">${ma_kien}</td><td class="p-2 font-semibold">${ma_kh}</td><td class="p-2 text-right font-semibold">0 ₫</td><td class="p-2 text-right font-bold text-red-500">0 ₫</td><td class="p-2 text-center"><span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full font-medium">Mới</span></td><td class="p-2 text-center"><button class="view-item-detail-btn text-indigo-600 font-medium text-xs">Xem & Sửa</button></td></tr>`;
                        tableBody.insertAdjacentHTML('afterbegin', newRowHTML);
                        form.querySelectorAll('input').forEach(input => input.value = '');
                        form.querySelector('#new-stt').focus();
                    }
                    return;
                }

                const viewDetailBtn = target.closest('.view-item-detail-btn');
                if (viewDetailBtn) {
                    const stt = viewDetailBtn.closest('tr').querySelector('td:first-child').textContent;
                    document.getElementById('item-detail-stt').textContent = stt;
                    openModal('item-detail-modal');
                    return;
                }

                // MỞ DIALOG NẠP TIỀN THỦ CÔNG
                const manualDepositBtn = target.closest('#manual-deposit-btn');
                if (manualDepositBtn) {
                    openModal('manual-deposit-modal');
                    return;
                }

                // XỬ LÝ WITHDRAWAL QR BUTTON
                const withdrawalBtn = target.closest('.view-withdrawal-btn');
                if (withdrawalBtn) {
                    console.log('Withdrawal QR button clicked');
                    handleWithdrawalClick(withdrawalBtn);
                    return;
                }

                // XỬ LÝ CLOSE WITHDRAWAL MODAL
                if (target.closest('#withdrawal-details-modal .close-modal-btn')) {
                    console.log('Closing withdrawal modal via close button');
                    closeModal('withdrawal-details-modal');
                    return;
                }

                // XỬ LÝ CONFIRM/REJECT WITHDRAWAL
                if (target.closest('#withdrawal-details-modal button')) {
                    const button = target.closest('button');
                    const buttonText = button.textContent.trim();
                    
                    if (buttonText.includes('Xác nhận') || buttonText.includes('Từ chối')) {
                        console.log('Withdrawal action:', buttonText);
                        // Thực hiện action tương ứng ở đây
                        alert(`Đã ${buttonText.includes('Xác nhận') ? 'xác nhận' : 'từ chối'} giao dịch rút tiền`);
                        closeModal('withdrawal-details-modal');
                        return;
                    }
                }

            });

            // XỬ LÝ WITHDRAWAL MODAL
            function handleWithdrawalClick(btn) {
                console.log('Processing withdrawal click for:', btn);
                
                const withdrawalId = btn.getAttribute('data-withdrawal-id');
                const customer = btn.getAttribute('data-customer'); 
                const amount = btn.getAttribute('data-amount');
                const status = btn.getAttribute('data-status');
                const bankInfoStr = btn.getAttribute('data-bank-info');
                
                console.log('Data:', {withdrawalId, customer, amount, status, bankInfoStr});
                
                try {
                    const bankInfo = JSON.parse(bankInfoStr);
                    
                    // Update modal content
                    document.getElementById('modal-withdrawal-id').textContent = withdrawalId;
                    document.getElementById('modal-customer').textContent = customer;
                    document.getElementById('modal-amount').textContent = amount + ' VNĐ';
                    document.getElementById('modal-bank').textContent = bankInfo.bank;
                    document.getElementById('modal-account').textContent = bankInfo.account;
                    document.getElementById('modal-account-name').textContent = bankInfo.name;
                    
                    // Update status display
                    const statusElement = document.getElementById('modal-status');
                    const qrSection = document.querySelector('#withdrawal-details-modal .space-y-4:last-child');
                    const actionButtons = document.querySelector('#withdrawal-details-modal .flex.flex-col.sm\\:flex-row');
                    
                    switch(status) {
                        case 'pending':
                            statusElement.textContent = 'Chờ xử lý';
                            statusElement.className = 'px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full font-medium';
                            
                            // Show QR section and action buttons
                            qrSection.style.display = 'block';
                            actionButtons.style.display = 'flex';
                            
                            // Generate QR Code for pending transactions
                            const qrData = `Ngan hang: ${bankInfo.bank}
So TK: ${bankInfo.account}
Chu TK: ${bankInfo.name}
So tien: ${amount} VND
Ma GD: ${withdrawalId}
Noi dung: Rut tien ${withdrawalId}`;
                            
                            const canvas = document.getElementById('qr-canvas');
                            if (typeof QRCode !== 'undefined') {
                                QRCode.toCanvas(canvas, qrData, {
                                    width: 192,
                                    height: 192,
                                    color: {
                                        dark: '#000000',
                                        light: '#FFFFFF'
                                    }
                                }, function (error) {
                                    if (error) console.error('Error generating QR code:', error);
                                });
                            }
                            break;
                            
                        case 'completed':
                            statusElement.textContent = 'Đã hoàn thành';
                            statusElement.className = 'px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium';
                            
                            // Hide QR section and action buttons
                            qrSection.style.display = 'none';
                            actionButtons.style.display = 'none';
                            break;
                            
                        case 'rejected':
                            statusElement.textContent = 'Bị từ chối';
                            statusElement.className = 'px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full font-medium';
                            
                            // Hide QR section and action buttons
                            qrSection.style.display = 'none';
                            actionButtons.style.display = 'none';
                            break;
                    }
                    
                    openModal('withdrawal-details-modal');
                    
                } catch (error) {
                    console.error('Error processing withdrawal data:', error);
                    alert('Có lỗi xảy ra: ' + error.message);
                }
            }

            // Download QR code handler
            document.addEventListener('click', function(e) {
                if (e.target.id === 'download-qr') {
                    const canvas = document.getElementById('qr-canvas');
                    const withdrawalId = document.getElementById('modal-withdrawal-id').textContent;
                    
                    const link = document.createElement('a');
                    link.download = `QR_RutTien_${withdrawalId}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                }

                // Close modal when clicking outside
                if (e.target.id === 'withdrawal-details-modal') {
                    console.log('Closing withdrawal modal by clicking outside');
                    closeModal('withdrawal-details-modal');
                }
            });

            // Tải trang mặc định
            const defaultLink = document.querySelector('#main-nav .active-nav');
            if (defaultLink) {
                loadContent(defaultLink.getAttribute('href'), defaultLink.getAttribute('data-title'));
            }

            // Tab functionality for all pages
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('tab-link') || e.target.closest('.tab-link')) {
                    e.preventDefault();
                    const tabLink = e.target.classList.contains('tab-link') ? e.target : e.target.closest('.tab-link');
                    const targetId = tabLink.getAttribute('href');
                    
                    if (targetId && targetId.startsWith('#')) {
                        // Find the tab container (either closest .tab-container or parent element)
                        const tabContainer = tabLink.closest('.tab-container') || tabLink.closest('[class*="tab"]') || document;
                        
                        // Remove active class from all tabs in the same nav container
                        const navContainer = tabLink.closest('nav');
                        if (navContainer) {
                            navContainer.querySelectorAll('.tab-link').forEach(tab => {
                                tab.classList.remove('active-tab');
                                tab.classList.add('border-transparent', 'text-gray-500');
                                // Ensure border-b-2 class is managed properly
                                if (!tab.classList.contains('border-b-2')) {
                                    tab.classList.add('border-b-2');
                                }
                            });
                            
                            // Add active class to clicked tab
                            tabLink.classList.add('active-tab');
                            tabLink.classList.remove('border-transparent', 'text-gray-500');
                            tabLink.classList.add('border-b-2');
                        }
                        
                        // Hide all tab contents in the same container
                        tabContainer.querySelectorAll('.tab-content').forEach(content => {
                            content.classList.add('hidden');
                        });
                        
                        // Show target tab content
                        const targetContent = tabContainer.querySelector(targetId);
                        if (targetContent) {
                            targetContent.classList.remove('hidden');
                        }
                    }
                }
            });


            // Handle admin order form submission separately
            document.addEventListener('submit', function(e) {
                if (e.target.id === 'admin-create-order-form') {
                    submitAdminOrder(e);
                    return;
                }
            });

            // Handle product category surcharge actions
            document.addEventListener('click', function(e) {
                // Add product type
                if (e.target.id === 'add-product-type-btn' || e.target.closest('#add-product-type-btn')) {
                    e.preventDefault();
                    openModal('add-product-type-modal');
                }
                
                // Add Japan surcharge
                if (e.target.id === 'add-japan-surcharge-btn' || e.target.closest('#add-japan-surcharge-btn')) {
                    e.preventDefault();
                    openModal('add-surcharge-modal');
                }
                
                // Add US surcharge
                if (e.target.id === 'add-us-surcharge-btn' || e.target.closest('#add-us-surcharge-btn')) {
                    e.preventDefault();
                    openModal('add-surcharge-modal');
                }
                
                // Edit surcharge
                if (e.target.classList.contains('edit-surcharge-btn')) {
                    e.preventDefault();
                    openModal('edit-surcharge-modal');
                }
                
                // Add custom fee
                if (e.target.id === 'add-custom-fee-btn' || e.target.closest('#add-custom-fee-btn')) {
                    e.preventDefault();
                    openModal('add-custom-fee-modal');
                }
                
                // Add insurance
                if (e.target.id === 'add-insurance-btn' || e.target.closest('#add-insurance-btn')) {
                    e.preventDefault();
                    openModal('add-insurance-modal');
                }

                // Add commission tier
                if (e.target.id === 'add-commission-tier-btn' || e.target.closest('#add-commission-tier-btn')) {
                    e.preventDefault();
                    openModal('add-commission-tier-modal');
                }
            });

            // Handle COD fee settings (only when product is in Vietnam warehouse)
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('set-cod-fee-btn')) {
                    e.preventDefault();
                    
                    const productStatus = e.target.getAttribute('data-status');
                    const productId = e.target.getAttribute('data-product-id');
                    
                    if (productStatus === 'arrived_vietnam') {
                        // Product has arrived in Vietnam warehouse, allow COD fee setting
                        openModal('set-cod-fee-modal');
                        document.getElementById('cod-product-id').textContent = productId;
                    } else {
                        // Product not in Vietnam warehouse yet
                        alert('Chỉ có thể thiết lập phí COD khi sản phẩm đã về kho Việt Nam');
                    }
                }

                // Handle view item detail 
                if (e.target.classList.contains('view-item-detail-btn')) {
                    e.preventDefault();
                    const row = e.target.closest('tr');
                    const productId = row.querySelector('td:first-child').textContent.trim();
                    const productName = row.querySelector('td:nth-child(2)').textContent.trim();
                    const status = row.querySelector('.rounded-full').textContent.trim();
                    
                    // Set modal content
                    document.getElementById('detail-product-id').textContent = productId;
                    document.getElementById('detail-product-name').textContent = productName;
                    document.getElementById('detail-product-status').textContent = status;
                    
                    // Show/hide COD button based on status
                    const codButton = document.getElementById('cod-fee-btn');
                    if (status === 'Về kho VN') {
                        codButton.style.display = 'inline-block';
                        codButton.setAttribute('data-status', 'arrived_vietnam');
                        codButton.setAttribute('data-product-id', productId);
                    } else {
                        codButton.style.display = 'none';
                    }
                    
                    openModal('product-detail-modal');
                }
            });
        });
    </script>

    <!-- Withdrawal Details Modal -->
    <div id="withdrawal-details-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto transform scale-95 mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Chi tiết Giao dịch Rút tiền</h3>
                    <button class="close-modal-btn text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                    <!-- Transaction Information -->
                    <div class="space-y-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-3 text-gray-700">Thông tin Giao dịch</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Mã yêu cầu:</span>
                                    <span id="modal-withdrawal-id" class="font-medium"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Khách hàng:</span>
                                    <span id="modal-customer" class="font-medium"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Số tiền:</span>
                                    <span id="modal-amount" class="font-medium text-red-600"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Trạng thái:</span>
                                    <span id="modal-status" class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full font-medium">Chờ xử lý</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bank Information -->
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-3 text-gray-700">Thông tin Tài khoản Nhận</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Ngân hàng:</span>
                                    <span id="modal-bank" class="font-medium"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Số tài khoản:</span>
                                    <span id="modal-account" class="font-mono font-medium"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Chủ tài khoản:</span>
                                    <span id="modal-account-name" class="font-medium"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded text-sm">
                                <i class="fas fa-check mr-2"></i>Xác nhận Chuyển tiền
                            </button>
                            <button class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded text-sm">
                                <i class="fas fa-times mr-2"></i>Từ chối
                            </button>
                        </div>
                    </div>
                    
                    <!-- QR Code Section -->
                    <div class="space-y-4">
                        <div class="bg-gray-50 p-4 rounded-lg text-center">
                            <h4 class="font-semibold mb-3 text-gray-700">Mã QR Chuyển khoản</h4>
                            <div class="flex justify-center mb-3">
                                <div class="w-40 h-40 sm:w-48 sm:h-48 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center">
                                    <canvas id="qr-canvas" width="192" height="192" class="max-w-full max-h-full"></canvas>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mb-2">Quét mã QR để chuyển khoản nhanh</p>
                            <button id="download-qr" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 text-sm rounded">
                                <i class="fas fa-download mr-1"></i>Tải xuống QR
                            </button>
                        </div>
                        
                        <!-- Transfer Instructions -->
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-2 text-gray-700">Hướng dẫn Chuyển khoản</h4>
                            <div class="text-xs text-gray-600 space-y-1">
                                <p><strong>1.</strong> Mở ứng dụng ngân hàng</p>
                                <p><strong>2.</strong> Chọn "Chuyển khoản" > "Quét mã QR"</p>
                                <p><strong>3.</strong> Quét mã QR hoặc nhập thông tin thủ công</p>
                                <p><strong>4.</strong> Kiểm tra thông tin và xác nhận chuyển</p>
                                <p><strong>5.</strong> Lưu lại biên lai để đối soát</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Type Modal -->
    <div id="add-product-type-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Thêm Loại sản phẩm mới</h3>
                    <button class="close-modal-btn text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tên loại sản phẩm</label>
                        <input type="text" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Ví dụ: Thiết bị y tế">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Icon</label>
                        <select class="w-full p-3 border border-gray-300 rounded-lg">
                            <option value="fas fa-laptop">💻 Laptop</option>
                            <option value="fas fa-tshirt">👕 Quần áo</option>
                            <option value="fas fa-palette">🎨 Mỹ phẩm</option>
                            <option value="fas fa-gamepad">🎮 Game</option>
                            <option value="fas fa-utensils">🍴 Đồ gia dụng</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mô tả</label>
                        <textarea class="w-full p-3 border border-gray-300 rounded-lg" rows="3" placeholder="Mô tả ngắn về loại sản phẩm"></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" class="close-modal-btn px-4 py-2 text-gray-500 border border-gray-300 rounded-lg hover:bg-gray-50">Hủy</button>
                        <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Thêm loại sản phẩm</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add/Edit Surcharge Modal -->
    <div id="add-surcharge-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg max-w-lg w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Thêm Phụ thu mới</h3>
                    <button class="close-modal-btn text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Quốc gia</label>
                        <select class="w-full p-3 border border-gray-300 rounded-lg">
                            <option value="japan">🇯🇵 Nhật Bản (Japan)</option>
                            <option value="us">🇺🇸 Hoa Kỳ (US)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Loại sản phẩm</label>
                        <select class="w-full p-3 border border-gray-300 rounded-lg">
                            <option value="electronics">Điện tử</option>
                            <option value="clothing">Quần áo</option>
                            <option value="cosmetics">Mỹ phẩm</option>
                            <option value="fashion">Thời trang</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Điều kiện giá</label>
                        <select id="price-condition" class="w-full p-3 border border-gray-300 rounded-lg">
                            <option value="gte">Lớn hơn hoặc bằng (≥)</option>
                            <option value="range">Khoảng (từ - đến)</option>
                            <option value="lt">Nhỏ hơn (<)</option>
                        </select>
                    </div>
                    
                    <div id="price-inputs" class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Từ giá</label>
                            <input type="number" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="0">
                        </div>
                        <div id="to-price-container" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Đến giá</label>
                            <input type="number" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="0">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phụ thu (%)</label>
                        <input type="number" step="0.1" min="0" max="100" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="5.0">
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" class="close-modal-btn px-4 py-2 text-gray-500 border border-gray-300 rounded-lg hover:bg-gray-50">Hủy</button>
                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Thêm phụ thu</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Surcharge Modal -->
    <div id="edit-surcharge-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg max-w-lg w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Chỉnh sửa Phụ thu</h3>
                    <button class="close-modal-btn text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Quốc gia</label>
                        <select class="w-full p-3 border border-gray-300 rounded-lg">
                            <option value="japan" selected>🇯🇵 Nhật Bản (Japan)</option>
                            <option value="us">🇺🇸 Hoa Kỳ (US)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Loại sản phẩm</label>
                        <select class="w-full p-3 border border-gray-300 rounded-lg">
                            <option value="electronics" selected>Điện tử</option>
                            <option value="clothing">Quần áo</option>
                            <option value="cosmetics">Mỹ phẩm</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Điều kiện giá</label>
                        <select class="w-full p-3 border border-gray-300 rounded-lg">
                            <option value="gte" selected>Lớn hơn hoặc bằng (≥)</option>
                            <option value="range">Khoảng (từ - đến)</option>
                            <option value="lt">Nhỏ hơn (<)</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Từ giá (JPY)</label>
                            <input type="number" value="50000" class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Đến giá (JPY)</label>
                            <input type="number" class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phụ thu (%)</label>
                        <input type="number" value="5" step="0.1" min="0" max="100" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" class="close-modal-btn px-4 py-2 text-gray-500 border border-gray-300 rounded-lg hover:bg-gray-50">Hủy</button>
                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Cập nhật</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Custom Fee Modal -->
    <div id="add-custom-fee-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg max-w-lg w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Thêm Cài đặt Phí riêng</h3>
                    <button class="close-modal-btn text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Loại phí</label>
                        <select id="fee-type" class="w-full p-3 border border-gray-300 rounded-lg">
                            <option value="purchase">Phí mua hộ</option>
                            <option value="payment">Phí thanh toán</option>
                            <option value="cancellation">Phí hủy đơn</option>
                            <option value="insurance">Bảo hiểm</option>
                        </select>
                    </div>
                    
                    <div id="purchase-fee-options" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phí theo % giá trị đơn hàng</label>
                            <input type="number" step="0.1" min="0" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="3.0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phí tối thiểu (VND)</label>
                            <input type="number" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="30000">
                        </div>
                    </div>
                    
                    <div id="payment-fee-options" class="space-y-4 hidden">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phí cố định (JPY)</label>
                            <input type="number" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="150">
                        </div>
                    </div>
                    
                    <div id="cancellation-fee-options" class="space-y-4 hidden">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phí cố định (VND)</label>
                            <input type="number" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="50000">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phí theo % giá trị đơn</label>
                            <input type="number" step="0.1" min="0" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="1.0">
                        </div>
                    </div>
                    
                    <div id="insurance-fee-options" class="space-y-4 hidden">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Gói bảo hiểm</label>
                            <select class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="basic">Bảo hiểm cơ bản (2%)</option>
                                <option value="comprehensive">Bảo hiểm toàn diện (5%)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phí bảo hiểm riêng (%)</label>
                            <input type="number" step="0.1" min="0" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="3.0">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ngày bắt đầu áp dụng</label>
                        <input type="date" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" class="close-modal-btn px-4 py-2 text-gray-500 border border-gray-300 rounded-lg hover:bg-gray-50">Hủy</button>
                        <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Thêm cài đặt</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Insurance Modal -->
    <div id="add-insurance-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg max-w-lg w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Thêm Gói bảo hiểm mới</h3>
                    <button class="close-modal-btn text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tên gói bảo hiểm</label>
                        <input type="text" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Ví dụ: Bảo hiểm VIP">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mô tả</label>
                        <textarea class="w-full p-3 border border-gray-300 rounded-lg" rows="3" placeholder="Mô tả chi tiết về phạm vi bảo hiểm"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phí bảo hiểm (%)</label>
                        <input type="number" step="0.1" min="0" max="100" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="2.5">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Giá trị tối đa bảo hiểm (VND)</label>
                        <input type="number" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="20000000">
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" class="close-modal-btn px-4 py-2 text-gray-500 border border-gray-300 rounded-lg hover:bg-gray-50">Hủy</button>
                        <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Thêm gói bảo hiểm</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Commission Tier Modal -->
    <div id="add-commission-tier-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg max-w-lg w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Thêm Mức hoa hồng mới</h3>
                    <button class="close-modal-btn text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Doanh thu từ (VND)</label>
                        <input type="number" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="200000001">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Doanh thu đến (VND)</label>
                        <input type="number" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="300000000">
                        <p class="text-sm text-gray-500 mt-1">Để trống nếu không giới hạn trên</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tỷ lệ hoa hồng (%)</label>
                        <input type="number" step="0.1" min="0" max="100" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="12.0">
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" class="close-modal-btn px-4 py-2 text-gray-500 border border-gray-300 rounded-lg hover:bg-gray-50">Hủy</button>
                        <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Thêm mức hoa hồng</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- COD Fee Setting Modal -->
    <div id="set-cod-fee-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 hidden z-60 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg max-w-lg w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Thiết lập Phí COD nội địa</h3>
                    <button class="close-modal-btn text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="bg-yellow-50 p-4 rounded-lg mb-4 border-l-4 border-yellow-400">
                    <p class="font-medium text-yellow-800 mb-2"><i class="fas fa-info-circle mr-2"></i>Lưu ý:</p>
                    <p class="text-yellow-700 text-sm">Phí COD chỉ được thiết lập sau khi sản phẩm <span id="cod-product-id" class="font-mono bg-yellow-200 px-1 rounded">S8T22</span> đã về kho Việt Nam và có hóa đơn thực tế từ đơn vị vận chuyển.</p>
                </div>
                
                <form class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Quốc gia xuất phát</label>
                        <select class="w-full p-3 border border-gray-300 rounded-lg" disabled>
                            <option>Nhật Bản (Japan)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phí vận chuyển COD thực tế</label>
                        <div class="flex">
                            <input type="number" class="flex-1 p-3 border border-gray-300 rounded-l-lg" placeholder="500">
                            <span class="bg-gray-100 px-3 py-3 border border-l-0 border-gray-300 rounded-r-lg text-gray-600">JPY</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Số hóa đơn/biên lai</label>
                        <input type="text" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Mã số hóa đơn từ đơn vị vận chuyển">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ghi chú</label>
                        <textarea class="w-full p-3 border border-gray-300 rounded-lg" rows="2" placeholder="Ghi chú thêm về phí COD này..."></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" class="close-modal-btn px-4 py-2 text-gray-500 border border-gray-300 rounded-lg hover:bg-gray-50">Hủy</button>
                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Lưu phí COD</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Product Detail Modal -->
    <div id="product-detail-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg max-w-2xl w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Chi tiết Sản phẩm</h3>
                    <button class="close-modal-btn text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Product Information -->
                    <div class="space-y-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-3 text-gray-700">Thông tin Sản phẩm</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Mã sản phẩm:</span>
                                    <span id="detail-product-id" class="font-mono font-medium">S8T22</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Tên sản phẩm:</span>
                                    <span id="detail-product-name" class="font-medium">loa bluetooth</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Trạng thái:</span>
                                    <span id="detail-product-status" class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full font-medium">Về kho VN</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Khách hàng:</span>
                                    <span class="font-medium">SC231</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Fee Information -->
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-3 text-gray-700">Chi phí & Phí dịch vụ</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Giá mua:</span>
                                    <span class="font-medium">65,000 JPY</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Phí mua hộ:</span>
                                    <span class="font-medium">195,000 VND (3%)</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Phí vận chuyển quốc tế:</span>
                                    <span class="font-medium">450,000 VND</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Phí COD nội địa:</span>
                                    <span class="font-medium text-orange-600">Chưa thiết lập</span>
                                </div>
                                <div class="border-t pt-2 flex justify-between font-bold">
                                    <span>Tổng chi phí:</span>
                                    <span class="text-blue-600">1,850,000 VND</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex flex-col gap-2">
                            <button id="cod-fee-btn" class="set-cod-fee-btn bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded text-sm" data-status="arrived_vietnam" data-product-id="S8T22">
                                <i class="fas fa-truck mr-2"></i>Thiết lập Phí COD nội địa
                            </button>
                            <button class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded text-sm">
                                <i class="fas fa-edit mr-2"></i>Chỉnh sửa thông tin
                            </button>
                        </div>
                    </div>
                    
                    <!-- Shipping Timeline -->
                    <div class="space-y-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-3 text-gray-700">Lịch trình Vận chuyển</h4>
                            <div class="space-y-3">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                                    <div class="text-sm">
                                        <div class="font-medium">Đã mua hàng</div>
                                        <div class="text-gray-500 text-xs">25/07/2025 10:30</div>
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                                    <div class="text-sm">
                                        <div class="font-medium">Đã về kho Japan</div>
                                        <div class="text-gray-500 text-xs">28/07/2025 14:20</div>
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                                    <div class="text-sm">
                                        <div class="font-medium">Đang vận chuyển quốc tế</div>
                                        <div class="text-gray-500 text-xs">30/07/2025 09:15</div>
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-blue-500 rounded-full mr-3"></div>
                                    <div class="text-sm">
                                        <div class="font-medium text-blue-600">Đã về kho Việt Nam</div>
                                        <div class="text-gray-500 text-xs">05/08/2025 16:45</div>
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-gray-300 rounded-full mr-3"></div>
                                    <div class="text-sm">
                                        <div class="font-medium text-gray-500">Giao hàng cho khách</div>
                                        <div class="text-gray-500 text-xs">Chờ xử lý</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- COD Fee Notice -->
                        <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-400">
                            <h4 class="font-semibold mb-2 text-yellow-800">Thông báo về Phí COD</h4>
                            <div class="text-yellow-700 text-sm space-y-1">
                                <p>✅ Sản phẩm đã về kho Việt Nam</p>
                                <p>⚠️ Cần thiết lập phí COD nội địa để hoàn tất tính toán chi phí</p>
                                <p>📋 Phí COD sẽ được tính dựa trên hóa đơn thực tế từ đơn vị vận chuyển</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Admin Order Creation Functions
        window.exchangeRate = 186; // JPY to VND
        
        // Customer data for search
        window.customerData = [
            { id: "SC244", name: "Nguyễn Văn A", phone: "0901234567", email: "nguyenvana@email.com" },
            { id: "SC231", name: "Trần Thị B", phone: "0901234568", email: "tranthib@email.com" },
            { id: "SC144", name: "Lê Văn C", phone: "0901234569", email: "levanc@email.com" },
            { id: "SC155", name: "Phạm Thị D", phone: "0901234570", email: "phamthid@email.com" },
            { id: "SC267", name: "Hoàng Văn E", phone: "0901234571", email: "hoangvane@email.com" },
            { id: "SC198", name: "Ngô Thị F", phone: "0901234572", email: "ngothif@email.com" },
            { id: "SC223", name: "Vũ Văn G", phone: "0901234573", email: "vuvang@email.com" },
            { id: "SC189", name: "Đỗ Thị H", phone: "0901234574", email: "dothih@email.com" },
            { id: "SC276", name: "Bùi Văn I", phone: "0901234575", email: "buivani@email.com" },
            { id: "SC134", name: "Lý Thị K", phone: "0901234576", email: "lythik@email.com" }
        ];
        
        function initCustomerSearch() {
            const searchInput = document.getElementById('customer-search');
            const dropdown = document.getElementById('customer-dropdown');
            const hiddenInput = document.getElementById('selected-customer-id');
            
            if (!searchInput || !dropdown) return;
            
            function showDropdown(customers) {
                if (customers.length === 0) {
                    dropdown.innerHTML = '<div class="p-3 text-gray-500">Không tìm thấy khách hàng</div>';
                } else {
                    dropdown.innerHTML = customers.map(customer => `
                        <div class="p-3 hover:bg-gray-50 cursor-pointer customer-option" data-customer-id="${customer.id}">
                            <div class="font-medium">${customer.id} - ${customer.name}</div>
                            <div class="text-sm text-gray-500">${customer.phone} • ${customer.email}</div>
                        </div>
                    `).join('');
                }
                dropdown.classList.remove('hidden');
            }
            
            function hideDropdown() {
                dropdown.classList.add('hidden');
            }
            
            function filterCustomers(query) {
                if (!query) return window.customerData.slice(0, 5);
                return window.customerData.filter(customer => 
                    customer.id.toLowerCase().includes(query.toLowerCase()) ||
                    customer.name.toLowerCase().includes(query.toLowerCase()) ||
                    customer.phone.includes(query) ||
                    customer.email.toLowerCase().includes(query.toLowerCase())
                ).slice(0, 10);
            }
            
            searchInput.addEventListener('input', function() {
                const query = this.value.trim();
                const filtered = filterCustomers(query);
                showDropdown(filtered);
            });
            
            searchInput.addEventListener('focus', function() {
                const query = this.value.trim();
                const filtered = filterCustomers(query);
                showDropdown(filtered);
            });
            
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('customer-option') || e.target.closest('.customer-option')) {
                    const option = e.target.classList.contains('customer-option') ? e.target : e.target.closest('.customer-option');
                    const customerId = option.dataset.customerId;
                    const customer = window.customerData.find(c => c.id === customerId);
                    
                    if (customer) {
                        searchInput.value = `${customer.id} - ${customer.name}`;
                        hiddenInput.value = customerId;
                        hideDropdown();
                    }
                } else if (!e.target.closest('#customer-search') && !e.target.closest('#customer-dropdown')) {
                    hideDropdown();
                }
            });
        }
        
        function openCreateOrderModal() {
            const modal = document.getElementById('admin-create-order-modal');
            if (modal) {
                modal.classList.remove('hidden');
                // Initialize fixed service fee and purchase method
                setTimeout(() => {
                    initCustomerSearch();
                    // Set default service fee
                    const serviceFeeYen = document.getElementById('service-fee-yen');
                    if (serviceFeeYen) serviceFeeYen.value = 500;
                    // Set default purchase method to direct
                    const directRadio = document.querySelector('input[name="purchase-method"][value="direct"]');
                    if (directRadio) directRadio.checked = true;
                    // Calculate initial service fee in VND
                    updateOrderSummary();
                }, 100);
            }
        }
        
        function closeCreateOrderModal() {
            const modal = document.getElementById('admin-create-order-modal');
            if (modal) {
                modal.classList.add('hidden');
                document.getElementById('admin-create-order-form').reset();
                updateOrderSummary();
            }
        }
        
        function updateOrderSummary() {
            const productPriceYen = parseFloat(document.getElementById('product-price-yen')?.value) || 0;
            const serviceFeeYen = 500; // Fixed service fee
            const depositAmount = parseFloat(document.getElementById('deposit-amount')?.value) || 0;
            
            const productPriceVnd = productPriceYen * window.exchangeRate;
            const serviceFeeVnd = serviceFeeYen * window.exchangeRate;
            const totalVnd = productPriceVnd + serviceFeeVnd;
            const remainingVnd = totalVnd - depositAmount;
            const depositPercentage = totalVnd > 0 ? ((depositAmount / totalVnd) * 100).toFixed(1) : 0;
            
            // Update VND fields
            if (document.getElementById('product-price-vnd')) {
                document.getElementById('product-price-vnd').value = productPriceVnd.toLocaleString('vi-VN') + ' ₫';
            }
            if (document.getElementById('service-fee-vnd')) {
                document.getElementById('service-fee-vnd').value = serviceFeeVnd.toLocaleString('vi-VN') + ' ₫';
            }
            if (document.getElementById('deposit-percentage')) {
                document.getElementById('deposit-percentage').value = depositPercentage + '%';
            }
            
            // Update summary
            if (document.getElementById('summary-product-price')) {
                document.getElementById('summary-product-price').textContent = productPriceVnd.toLocaleString('vi-VN') + ' ₫';
            }
            if (document.getElementById('summary-service-fee')) {
                document.getElementById('summary-service-fee').textContent = serviceFeeVnd.toLocaleString('vi-VN') + ' ₫';
            }
            if (document.getElementById('summary-total')) {
                document.getElementById('summary-total').textContent = totalVnd.toLocaleString('vi-VN') + ' ₫';
            }
            if (document.getElementById('summary-deposit')) {
                document.getElementById('summary-deposit').textContent = depositAmount.toLocaleString('vi-VN') + ' ₫';
            }
            if (document.getElementById('summary-remaining')) {
                document.getElementById('summary-remaining').textContent = remainingVnd.toLocaleString('vi-VN') + ' ₫';
            }
        }
        
        function generateOrderId() {
            const now = new Date();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const orderCount = Math.floor(Math.random() * 99) + 1; // Random number for demo
            return `#DH-${month}${day}-${orderCount}`;
        }
        
        function submitAdminOrder(event) {
            event.preventDefault();
            
            const formData = new FormData(document.getElementById('admin-create-order-form'));
            const selectedCustomerId = document.getElementById('selected-customer-id').value;
            const selectedCustomer = window.customerData.find(c => c.id === selectedCustomerId);
            
            if (!selectedCustomerId || !selectedCustomer) {
                alert('Vui lòng chọn khách hàng!');
                return;
            }
            
            const orderData = {
                productLink: document.getElementById('product-link').value,
                productName: document.getElementById('product-name').value,
                productCategory: document.getElementById('product-category').value,
                purchaseMethod: document.querySelector('input[name="purchase-method"]:checked')?.value,
                priceYen: parseFloat(document.getElementById('product-price-yen').value),
                serviceFeeYen: parseFloat(document.getElementById('service-fee-yen').value),
                customer: selectedCustomer,
                depositAmount: parseFloat(document.getElementById('deposit-amount').value),
                notes: document.getElementById('order-notes').value,
                createdAt: new Date().toISOString(),
                status: 'pending-confirmation',
                orderId: generateOrderId()
            };
            
            console.log('Order created by admin:', orderData);
            alert('Đơn hàng đã được tạo và gửi đến khách hàng để xác nhận!');
            closeCreateOrderModal();
        }

        // Handle dynamic form options in modals
        document.addEventListener('change', function(e) {
            // Handle admin order form field changes (service fee is now fixed and disabled)
            if (e.target.id === 'product-price-yen' || e.target.id === 'deposit-amount') {
                updateOrderSummary();
            }
            
            // Handle price condition change in surcharge modal
            if (e.target.id === 'price-condition') {
                const toPriceContainer = document.getElementById('to-price-container');
                if (e.target.value === 'range') {
                    toPriceContainer.classList.remove('hidden');
                } else {
                    toPriceContainer.classList.add('hidden');
                }
            }
            
            // Handle fee type change in custom fee modal
            if (e.target.id === 'fee-type') {
                const purchaseOptions = document.getElementById('purchase-fee-options');
                const paymentOptions = document.getElementById('payment-fee-options');
                const cancellationOptions = document.getElementById('cancellation-fee-options');
                const insuranceOptions = document.getElementById('insurance-fee-options');
                
                // Hide all options
                [purchaseOptions, paymentOptions, cancellationOptions, insuranceOptions].forEach(el => {
                    el.classList.add('hidden');
                });
                
                // Show relevant option
                switch(e.target.value) {
                    case 'purchase':
                        purchaseOptions.classList.remove('hidden');
                        break;
                    case 'payment':
                        paymentOptions.classList.remove('hidden');
                        break;
                    case 'cancellation':
                        cancellationOptions.classList.remove('hidden');
                        break;
                    case 'insurance':
                        insuranceOptions.classList.remove('hidden');
                        break;
                }
            }
        });


        // Sales Salary HTML Content
        function getSalesSalaryHTML() {
            return `
                <!-- Header -->
                <div class="bg-white rounded-lg shadow-md mb-6">
                    <div class="p-6 border-b border-gray-200">
                        <h1 class="text-2xl font-bold text-gray-800">QUẢN LÝ TÍNH LƯƠNG BỘ PHẬN SALE STREAMCARGO</h1>
                        <p class="text-gray-600 mt-2">Hệ thống tính toán lương và hoa hồng dựa trên doanh số bán hàng</p>
                        
                        <!-- Key Metrics -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-money-bill-wave text-blue-600 text-2xl mr-3"></i>
                                    <div>
                                        <p class="text-sm text-gray-600">Lương cơ bản</p>
                                        <p class="text-xl font-bold text-blue-600">6,700,000 ₫</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-exchange-alt text-green-600 text-2xl mr-3"></i>
                                    <div>
                                        <p class="text-sm text-gray-600">Tỷ giá bình quân</p>
                                        <p class="text-xl font-bold text-green-600">186 ₫/¥</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-weight text-purple-600 text-2xl mr-3"></i>
                                    <div>
                                        <p class="text-sm text-gray-600">Lợi nhuận/kg</p>
                                        <p class="text-xl font-bold text-purple-600">9,000 ₫</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-orange-50 p-4 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-percentage text-orange-600 text-2xl mr-3"></i>
                                    <div>
                                        <p class="text-sm text-gray-600">Hoa hồng tối đa</p>
                                        <p class="text-xl font-bold text-orange-600">20%</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left Column - Commission Structure -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-lg shadow-md">
                            <div class="p-6">
                                <h3 class="text-xl font-semibold text-gray-800 mb-4">
                                    <i class="fas fa-chart-line mr-2"></i>Bảng Tính Lương Theo Cấp Bậc
                                </h3>
                                
                                <div class="overflow-x-auto">
                                    <table class="min-w-full text-sm">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="p-3 text-left font-semibold">Cấp bậc</th>
                                                <th class="p-3 text-center font-semibold">Doanh số tối thiểu (¥)</th>
                                                <th class="p-3 text-center font-semibold">Doanh số VND</th>
                                                <th class="p-3 text-center font-semibold">Chỉ số tính lương</th>
                                                <th class="p-3 text-center font-semibold">% Hoa hồng</th>
                                                <th class="p-3 text-center font-semibold">Phí dịch vụ</th>
                                                <th class="p-3 text-center font-semibold">Phí vận chuyển/kg</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-200">
                                            <tr>
                                                <td class="p-3 font-medium text-gray-600">SALE Mới</td>
                                                <td class="p-3 text-center">100</td>
                                                <td class="p-3 text-center font-semibold">18,600 ₫</td>
                                                <td class="p-3 text-center">2%</td>
                                                <td class="p-3 text-center"><span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs">0%</span></td>
                                                <td class="p-3 text-center">300 ₫</td>
                                                <td class="p-3 text-center">Không có</td>
                                            </tr>
                                            <tr class="bg-blue-50">
                                                <td class="p-3 font-medium text-blue-800">SALE Level 1</td>
                                                <td class="p-3 text-center font-bold">200</td>
                                                <td class="p-3 text-center font-semibold text-blue-600">938,000 ₫</td>
                                                <td class="p-3 text-center">50%</td>
                                                <td class="p-3 text-center"><span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full font-semibold">14%</span></td>
                                                <td class="p-3 text-center">350 ₫</td>
                                                <td class="p-3 text-center">1,260 ₫</td>
                                            </tr>
                                            <tr class="bg-green-50">
                                                <td class="p-3 font-medium text-green-800">SALE Level 2</td>
                                                <td class="p-3 text-center font-bold">300</td>
                                                <td class="p-3 text-center font-semibold text-green-600">1,072,000 ₫</td>
                                                <td class="p-3 text-center">50%</td>
                                                <td class="p-3 text-center"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full font-semibold">16%</span></td>
                                                <td class="p-3 text-center">500 ₫</td>
                                                <td class="p-3 text-center">1,440 ₫</td>
                                            </tr>
                                            <tr class="bg-purple-50">
                                                <td class="p-3 font-medium text-purple-800">SALE Level 3</td>
                                                <td class="p-3 text-center font-bold">400</td>
                                                <td class="p-3 text-center font-semibold text-purple-600">1,206,000 ₫</td>
                                                <td class="p-3 text-center">50%</td>
                                                <td class="p-3 text-center"><span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full font-semibold">18%</span></td>
                                                <td class="p-3 text-center">650 ₫</td>
                                                <td class="p-3 text-center">1,620 ₫</td>
                                            </tr>
                                            <tr class="bg-orange-50">
                                                <td class="p-3 font-medium text-orange-800">SALE Level 4</td>
                                                <td class="p-3 text-center font-bold">500</td>
                                                <td class="p-3 text-center font-semibold text-orange-600">1,340,000 ₫</td>
                                                <td class="p-3 text-center">50%</td>
                                                <td class="p-3 text-center"><span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full font-semibold">20%</span></td>
                                                <td class="p-3 text-center">800 ₫</td>
                                                <td class="p-3 text-center">1,800 ₫</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Sales Performance Tracking -->
                        <div class="bg-white rounded-lg shadow-md mt-6">
                            <div class="p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-semibold text-gray-800">
                                        <i class="fas fa-users mr-2"></i>Theo dõi Hiệu suất Sale
                                    </h3>
                                    <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                                        <i class="fas fa-plus mr-2"></i>Thêm Sale
                                    </button>
                                </div>

                                <div class="overflow-x-auto">
                                    <table class="min-w-full text-sm">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="p-3 text-left font-semibold">Tên Sale</th>
                                                <th class="p-3 text-center font-semibold">Doanh số tháng (¥)</th>
                                                <th class="p-3 text-center font-semibold">Cấp bậc</th>
                                                <th class="p-3 text-center font-semibold">Hoa hồng ước tính</th>
                                                <th class="p-3 text-center font-semibold">Tổng lương</th>
                                                <th class="p-3 text-center font-semibold">Hành động</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-200">
                                            <tr>
                                                <td class="p-3">
                                                    <div class="flex items-center">
                                                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-semibold mr-3">PL</div>
                                                        <div>
                                                            <p class="font-semibold">Phương Linh</p>
                                                            <p class="text-xs text-gray-500">ID: SALE001</p>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="p-3 text-center font-semibold text-green-600">2,350</td>
                                                <td class="p-3 text-center">
                                                    <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-semibold">Level 4</span>
                                                </td>
                                                <td class="p-3 text-center font-semibold text-green-600">87,437,084 ₫</td>
                                                <td class="p-3 text-center font-bold text-blue-600">94,137,084 ₫</td>
                                                <td class="p-3 text-center">
                                                    <button onclick="loadSalesDetailContent()" class="text-blue-600 hover:underline text-xs mr-2">Chi tiết</button>
                                                    <button onclick="calculateSalaryForPhuongLinh()" class="text-green-600 hover:underline text-xs">Tính lương</button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Calculator & Statistics -->
                    <div class="space-y-6">
                        <!-- Salary Calculator -->
                        <div class="bg-white rounded-lg shadow-md">
                            <div class="p-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                                    <i class="fas fa-calculator mr-2"></i>Máy tính Lương
                                </h3>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Doanh số tháng (¥)</label>
                                        <input type="number" id="sales-input" class="w-full p-3 border rounded-lg" placeholder="Nhập doanh số..." value="0">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tổng lợi nhuận (VND)</label>
                                        <input type="number" id="profit-input" class="w-full p-3 border rounded-lg" placeholder="Nhập lợi nhuận..." value="0">
                                    </div>
                                    
                                    <button onclick="calculateSalaryInIndex()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-semibold">
                                        <i class="fas fa-calculator mr-2"></i>Tính Lương
                                    </button>
                                    
                                    <div id="calculation-result" class="bg-gray-50 p-4 rounded-lg">
                                        <h4 class="font-semibold text-gray-800 mb-3">Kết quả tính toán:</h4>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex justify-between">
                                                <span>Cấp bậc:</span>
                                                <span id="result-level" class="font-semibold">-</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Lương cơ bản:</span>
                                                <span id="result-base" class="font-semibold">6,700,000 ₫</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Hoa hồng:</span>
                                                <span id="result-commission" class="font-semibold text-green-600">0 ₫</span>
                                            </div>
                                            <div class="flex justify-between border-t pt-2">
                                                <span class="font-semibold">Tổng lương:</span>
                                                <span id="result-total" class="font-bold text-blue-600">6,700,000 ₫</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Monthly Statistics -->
                        <div class="bg-white rounded-lg shadow-md">
                            <div class="p-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                                    <i class="fas fa-chart-bar mr-2"></i>Thống kê tháng này
                                </h3>
                                
                                <div class="space-y-4">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-sm text-gray-600">Tổng doanh số</p>
                                                <p class="text-2xl font-bold text-blue-600">2,350¥</p>
                                            </div>
                                            <i class="fas fa-yen-sign text-3xl text-blue-400"></i>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-green-50 p-4 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-sm text-gray-600">Tổng tiền lương</p>
                                                <p class="text-2xl font-bold text-green-600">94,137,084 ₫</p>
                                            </div>
                                            <i class="fas fa-money-bill-wave text-3xl text-green-400"></i>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-purple-50 p-4 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-sm text-gray-600">Số Sale hoạt động</p>
                                                <p class="text-2xl font-bold text-purple-600">1</p>
                                            </div>
                                            <i class="fas fa-users text-3xl text-purple-400"></i>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-orange-50 p-4 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <p class="text-sm text-gray-600">Sale đạt KPI</p>
                                                <p class="text-2xl font-bold text-orange-600">1/1</p>
                                            </div>
                                            <i class="fas fa-target text-3xl text-orange-400"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize sales salary page functionality
        function initSalesSalaryPage() {
            // Commission structure
            const commissionStructure = [
                { level: 'Chưa đạt', minSales: 0, maxSales: 199, commission: 0, baseSalary: 6700000 },
                { level: 'Level 1', minSales: 200, maxSales: 299, commission: 0.14, baseSalary: 6700000 },
                { level: 'Level 2', minSales: 300, maxSales: 399, commission: 0.16, baseSalary: 6700000 },
                { level: 'Level 3', minSales: 400, maxSales: 499, commission: 0.18, baseSalary: 6700000 },
                { level: 'Level 4', minSales: 500, maxSales: Infinity, commission: 0.20, baseSalary: 6700000 }
            ];

            window.calculateSalaryInIndex = function() {
                const salesYen = parseFloat(document.getElementById('sales-input').value) || 0;
                const totalProfit = parseFloat(document.getElementById('profit-input').value) || 0;
                
                const level = commissionStructure.find(tier => salesYen >= tier.minSales && salesYen <= tier.maxSales);
                
                if (level) {
                    const commission = totalProfit * level.commission;
                    const totalSalary = level.baseSalary + commission;
                    
                    document.getElementById('result-level').textContent = level.level;
                    document.getElementById('result-base').textContent = level.baseSalary.toLocaleString('vi-VN') + ' ₫';
                    document.getElementById('result-commission').textContent = commission.toLocaleString('vi-VN') + ' ₫';
                    document.getElementById('result-total').textContent = totalSalary.toLocaleString('vi-VN') + ' ₫';
                }
            };

            window.calculateSalaryForPhuongLinh = function() {
                alert('Chi tiết lương cho Phương Linh:\\n' +
                      'Lương cơ bản: 6,700,000 ₫\\n' +
                      'Tổng lợi nhuận: 437,185,422 ₫\\n' +
                      'Hoa hồng (20%): 87,437,084 ₫\\n' +
                      'Tổng lương: 94,137,084 ₫');
            };

            // Auto-calculate when input changes
            document.getElementById('sales-input').addEventListener('input', window.calculateSalaryInIndex);
            document.getElementById('profit-input').addEventListener('input', window.calculateSalaryInIndex);
            
            window.calculateDetailSalaryInIndex = function(saleId) {
                const saleData = {
                    'SALE001': { totalProfit: 437185422, salesYen: 2350445 },
                    'SALE002': { totalProfit: 200000000, salesYen: 1200000 },
                    'SALE003': { totalProfit: 0, salesYen: 180 }
                };
                
                const data = saleData[saleId];
                if (!data) return;
                
                const exchangeRate = 186;
                const salesVND = data.salesYen * exchangeRate;
                const level = commissionStructure.find(tier => data.salesYen >= tier.minSales && data.salesYen <= tier.maxSales);
                
                if (level) {
                    const commission = data.totalProfit * level.commission;
                    const totalSalary = level.baseSalary + commission;
                    
                    alert(`Chi tiết lương cho ${saleId}:\n` +
                          `Lương cơ bản: ${level.baseSalary.toLocaleString('vi-VN')} ₫\n` +
                          `Tổng lợi nhuận: ${data.totalProfit.toLocaleString('vi-VN')} ₫\n` +
                          `Hoa hồng (${(level.commission*100).toFixed(0)}%): ${commission.toLocaleString('vi-VN')} ₫\n` +
                          `Tổng lương: ${totalSalary.toLocaleString('vi-VN')} ₫`);
                }
            };
            
            // Add event listener for the detail button
            const detailButton = document.querySelector('button[onclick="loadSalesDetailContent()"]');
            if (detailButton) {
                detailButton.onclick = function(e) {
                    e.preventDefault();
                    loadSalesDetailContent();
                };
            }
        }

        // Sales Detail HTML Content  
        function getSalesDetailHTML() {
            return `
                <!-- Header -->
                <div class="bg-white rounded-lg shadow-md mb-6">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-2xl font-bold text-gray-800">Chi tiết Doanh số - PHƯƠNG LINH</h1>
                                <p class="text-gray-600 mt-1">Báo cáo chi tiết theo từng khách hàng và lợi nhuận</p>
                                
                                <div class="mt-3">
                                    <select id="sale-selector" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        <option value="PHUONG_LINH">PHƯƠNG LINH</option>
                                        <option value="NGUYEN_VAN_A">NGUYỄN VĂN A</option>
                                        <option value="TRAN_THI_B">TRẦN THỊ B</option>
                                    </select>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-500">Tháng hiện tại</p>
                                <p class="text-2xl font-bold text-blue-600">₫437,185,422</p>
                                <p class="text-sm text-gray-500 mt-1">Hoa hồng 20%: ₫87,437,084</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex items-center">
                            <div class="p-3 bg-blue-100 rounded-full">
                                <i class="fas fa-users text-blue-600 text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">Tổng khách hàng</p>
                                <p class="text-2xl font-bold text-gray-800">34</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex items-center">
                            <div class="p-3 bg-green-100 rounded-full">
                                <i class="fas fa-weight text-green-600 text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">Tổng KG</p>
                                <p class="text-2xl font-bold text-gray-800">298.7</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex items-center">
                            <div class="p-3 bg-yellow-100 rounded-full">
                                <i class="fas fa-yen-sign text-yellow-600 text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">Tổng doanh thu (¥)</p>
                                <p class="text-2xl font-bold text-gray-800">¥2,350,445</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex items-center">
                            <div class="p-3 bg-purple-100 rounded-full">
                                <i class="fas fa-chart-line text-purple-600 text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">Hoa hồng ước tính</p>
                                <p class="text-2xl font-bold text-green-600">₫87,437,086</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Sales Table -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold text-gray-800">
                                <i class="fas fa-table mr-2"></i>Chi tiết Doanh số theo Khách hàng
                            </h3>
                            <div class="flex space-x-2">
                                <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">
                                    <i class="fas fa-file-excel mr-2"></i>Xuất Excel
                                </button>
                                <button onclick="loadSalesSalaryContent()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                                    <i class="fas fa-calculator mr-2"></i>Tính lương
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-3 text-left font-semibold sticky left-0 bg-gray-100">Mã KH</th>
                                        <th class="p-3 text-center font-semibold">KG</th>
                                        <th class="p-3 text-center font-semibold">Phí DV (¥)</th>
                                        <th class="p-3 text-center font-semibold">Tổng TT (¥)</th>
                                        <th class="p-3 text-right font-semibold">Lợi nhuận VC</th>
                                        <th class="p-3 text-right font-semibold">Lợi nhuận Phí TT</th>
                                        <th class="p-3 text-right font-semibold">Lợi nhuận Tỷ giá</th>
                                        <th class="p-3 text-right font-semibold bg-yellow-50">Total</th>
                                        <th class="p-3 text-center font-semibold">Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody id="sales-detail-tbody" class="divide-y divide-gray-200">
                                    <tr><td colspan="9" class="p-4 text-center text-gray-500">Đang tải dữ liệu...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div class="text-center">
                                    <p class="text-gray-600">Tổng KG:</p>
                                    <p class="text-xl font-bold text-blue-600">298.7</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-gray-600">Tổng Phí DV:</p>
                                    <p class="text-xl font-bold text-green-600">¥35,905</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-gray-600">Tổng Thanh toán:</p>
                                    <p class="text-xl font-bold text-purple-600">¥2,350,445</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-gray-600">Tổng Lợi nhuận:</p>
                                    <p class="text-2xl font-bold text-red-600">₫437,185,422</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize sales detail page functionality
        function initSalesDetailPage() {
            // Sample data for the table
            const sampleData = [
                { code: "SC241", kg: 34.6, serviceFee: 7928, totalPayment: 264271, profitVC: 775720, profitFee: 1501846, profitRate: 3635586, total: 57910166, status: "active" },
                { code: "SC293", kg: 33.5, serviceFee: 6801, totalPayment: 226696, profitVC: 737000, profitFee: 1275710, profitRate: 2212858, total: 49829372, status: "active" },
                { code: "SC256", kg: 25.6, serviceFee: 3746, totalPayment: 124859, profitVC: 563200, profitFee: 707067, profitRate: 1481684, total: 28983958, status: "active" },
                { code: "SC229", kg: 33.9, serviceFee: 2018, totalPayment: 97308, profitVC: 237300, profitFee: 378218, profitRate: 1287058, total: 24211284, status: "active" },
                { code: "SC99", kg: 0.9, serviceFee: 3790, totalPayment: 126341, profitVC: 19800, profitFee: 716128, profitRate: 1014508, total: 24749066, status: "active" }
            ];

            function formatCurrency(amount, currency = 'VND') {
                if (currency === 'VND') {
                    return amount.toLocaleString('vi-VN') + ' ₫';
                } else if (currency === 'JPY') {
                    return '¥' + amount.toLocaleString('vi-VN');
                }
                return amount.toLocaleString('vi-VN');
            }

            function getStatusBadge(status) {
                if (status === 'active') {
                    return '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">Hoạt động</span>';
                }
                return '<span class="px-2 py-1 bg-gray-200 text-gray-800 rounded-full text-xs font-medium">Không hoạt động</span>';
            }

            const tbody = document.getElementById('sales-detail-tbody');
            tbody.innerHTML = sampleData.map(item => `
                <tr class="hover:bg-gray-50">
                    <td class="p-3 font-semibold sticky left-0 bg-white">${item.code}</td>
                    <td class="p-3 text-center">${item.kg}</td>
                    <td class="p-3 text-center">${formatCurrency(item.serviceFee, 'JPY')}</td>
                    <td class="p-3 text-center">${formatCurrency(item.totalPayment, 'JPY')}</td>
                    <td class="p-3 text-right">${formatCurrency(item.profitVC)}</td>
                    <td class="p-3 text-right">${formatCurrency(item.profitFee)}</td>
                    <td class="p-3 text-right">${formatCurrency(item.profitRate)}</td>
                    <td class="p-3 text-right font-bold text-green-600 bg-yellow-50">${formatCurrency(item.total)}</td>
                    <td class="p-3 text-center">${getStatusBadge(item.status)}</td>
                </tr>
            `).join('');
        }


        // JavaScript from _sales-salary.html moved to index.html
        const commissionStructure = [
            { level: 'Chưa đạt', minSales: 0, maxSales: 199, commission: 0, baseSalary: 6700000, serviceFee: 300, shippingFee: 0, color: 'red' },
            { level: 'Level 1', minSales: 200, maxSales: 299, commission: 0.14, baseSalary: 6700000, serviceFee: 350, shippingFee: 1260, color: 'blue' },
            { level: 'Level 2', minSales: 300, maxSales: 399, commission: 0.16, baseSalary: 6700000, serviceFee: 500, shippingFee: 1440, color: 'green' },
            { level: 'Level 3', minSales: 400, maxSales: 499, commission: 0.18, baseSalary: 6700000, serviceFee: 650, shippingFee: 1620, color: 'purple' },
            { level: 'Level 4', minSales: 500, maxSales: Infinity, commission: 0.20, baseSalary: 6700000, serviceFee: 800, shippingFee: 1800, color: 'orange' }
        ];
        const exchangeRate = 186;
        const profitPerKg = 9000;

        window.calculateSalaryFromPage = function() {
            const salesYen = parseFloat(document.getElementById('sales-input').value) || 0;
            const level = commissionStructure.find(tier => salesYen >= tier.minSales && salesYen <= tier.maxSales);
            
            if (!level) {
                alert('Không tìm thấy cấp bậc phù hợp');
                return;
            }
            
            const salesVND = salesYen * exchangeRate;
            const commission = salesVND * level.commission;
            const totalSalary = level.baseSalary + commission;
            
            document.getElementById('result-level').textContent = level.level;
            document.getElementById('result-base').textContent = level.baseSalary.toLocaleString('vi-VN') + ' ₫';
            document.getElementById('result-commission').textContent = commission.toLocaleString('vi-VN') + ' ₫';
            document.getElementById('result-total').textContent = totalSalary.toLocaleString('vi-VN') + ' ₫';
        };

        window.initSalaryChart = function() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Nguyễn Văn A', 'Trần Thị B', 'Lê Văn C'],
                    datasets: [{
                        label: 'Doanh số (¥)',
                        data: [850, 420, 180],
                        backgroundColor: [
                            'rgba(249, 115, 22, 0.8)',
                            'rgba(147, 51, 234, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderColor: [
                            'rgba(249, 115, 22, 1)',
                            'rgba(147, 51, 234, 1)',
                            'rgba(239, 68, 68, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Doanh số (¥)' }
                        }
                    }
                }
            });
        };

        // JavaScript from _sales-detail.html moved to index.html
        const salesDetailData = [
            { code: "SC247", kg: 0, serviceFee: 0, totalPayment: 0, profitVC: 0, profitFee: 0, profitRate: 0, total: 0, status: "inactive" },
            { code: "SC208", kg: 0, serviceFee: 0, totalPayment: 0, profitVC: 0, profitFee: 0, profitRate: 0, total: 0, status: "inactive" },
            { code: "SC191", kg: 2.4, serviceFee: 2333, totalPayment: 77760, profitVC: 52800, profitFee: 438659, profitRate: 657228, total: 15492624, status: "active" },
            { code: "SC231", kg: 55.5, serviceFee: 1003, totalPayment: 33420, profitVC: 4400, profitFee: 188489, profitRate: 703048, total: 10931449, status: "active" },
            { code: "SC168", kg: 3.3, serviceFee: 0, totalPayment: 594025, profitVC: 72600, profitFee: 0, profitRate: 7070272, total: 111021778, status: "vip" }
        ];

        window.formatCurrencyInDetail = function(amount, currency = 'VND') {
            if (currency === 'VND') {
                return amount.toLocaleString('vi-VN') + ' ₫';
            } else if (currency === 'JPY') {
                return '¥' + amount.toLocaleString('vi-VN');
            }
            return amount.toLocaleString('vi-VN');
        };

        window.getStatusBadgeInDetail = function(status) {
            const statusConfig = {
                'inactive': { class: 'bg-gray-200 text-gray-800', text: 'Không hoạt động' },
                'active': { class: 'bg-green-100 text-green-800', text: 'Hoạt động' },
                'vip': { class: 'bg-purple-100 text-purple-800', text: 'VIP' }
            };
            const config = statusConfig[status] || statusConfig.inactive;
            return `<span class="px-2 py-1 ${config.class} rounded-full text-xs font-medium">${config.text}</span>`;
        };

        window.populateDetailTable = function() {
            const tbody = document.getElementById('sales-tbody');
            if (!tbody) return;
            tbody.innerHTML = salesDetailData.map(item => `
                <tr class="${item.status === 'inactive' ? 'bg-gray-50 opacity-60' : 'hover:bg-gray-50'}">
                    <td class="p-3 font-semibold sticky left-0 ${item.status === 'inactive' ? 'bg-gray-50' : 'bg-white'}">${item.code}</td>
                    <td class="p-3 text-center">${item.kg}</td>
                    <td class="p-3 text-center">${window.formatCurrencyInDetail(item.serviceFee, 'JPY')}</td>
                    <td class="p-3 text-center">${window.formatCurrencyInDetail(item.totalPayment, 'JPY')}</td>
                    <td class="p-3 text-right">${window.formatCurrencyInDetail(item.profitVC)}</td>
                    <td class="p-3 text-right">${window.formatCurrencyInDetail(item.profitFee)}</td>
                    <td class="p-3 text-right">${window.formatCurrencyInDetail(item.profitRate)}</td>
                    <td class="p-3 text-right font-bold ${item.total > 0 ? 'text-green-600' : 'text-gray-400'} bg-yellow-50">${window.formatCurrencyInDetail(item.total)}</td>
                    <td class="p-3 text-center">${window.getStatusBadgeInDetail(item.status)}</td>
                </tr>
            `).join('');
        };

        window.initDetailCharts = function() {
            const profitCtx = document.getElementById('profitChart');
            if (!profitCtx) return;
            
            const totalProfitVC = salesDetailData.reduce((sum, item) => sum + item.profitVC, 0);
            const totalProfitFee = salesDetailData.reduce((sum, item) => sum + item.profitFee, 0);
            const totalProfitRate = salesDetailData.reduce((sum, item) => sum + item.profitRate, 0);
            
            new Chart(profitCtx.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: ['Lợi nhuận VC', 'Lợi nhuận Phí TT', 'Lợi nhuận Tỷ giá'],
                    datasets: [{
                        data: [totalProfitVC, totalProfitFee, totalProfitRate],
                        backgroundColor: ['#3B82F6', '#10B981', '#F59E0B'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        };

        // Bank History Modal Functionality
        window.initBankHistoryModal = function() {
            console.log('initBankHistoryModal called');
            
            const bankHistoryModal = document.getElementById('bank-history-modal');
            const closeBankHistoryModal = document.getElementById('close-bank-history-modal');
            
            console.log('Modal elements:', {bankHistoryModal: !!bankHistoryModal, closeBankHistoryModal: !!closeBankHistoryModal});
            
            if (!bankHistoryModal || !closeBankHistoryModal) {
                console.log('Modal elements not found, exiting');
                return;
            }
            
            // Mock transaction data for demonstration
            const mockBankTransactions = {
                'Vietcombank-0123456789': [
                    {
                        date: '2025-08-05',
                        time: '14:20:00',
                        transactionId: 'VCB240805001',
                        type: 'deposit',
                        customer: 'Nguyễn Văn A (KH001)',
                        amount: 5000000,
                        content: 'N-0805-1 Nap tien',
                        status: 'completed',
                        processor: 'Auto System'
                    },
                    {
                        date: '2025-08-05',
                        time: '11:35:00',
                        transactionId: 'VCB240805002',
                        type: 'deposit',
                        customer: 'Trần Thị B (KH002)',
                        amount: 10000000,
                        content: 'N-0805-2 Nap tien',
                        status: 'completed',
                        processor: 'Admin'
                    },
                    {
                        date: '2025-08-04',
                        time: '16:05:00',
                        transactionId: 'VCB240804001',
                        type: 'withdrawal',
                        customer: 'Phạm Thị D (KH005)',
                        amount: -1000000,
                        content: 'R-0804-5 Rut tien',
                        status: 'completed',
                        processor: 'Admin'
                    },
                    {
                        date: '2025-08-03',
                        time: '09:30:00',
                        transactionId: 'VCB240803001',
                        type: 'deposit',
                        customer: 'Lê Văn C (KH004)',
                        amount: 3500000,
                        content: 'N-0803-3 Nap tien',
                        status: 'completed',
                        processor: 'ketoan.1'
                    },
                    {
                        date: '2025-08-02',
                        time: '16:20:00',
                        transactionId: 'VCB240802001',
                        type: 'deposit',
                        customer: 'Lê Văn C (KH004)',
                        amount: 3500000,
                        content: 'Manual deposit - ref: FT24080112345',
                        status: 'completed',
                        processor: 'Admin'
                    }
                ],
                'Techcombank-9876543210': [
                    {
                        date: '2025-08-01',
                        time: '10:15:00',
                        transactionId: 'TCB240801001',
                        type: 'deposit',
                        customer: 'Hoàng Văn E (KH006)',
                        amount: 2000000,
                        content: 'N-0801-1 Nap tien',
                        status: 'completed',
                        processor: 'Auto System'
                    },
                    {
                        date: '2025-07-31',
                        time: '14:45:00',
                        transactionId: 'TCB240731001',
                        type: 'withdrawal',
                        customer: 'Nguyễn Văn A (KH001)',
                        amount: -1500000,
                        content: 'R-0731-2 Rut tien',
                        status: 'completed',
                        processor: 'ketoan.1'
                    }
                ]
            };

            // Format currency for bank history
            function formatCurrencyBankHistory(amount) {
                return Math.abs(amount).toLocaleString('vi-VN') + ' ₫';
            }

            // Get transaction type badge
            function getTransactionTypeBadge(type, amount) {
                if (type === 'deposit' || amount > 0) {
                    return '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium"><i class="fas fa-arrow-down mr-1"></i>Nạp tiền</span>';
                } else {
                    return '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full font-medium"><i class="fas fa-arrow-up mr-1"></i>Rút tiền</span>';
                }
            }

            // Get status badge
            function getStatusBadgeBankHistory(status) {
                const badges = {
                    'completed': '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium">Thành công</span>',
                    'pending': '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full font-medium">Đang xử lý</span>',
                    'failed': '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full font-medium">Thất bại</span>'
                };
                return badges[status] || badges['completed'];
            }

            // Show bank history modal
            function showBankHistoryModal(bankName, accountNumber, accountHolder) {
                console.log('Showing modal for:', bankName, accountNumber, accountHolder);
                
                const bankNameEl = document.getElementById('bank-name');
                const accountNumberEl = document.getElementById('account-number');
                const accountHolderEl = document.getElementById('account-holder');
                
                if (bankNameEl) bankNameEl.textContent = bankName;
                if (accountNumberEl) accountNumberEl.textContent = accountNumber;
                if (accountHolderEl) accountHolderEl.textContent = accountHolder;
                
                loadBankTransactionHistory(bankName, accountNumber);
                bankHistoryModal.classList.remove('hidden');
                bankHistoryModal.style.display = 'flex';
                
                console.log('Modal should be visible now');
            }

            // Load transaction history
            function loadBankTransactionHistory(bankName, accountNumber) {
                const key = `${bankName}-${accountNumber}`;
                const transactions = mockBankTransactions[key] || [];
                
                const tbody = document.getElementById('bank-history-tbody');
                const emptyState = document.getElementById('bank-history-empty');
                
                if (!tbody || !emptyState) return;
                
                if (transactions.length === 0) {
                    tbody.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    updateSummaryStats([]);
                    return;
                }
                
                emptyState.classList.add('hidden');
                
                // Sort transactions by date and time (newest first)
                const sortedTransactions = transactions.sort((a, b) => {
                    const dateA = new Date(`${a.date} ${a.time}`);
                    const dateB = new Date(`${b.date} ${b.time}`);
                    return dateB - dateA;
                });
                
                tbody.innerHTML = sortedTransactions.map(transaction => `
                    <tr class="hover:bg-gray-50">
                        <td class="p-3">
                            <div>
                                <div class="font-medium">${transaction.date}</div>
                                <div class="text-xs text-gray-500">${transaction.time}</div>
                            </div>
                        </td>
                        <td class="p-3 font-mono text-sm">${transaction.transactionId}</td>
                        <td class="p-3">${getTransactionTypeBadge(transaction.type, transaction.amount)}</td>
                        <td class="p-3">${transaction.customer}</td>
                        <td class="p-3 text-right">
                            <span class="font-semibold ${transaction.amount > 0 ? 'text-green-600' : 'text-red-600'}">
                                ${transaction.amount > 0 ? '+' : ''}${formatCurrencyBankHistory(transaction.amount)}
                            </span>
                        </td>
                        <td class="p-3 text-sm">${transaction.content}</td>
                        <td class="p-3 text-center">${getStatusBadgeBankHistory(transaction.status)}</td>
                        <td class="p-3 text-sm">${transaction.processor}</td>
                    </tr>
                `).join('');
                
                updateSummaryStats(sortedTransactions);
            }

            // Update summary statistics
            function updateSummaryStats(transactions) {
                const deposits = transactions.filter(t => t.amount > 0);
                const withdrawals = transactions.filter(t => t.amount < 0);
                
                const totalDeposits = deposits.reduce((sum, t) => sum + t.amount, 0);
                const totalWithdrawals = Math.abs(withdrawals.reduce((sum, t) => sum + t.amount, 0));
                const estimatedBalance = totalDeposits - totalWithdrawals;
                
                const totalDepositsEl = document.getElementById('total-deposits');
                const totalWithdrawalsEl = document.getElementById('total-withdrawals');
                const totalTransactionsEl = document.getElementById('total-transactions');
                const estimatedBalanceEl = document.getElementById('estimated-balance');
                
                if (totalDepositsEl) totalDepositsEl.textContent = formatCurrencyBankHistory(totalDeposits);
                if (totalWithdrawalsEl) totalWithdrawalsEl.textContent = formatCurrencyBankHistory(totalWithdrawals);
                if (totalTransactionsEl) totalTransactionsEl.textContent = transactions.length.toString();
                if (estimatedBalanceEl) {
                    estimatedBalanceEl.textContent = formatCurrencyBankHistory(estimatedBalance);
                    estimatedBalanceEl.className = `text-xl font-bold ${estimatedBalance >= 0 ? 'text-purple-600' : 'text-red-600'}`;
                }
            }

            // Filter functionality
            function filterTransactions() {
                const typeEl = document.getElementById('transaction-type-filter');
                const fromDateEl = document.getElementById('from-date-filter');
                const toDateEl = document.getElementById('to-date-filter');
                const amountFilterEl = document.getElementById('amount-filter');
                const bankNameEl = document.getElementById('bank-name');
                const accountNumberEl = document.getElementById('account-number');
                
                if (!typeEl || !fromDateEl || !toDateEl || !amountFilterEl || !bankNameEl || !accountNumberEl) return;
                
                const type = typeEl.value;
                const fromDate = fromDateEl.value;
                const toDate = toDateEl.value;
                const amountFilter = amountFilterEl.value;
                const bankName = bankNameEl.textContent;
                const accountNumber = accountNumberEl.textContent;
                
                const key = `${bankName}-${accountNumber}`;
                let transactions = mockBankTransactions[key] || [];
                
                // Apply filters
                if (type) {
                    transactions = transactions.filter(t => {
                        if (type === 'deposit') return t.amount > 0;
                        if (type === 'withdrawal') return t.amount < 0;
                        return true;
                    });
                }
                
                if (fromDate) {
                    transactions = transactions.filter(t => t.date >= fromDate);
                }
                
                if (toDate) {
                    transactions = transactions.filter(t => t.date <= toDate);
                }
                
                if (amountFilter) {
                    const amount = parseFloat(amountFilter.replace(/[,\.]/g, ''));
                    if (!isNaN(amount)) {
                        transactions = transactions.filter(t => Math.abs(t.amount) >= amount);
                    }
                }
                
                // Update display
                const tbody = document.getElementById('bank-history-tbody');
                const emptyState = document.getElementById('bank-history-empty');
                
                if (!tbody || !emptyState) return;
                
                if (transactions.length === 0) {
                    tbody.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    updateSummaryStats([]);
                    return;
                }
                
                emptyState.classList.add('hidden');
                
                const sortedTransactions = transactions.sort((a, b) => {
                    const dateA = new Date(`${a.date} ${a.time}`);
                    const dateB = new Date(`${b.date} ${b.time}`);
                    return dateB - dateA;
                });
                
                tbody.innerHTML = sortedTransactions.map(transaction => `
                    <tr class="hover:bg-gray-50">
                        <td class="p-3">
                            <div>
                                <div class="font-medium">${transaction.date}</div>
                                <div class="text-xs text-gray-500">${transaction.time}</div>
                            </div>
                        </td>
                        <td class="p-3 font-mono text-sm">${transaction.transactionId}</td>
                        <td class="p-3">${getTransactionTypeBadge(transaction.type, transaction.amount)}</td>
                        <td class="p-3">${transaction.customer}</td>
                        <td class="p-3 text-right">
                            <span class="font-semibold ${transaction.amount > 0 ? 'text-green-600' : 'text-red-600'}">
                                ${transaction.amount > 0 ? '+' : ''}${formatCurrencyBankHistory(transaction.amount)}
                            </span>
                        </td>
                        <td class="p-3 text-sm">${transaction.content}</td>
                        <td class="p-3 text-center">${getStatusBadgeBankHistory(transaction.status)}</td>
                        <td class="p-3 text-sm">${transaction.processor}</td>
                    </tr>
                `).join('');
                
                updateSummaryStats(sortedTransactions);
            }

            // Event listeners - using more specific delegation
            document.addEventListener('click', function(e) {
                // Check if clicked element or its parent has the class
                const historyLink = e.target.closest('.view-bank-history-link');
                if (historyLink) {
                    e.preventDefault();
                    console.log('History link clicked!', historyLink);
                    
                    const row = historyLink.closest('tr');
                    if (row) {
                        const bankName = row.getAttribute('data-bank-name');
                        const accountNumber = row.getAttribute('data-account-number');
                        const accountHolder = row.getAttribute('data-account-name');
                        
                        console.log('Bank data:', {bankName, accountNumber, accountHolder});
                        
                        if (bankName && accountNumber && accountHolder) {
                            showBankHistoryModal(bankName, accountNumber, accountHolder);
                        } else {
                            console.error('Missing bank data attributes');
                        }
                    } else {
                        console.error('Could not find parent row');
                    }
                    return;
                }
            });

            closeBankHistoryModal.addEventListener('click', function() {
                bankHistoryModal.classList.add('hidden');
                bankHistoryModal.style.display = 'none';
            });

            const filterBtn = document.getElementById('filter-bank-history');
            if (filterBtn) {
                filterBtn.addEventListener('click', filterTransactions);
            }

            // Close modal when clicking outside
            bankHistoryModal.addEventListener('click', function(e) {
                if (e.target === bankHistoryModal) {
                    bankHistoryModal.classList.add('hidden');
                    bankHistoryModal.style.display = 'none';
                }
            });
        };

        // Initialize bank history modal when content is loaded
        document.addEventListener('DOMContentLoaded', function() {
            window.initBankHistoryModal();
        });

        // Store bank data when nav-link with view-bank-history-link is clicked
        document.addEventListener('click', function(e) {
            const navLink = e.target.closest('.nav-link.view-bank-history-link');
            if (navLink) {
                console.log('Bank history nav-link clicked');
                
                const row = navLink.closest('tr');
                if (row) {
                    const bankName = row.getAttribute('data-bank-name');
                    const accountNumber = row.getAttribute('data-account-number');
                    const accountHolder = row.getAttribute('data-account-name');
                    
                    console.log('Storing bank data:', {bankName, accountNumber, accountHolder});
                    
                    // Store bank data in sessionStorage for the history page
                    sessionStorage.setItem('bankHistoryData', JSON.stringify({
                        bankName: bankName,
                        accountNumber: accountNumber,
                        accountHolder: accountHolder
                    }));
                }
            }
        });

        // Global function to show bank history modal
        window.showBankHistoryModalGlobal = function(bankName, accountNumber, accountHolder) {
            console.log('showBankHistoryModalGlobal called with:', {bankName, accountNumber, accountHolder});
            
            const bankHistoryModal = document.getElementById('bank-history-modal');
            if (!bankHistoryModal) {
                console.error('Bank history modal not found in DOM');
                return;
            }
            
            // Set bank info
            const bankNameEl = document.getElementById('bank-name');
            const accountNumberEl = document.getElementById('account-number');
            const accountHolderEl = document.getElementById('account-holder');
            
            if (bankNameEl) bankNameEl.textContent = bankName;
            if (accountNumberEl) accountNumberEl.textContent = accountNumber;
            if (accountHolderEl) accountHolderEl.textContent = accountHolder;
            
            // Load sample data based on bank
            const mockData = {
                'Vietcombank-0123456789': [
                    {date: '2025-08-05', time: '14:20:00', transactionId: 'VCB240805001', type: 'deposit', customer: 'Nguyễn Văn A (KH001)', amount: 5000000, content: 'N-0805-1 Nap tien', status: 'completed', processor: 'Auto System'},
                    {date: '2025-08-05', time: '11:35:00', transactionId: 'VCB240805002', type: 'deposit', customer: 'Trần Thị B (KH002)', amount: 10000000, content: 'N-0805-2 Nap tien', status: 'completed', processor: 'Admin'},
                    {date: '2025-08-04', time: '16:05:00', transactionId: 'VCB240804001', type: 'withdrawal', customer: 'Phạm Thị D (KH005)', amount: -1000000, content: 'R-0804-5 Rut tien', status: 'completed', processor: 'Admin'}
                ],
                'Techcombank-9876543210': [
                    {date: '2025-08-01', time: '10:15:00', transactionId: 'TCB240801001', type: 'deposit', customer: 'Hoàng Văn E (KH006)', amount: 2000000, content: 'N-0801-1 Nap tien', status: 'completed', processor: 'Auto System'},
                    {date: '2025-07-31', time: '14:45:00', transactionId: 'TCB240731001', type: 'withdrawal', customer: 'Nguyễn Văn A (KH001)', amount: -1500000, content: 'R-0731-2 Rut tien', status: 'completed', processor: 'ketoan.1'}
                ]
            };
            
            const key = `${bankName}-${accountNumber}`;
            const transactions = mockData[key] || [];
            
            // Load transactions into table
            const tbody = document.getElementById('bank-history-tbody');
            if (tbody && transactions.length > 0) {
                tbody.innerHTML = transactions.map(t => `
                    <tr class="hover:bg-gray-50">
                        <td class="p-3">
                            <div class="font-medium">${t.date}</div>
                            <div class="text-xs text-gray-500">${t.time}</div>
                        </td>
                        <td class="p-3 font-mono text-sm">${t.transactionId}</td>
                        <td class="p-3">
                            <span class="px-2 py-1 ${t.amount > 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} text-xs rounded-full font-medium">
                                <i class="fas ${t.amount > 0 ? 'fa-arrow-down' : 'fa-arrow-up'} mr-1"></i>
                                ${t.amount > 0 ? 'Nạp tiền' : 'Rút tiền'}
                            </span>
                        </td>
                        <td class="p-3">${t.customer}</td>
                        <td class="p-3 text-right">
                            <span class="font-semibold ${t.amount > 0 ? 'text-green-600' : 'text-red-600'}">
                                ${t.amount > 0 ? '+' : ''}${Math.abs(t.amount).toLocaleString('vi-VN')} ₫
                            </span>
                        </td>
                        <td class="p-3 text-sm">${t.content}</td>
                        <td class="p-3 text-center">
                            <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium">Thành công</span>
                        </td>
                        <td class="p-3 text-sm">${t.processor}</td>
                    </tr>
                `).join('');
                
                // Update stats
                const deposits = transactions.filter(t => t.amount > 0);
                const withdrawals = transactions.filter(t => t.amount < 0);
                const totalDeposits = deposits.reduce((sum, t) => sum + t.amount, 0);
                const totalWithdrawals = Math.abs(withdrawals.reduce((sum, t) => sum + t.amount, 0));
                
                const totalDepositsEl = document.getElementById('total-deposits');
                const totalWithdrawalsEl = document.getElementById('total-withdrawals');
                const totalTransactionsEl = document.getElementById('total-transactions');
                const estimatedBalanceEl = document.getElementById('estimated-balance');
                
                if (totalDepositsEl) totalDepositsEl.textContent = totalDeposits.toLocaleString('vi-VN') + ' ₫';
                if (totalWithdrawalsEl) totalWithdrawalsEl.textContent = totalWithdrawals.toLocaleString('vi-VN') + ' ₫';
                if (totalTransactionsEl) totalTransactionsEl.textContent = transactions.length.toString();
                if (estimatedBalanceEl) {
                    const balance = totalDeposits - totalWithdrawals;
                    estimatedBalanceEl.textContent = balance.toLocaleString('vi-VN') + ' ₫';
                    estimatedBalanceEl.className = `text-xl font-bold ${balance >= 0 ? 'text-purple-600' : 'text-red-600'}`;
                }
            }
            
            // Show modal
            bankHistoryModal.classList.remove('hidden');
            bankHistoryModal.style.display = 'flex';
            
            console.log('Modal should be visible now');
        };
        
        // Bank Transaction History Page Functionality
        window.initBankTransactionHistoryPage = function() {
            console.log('Initializing bank transaction history page');
            
            // Get bank data from sessionStorage
            const bankData = sessionStorage.getItem('bankHistoryData');
            if (!bankData) {
                console.error('No bank data found in sessionStorage');
                return;
            }
            
            const { bankName, accountNumber, accountHolder } = JSON.parse(bankData);
            
            // Set bank info in the page
            const bankNameEl = document.getElementById('bank-name-display');
            const accountNumberEl = document.getElementById('account-number-display');
            const accountHolderEl = document.getElementById('account-holder-display');
            
            if (bankNameEl) bankNameEl.textContent = bankName;
            if (accountNumberEl) accountNumberEl.textContent = accountNumber;
            if (accountHolderEl) accountHolderEl.textContent = accountHolder;
            
            // Mock transaction data
            const mockTransactionData = {
                'Vietcombank-0123456789': [
                    // August 2025
                    {date: '2025-08-05', time: '14:20:00', transactionId: 'VCB240805001', type: 'deposit', customer: 'Nguyễn Văn A (KH001)', amount: 5000000, content: 'N-0805-1 Nap tien', status: 'completed', processor: 'Auto System', fees: 0, reference: 'FT24080501'},
                    {date: '2025-08-05', time: '11:35:00', transactionId: 'VCB240805002', type: 'deposit', customer: 'Trần Thị B (KH002)', amount: 10000000, content: 'N-0805-2 Nap tien', status: 'completed', processor: 'Admin', fees: 0, reference: 'FT24080502'},
                    {date: '2025-08-05', time: '09:15:00', transactionId: 'VCB240805003', type: 'withdrawal', customer: 'Hoàng Văn E (KH006)', amount: -750000, content: 'R-0805-1 Rut tien', status: 'completed', processor: 'ketoan.1', fees: 11000, reference: 'FT24080503'},
                    {date: '2025-08-04', time: '16:05:00', transactionId: 'VCB240804001', type: 'withdrawal', customer: 'Phạm Thị D (KH005)', amount: -1000000, content: 'R-0804-5 Rut tien', status: 'completed', processor: 'Admin', fees: 11000, reference: 'FT24080401'},
                    {date: '2025-08-04', time: '13:22:00', transactionId: 'VCB240804002', type: 'deposit', customer: 'Đinh Văn F (KH007)', amount: 7500000, content: 'N-0804-1 Nap tien', status: 'completed', processor: 'Auto System', fees: 0, reference: 'FT24080402'},
                    {date: '2025-08-04', time: '10:40:00', transactionId: 'VCB240804003', type: 'deposit', customer: 'Vũ Thị G (KH008)', amount: 2200000, content: 'N-0804-2 Nap tien', status: 'completed', processor: 'Auto System', fees: 0, reference: 'FT24080403'},
                    {date: '2025-08-03', time: '15:30:00', transactionId: 'VCB240803001', type: 'deposit', customer: 'Lê Văn C (KH004)', amount: 3500000, content: 'N-0803-3 Nap tien', status: 'completed', processor: 'ketoan.1', fees: 0, reference: 'FT24080301'},
                    {date: '2025-08-03', time: '11:10:00', transactionId: 'VCB240803002', type: 'withdrawal', customer: 'Trần Thị B (KH002)', amount: -3000000, content: 'R-0803-1 Rut tien', status: 'completed', processor: 'Admin', fees: 11000, reference: 'FT24080302'},
                    {date: '2025-08-02', time: '16:20:00', transactionId: 'VCB240802001', type: 'deposit', customer: 'Lê Văn C (KH004)', amount: 3500000, content: 'Manual deposit - ref: FT24080112345', status: 'completed', processor: 'Admin', fees: 0, reference: 'FT24080201'},
                    {date: '2025-08-02', time: '09:45:00', transactionId: 'VCB240802002', type: 'deposit', customer: 'Ngô Thị H (KH009)', amount: 12000000, content: 'N-0802-1 Nap tien', status: 'completed', processor: 'Auto System', fees: 0, reference: 'FT24080202'},
                    {date: '2025-08-01', time: '14:15:00', transactionId: 'VCB240801001', type: 'deposit', customer: 'Hoàng Văn E (KH006)', amount: 2500000, content: 'N-0801-4 Nap tien', status: 'completed', processor: 'Auto System', fees: 0, reference: 'FT24080101'},
                    {date: '2025-08-01', time: '08:30:00', transactionId: 'VCB240801002', type: 'withdrawal', customer: 'Đinh Văn F (KH007)', amount: -1800000, content: 'R-0801-1 Rut tien', status: 'completed', processor: 'ketoan.1', fees: 11000, reference: 'FT24080102'},
                    
                    // July 2025
                    {date: '2025-07-31', time: '15:45:00', transactionId: 'VCB240731001', type: 'withdrawal', customer: 'Nguyễn Văn A (KH001)', amount: -500000, content: 'R-0731-3 Rut tien', status: 'completed', processor: 'ketoan.1', fees: 11000, reference: 'FT24073101'},
                    {date: '2025-07-31', time: '11:20:00', transactionId: 'VCB240731002', type: 'deposit', customer: 'Phan Văn I (KH010)', amount: 4500000, content: 'N-0731-1 Nap tien', status: 'completed', processor: 'Auto System', fees: 0, reference: 'FT24073102'},
                    {date: '2025-07-30', time: '16:55:00', transactionId: 'VCB240730001', type: 'deposit', customer: 'Lý Thị K (KH011)', amount: 6700000, content: 'N-0730-2 Nap tien', status: 'completed', processor: 'Admin', fees: 0, reference: 'FT24073001'},
                    {date: '2025-07-30', time: '10:25:00', transactionId: 'VCB240730002', type: 'withdrawal', customer: 'Vũ Thị G (KH008)', amount: -900000, content: 'R-0730-1 Rut tien', status: 'completed', processor: 'ketoan.1', fees: 11000, reference: 'FT24073002'},
                    {date: '2025-07-29', time: '14:40:00', transactionId: 'VCB240729001', type: 'deposit', customer: 'Mai Văn L (KH012)', amount: 15000000, content: 'N-0729-1 Nap tien', status: 'completed', processor: 'Auto System', fees: 0, reference: 'FT24072901'},
                    {date: '2025-07-29', time: '09:10:00', transactionId: 'VCB240729002', type: 'withdrawal', customer: 'Ngô Thị H (KH009)', amount: -2500000, content: 'R-0729-1 Rut tien', status: 'completed', processor: 'Admin', fees: 11000, reference: 'FT24072902'},
                    {date: '2025-07-28', time: '13:15:00', transactionId: 'VCB240728001', type: 'deposit', customer: 'Trương Văn M (KH013)', amount: 8800000, content: 'N-0728-1 Nap tien', status: 'completed', processor: 'ketoan.1', fees: 0, reference: 'FT24072801'},
                    {date: '2025-07-27', time: '16:30:00', transactionId: 'VCB240727001', type: 'withdrawal', customer: 'Phạm Thị D (KH005)', amount: -1200000, content: 'R-0727-1 Rut tien', status: 'completed', processor: 'Admin', fees: 11000, reference: 'FT24072701'},
                    {date: '2025-07-26', time: '11:45:00', transactionId: 'VCB240726001', type: 'deposit', customer: 'Dương Thị N (KH014)', amount: 5500000, content: 'N-0726-1 Nap tien', status: 'completed', processor: 'Auto System', fees: 0, reference: 'FT24072601'},
                    {date: '2025-07-25', time: '14:20:00', transactionId: 'VCB240725001', type: 'deposit', customer: 'Hồ Văn O (KH015)', amount: 20000000, content: 'N-0725-1 Nap tien', status: 'completed', processor: 'Admin', fees: 0, reference: 'FT24072501'},
                    {date: '2025-07-24', time: '10:55:00', transactionId: 'VCB240724001', type: 'withdrawal', customer: 'Phan Văn I (KH010)', amount: -800000, content: 'R-0724-1 Rut tien', status: 'completed', processor: 'ketoan.1', fees: 11000, reference: 'FT24072401'},
                    {date: '2025-07-23', time: '15:10:00', transactionId: 'VCB240723001', type: 'deposit', customer: 'Lê Thị P (KH016)', amount: 3300000, content: 'N-0723-1 Nap tien', status: 'completed', processor: 'Auto System', fees: 0, reference: 'FT24072301'},
                    {date: '2025-07-22', time: '12:35:00', transactionId: 'VCB240722001', type: 'withdrawal', customer: 'Mai Văn L (KH012)', amount: -4500000, content: 'R-0722-1 Rut tien', status: 'completed', processor: 'Admin', fees: 11000, reference: 'FT24072201'},
                    {date: '2025-07-21', time: '09:20:00', transactionId: 'VCB240721001', type: 'deposit', customer: 'Võ Văn Q (KH017)', amount: 7200000, content: 'N-0721-1 Nap tien', status: 'completed', processor: 'ketoan.1', fees: 0, reference: 'FT24072101'},
                    {date: '2025-07-20', time: '16:45:00', transactionId: 'VCB240720001', type: 'withdrawal', customer: 'Trương Văn M (KH013)', amount: -1600000, content: 'R-0720-1 Rut tien', status: 'completed', processor: 'Admin', fees: 11000, reference: 'FT24072001'}
                ],
                'Techcombank-9876543210': [
                    // August 2025
                    {date: '2025-08-01', time: '10:15:00', transactionId: 'TCB240801001', type: 'deposit', customer: 'Hoàng Văn E (KH006)', amount: 2000000, content: 'N-0801-1 Nap tien', status: 'completed', processor: 'Auto System', fees: 0, reference: 'TT24080101'},
                    {date: '2025-08-01', time: '14:30:00', transactionId: 'TCB240801002', type: 'withdrawal', customer: 'Trần Thị B (KH002)', amount: -2500000, content: 'R-0801-1 Rut tien', status: 'completed', processor: 'ketoan.1', fees: 15000, reference: 'TT24080102'},
                    
                    // July 2025
                    {date: '2025-07-31', time: '14:45:00', transactionId: 'TCB240731001', type: 'withdrawal', customer: 'Nguyễn Văn A (KH001)', amount: -1500000, content: 'R-0731-2 Rut tien', status: 'completed', processor: 'ketoan.1', fees: 15000, reference: 'TT24073101'},
                    {date: '2025-07-30', time: '09:20:00', transactionId: 'TCB240730001', type: 'deposit', customer: 'Trần Thị B (KH002)', amount: 8000000, content: 'N-0730-1 Nap tien', status: 'completed', processor: 'Admin', fees: 0, reference: 'TT24073001'},
                    {date: '2025-07-29', time: '11:35:00', transactionId: 'TCB240729001', type: 'deposit', customer: 'Phạm Văn R (KH018)', amount: 12500000, content: 'N-0729-1 Nap tien', status: 'completed', processor: 'Auto System', fees: 0, reference: 'TT24072901'},
                    {date: '2025-07-28', time: '15:50:00', transactionId: 'TCB240728001', type: 'withdrawal', customer: 'Lê Thị S (KH019)', amount: -3200000, content: 'R-0728-1 Rut tien', status: 'completed', processor: 'Admin', fees: 15000, reference: 'TT24072801'},
                    {date: '2025-07-27', time: '08:25:00', transactionId: 'TCB240727001', type: 'deposit', customer: 'Nguyễn Văn T (KH020)', amount: 6800000, content: 'N-0727-1 Nap tien', status: 'completed', processor: 'ketoan.1', fees: 0, reference: 'TT24072701'},
                    {date: '2025-07-26', time: '13:40:00', transactionId: 'TCB240726001', type: 'withdrawal', customer: 'Hoàng Văn E (KH006)', amount: -1800000, content: 'R-0726-1 Rut tien', status: 'completed', processor: 'Auto System', fees: 15000, reference: 'TT24072601'},
                    {date: '2025-07-25', time: '16:10:00', transactionId: 'TCB240725001', type: 'deposit', customer: 'Đỗ Thị U (KH021)', amount: 9500000, content: 'N-0725-1 Nap tien', status: 'completed', processor: 'Admin', fees: 0, reference: 'TT24072501'},
                    {date: '2025-07-24', time: '10:55:00', transactionId: 'TCB240724001', type: 'deposit', customer: 'Bùi Văn V (KH022)', amount: 4300000, content: 'N-0724-1 Nap tien', status: 'completed', processor: 'ketoan.1', fees: 0, reference: 'TT24072401'},
                    {date: '2025-07-23', time: '14:20:00', transactionId: 'TCB240723001', type: 'withdrawal', customer: 'Phạm Văn R (KH018)', amount: -2700000, content: 'R-0723-1 Rut tien', status: 'completed', processor: 'Admin', fees: 15000, reference: 'TT24072301'},
                    {date: '2025-07-22', time: '09:45:00', transactionId: 'TCB240722001', type: 'deposit', customer: 'Trần Văn W (KH023)', amount: 11200000, content: 'N-0722-1 Nap tien', status: 'completed', processor: 'Auto System', fees: 0, reference: 'TT24072201'},
                    {date: '2025-07-21', time: '12:15:00', transactionId: 'TCB240721001', type: 'withdrawal', customer: 'Lê Thị S (KH019)', amount: -1400000, content: 'R-0721-1 Rut tien', status: 'completed', processor: 'ketoan.1', fees: 15000, reference: 'TT24072101'},
                    {date: '2025-07-20', time: '15:30:00', transactionId: 'TCB240720001', type: 'deposit', customer: 'Vương Thị X (KH024)', amount: 7600000, content: 'N-0720-1 Nap tien', status: 'completed', processor: 'Admin', fees: 0, reference: 'TT24072001'},
                    {date: '2025-07-19', time: '11:05:00', transactionId: 'TCB240719001', type: 'withdrawal', customer: 'Nguyễn Văn T (KH020)', amount: -2100000, content: 'R-0719-1 Rut tien', status: 'completed', processor: 'Auto System', fees: 15000, reference: 'TT24071901'},
                    {date: '2025-07-18', time: '14:50:00', transactionId: 'TCB240718001', type: 'deposit', customer: 'Chu Văn Y (KH025)', amount: 13800000, content: 'N-0718-1 Nap tien', status: 'completed', processor: 'ketoan.1', fees: 0, reference: 'TT24071801'},
                    {date: '2025-07-17', time: '08:20:00', transactionId: 'TCB240717001', type: 'withdrawal', customer: 'Đỗ Thị U (KH021)', amount: -3500000, content: 'R-0717-1 Rut tien', status: 'completed', processor: 'Admin', fees: 15000, reference: 'TT24071701'},
                    {date: '2025-07-16', time: '16:35:00', transactionId: 'TCB240716001', type: 'deposit', customer: 'Lý Văn Z (KH026)', amount: 5900000, content: 'N-0716-1 Nap tien', status: 'completed', processor: 'Auto System', fees: 0, reference: 'TT24071601'},
                    {date: '2025-07-15', time: '13:10:00', transactionId: 'TCB240715001', type: 'withdrawal', customer: 'Bùi Văn V (KH022)', amount: -1900000, content: 'R-0715-1 Rut tien', status: 'completed', processor: 'ketoan.1', fees: 15000, reference: 'TT24071501'}
                ]
            };
            
            const key = `${bankName}-${accountNumber}`;
            let allTransactions = mockTransactionData[key] || [];
            let filteredTransactions = [...allTransactions];
            let currentPage = 1;
            let pageSize = 25;
            let sortColumn = 'date';
            let sortDirection = 'desc';
            
            // Format currency
            function formatCurrency(amount) {
                return Math.abs(amount).toLocaleString('vi-VN') + ' ₫';
            }
            
            // Get transaction type badge
            function getTransactionTypeBadge(type, amount) {
                if (type === 'deposit' || amount > 0) {
                    return '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium"><i class="fas fa-arrow-down mr-1"></i>Nạp tiền</span>';
                } else {
                    return '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full font-medium"><i class="fas fa-arrow-up mr-1"></i>Rút tiền</span>';
                }
            }
            
            // Get status badge
            function getStatusBadge(status) {
                const badges = {
                    'completed': '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium">Thành công</span>',
                    'pending': '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full font-medium">Đang xử lý</span>',
                    'failed': '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full font-medium">Thất bại</span>'
                };
                return badges[status] || badges['completed'];
            }
            
            // Update summary statistics
            function updateSummaryStats(transactions) {
                const deposits = transactions.filter(t => t.amount > 0);
                const withdrawals = transactions.filter(t => t.amount < 0);
                
                const totalDeposits = deposits.reduce((sum, t) => sum + t.amount, 0);
                const totalWithdrawals = Math.abs(withdrawals.reduce((sum, t) => sum + t.amount, 0));
                const estimatedBalance = totalDeposits - totalWithdrawals;
                
                document.getElementById('total-deposits').textContent = formatCurrency(totalDeposits);
                document.getElementById('total-withdrawals').textContent = formatCurrency(totalWithdrawals);
                document.getElementById('total-transactions').textContent = transactions.length.toString();
                document.getElementById('estimated-balance').textContent = formatCurrency(estimatedBalance);
                document.getElementById('estimated-balance').className = `text-2xl font-bold ${estimatedBalance >= 0 ? 'text-purple-600' : 'text-red-600'}`;
                
                document.getElementById('deposit-count').textContent = deposits.length + ' giao dịch';
                document.getElementById('withdrawal-count').textContent = withdrawals.length + ' giao dịch';
            }
            
            // Sort transactions
            function sortTransactions(transactions, column, direction) {
                return transactions.sort((a, b) => {
                    let valueA, valueB;
                    
                    switch(column) {
                        case 'date':
                            valueA = new Date(a.date + ' ' + a.time);
                            valueB = new Date(b.date + ' ' + b.time);
                            break;
                        case 'amount':
                            valueA = Math.abs(a.amount);
                            valueB = Math.abs(b.amount);
                            break;
                        case 'customer':
                            valueA = a.customer.toLowerCase();
                            valueB = b.customer.toLowerCase();
                            break;
                        case 'transactionId':
                            valueA = a.transactionId.toLowerCase();
                            valueB = b.transactionId.toLowerCase();
                            break;
                        default:
                            return 0;
                    }
                    
                    if (direction === 'asc') {
                        return valueA > valueB ? 1 : -1;
                    } else {
                        return valueA < valueB ? 1 : -1;
                    }
                });
            }
            
            // Render transactions table
            function renderTransactionsTable() {
                const tbody = document.getElementById('transaction-history-tbody');
                const emptyState = document.getElementById('empty-state');
                
                if (!tbody) return;
                
                // Sort transactions
                const sortedTransactions = sortTransactions([...filteredTransactions], sortColumn, sortDirection);
                
                // Pagination
                const startIndex = (currentPage - 1) * pageSize;
                const endIndex = startIndex + pageSize;
                const paginatedTransactions = sortedTransactions.slice(startIndex, endIndex);
                
                if (paginatedTransactions.length === 0) {
                    tbody.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    updateSummaryStats([]);
                    return;
                }
                
                emptyState.classList.add('hidden');
                
                tbody.innerHTML = paginatedTransactions.map(transaction => `
                    <tr class="hover:bg-gray-50">
                        <td class="p-4">
                            <div>
                                <div class="font-medium">${transaction.date}</div>
                                <div class="text-xs text-gray-500">${transaction.time}</div>
                            </div>
                        </td>
                        <td class="p-4 font-mono text-sm">${transaction.transactionId}</td>
                        <td class="p-4">${getTransactionTypeBadge(transaction.type, transaction.amount)}</td>
                        <td class="p-4">${transaction.customer}</td>
                        <td class="p-4 text-right">
                            <span class="font-semibold ${transaction.amount > 0 ? 'text-green-600' : 'text-red-600'}">
                                ${transaction.amount > 0 ? '+' : ''}${formatCurrency(transaction.amount)}
                            </span>
                        </td>
                        <td class="p-4 text-sm">${transaction.content}</td>
                        <td class="p-4 text-center">${getStatusBadge(transaction.status)}</td>
                        <td class="p-4 text-sm">${transaction.processor}</td>
                        <td class="p-4 text-center">
                            <button onclick="showTransactionDetail('${transaction.transactionId}')" 
                                    class="text-blue-600 hover:text-blue-800 text-xs">
                                <i class="fas fa-eye mr-1"></i>Xem
                            </button>
                        </td>
                    </tr>
                `).join('');
                
                updateSummaryStats(sortedTransactions);
                updatePaginationInfo();
                renderPaginationControls();
            }
            
            // Update pagination info
            function updatePaginationInfo() {
                const totalItems = filteredTransactions.length;
                const startItem = totalItems === 0 ? 0 : (currentPage - 1) * pageSize + 1;
                const endItem = Math.min(currentPage * pageSize, totalItems);
                
                document.getElementById('pagination-info').textContent = 
                    `Hiển thị ${startItem}-${endItem} của ${totalItems} kết quả`;
            }
            
            // Render pagination controls
            function renderPaginationControls() {
                const totalItems = filteredTransactions.length;
                const totalPages = Math.ceil(totalItems / pageSize);
                const controls = document.getElementById('pagination-controls');
                
                if (!controls || totalPages <= 1) {
                    if (controls) controls.innerHTML = '';
                    return;
                }
                
                let paginationHTML = '';
                
                // Previous button
                paginationHTML += `
                    <button onclick="changePage(${currentPage - 1})" 
                            ${currentPage === 1 ? 'disabled' : ''} 
                            class="px-3 py-1 border rounded ${currentPage === 1 ? 'bg-gray-200 text-gray-400' : 'bg-white text-gray-700 hover:bg-gray-100'}">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                `;
                
                // Page numbers
                for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                    paginationHTML += `
                        <button onclick="changePage(${i})" 
                                class="px-3 py-1 border rounded ${i === currentPage ? 'bg-blue-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}">
                            ${i}
                        </button>
                    `;
                }
                
                // Next button
                paginationHTML += `
                    <button onclick="changePage(${currentPage + 1})" 
                            ${currentPage === totalPages ? 'disabled' : ''} 
                            class="px-3 py-1 border rounded ${currentPage === totalPages ? 'bg-gray-200 text-gray-400' : 'bg-white text-gray-700 hover:bg-gray-100'}">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                `;
                
                controls.innerHTML = paginationHTML;
            }
            
            // Change page function
            window.changePage = function(page) {
                const totalPages = Math.ceil(filteredTransactions.length / pageSize);
                if (page >= 1 && page <= totalPages) {
                    currentPage = page;
                    renderTransactionsTable();
                }
            };
            
            // Sort table function
            window.sortTable = function(column) {
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'desc';
                }
                renderTransactionsTable();
            };
            
            // Filter transactions
            function applyFilters() {
                const typeFilter = document.getElementById('transaction-type-filter')?.value;
                const fromDate = document.getElementById('from-date-filter')?.value;
                const toDate = document.getElementById('to-date-filter')?.value;
                const amountFilter = document.getElementById('amount-filter')?.value;
                const customerFilter = document.getElementById('customer-filter')?.value;
                
                filteredTransactions = allTransactions.filter(transaction => {
                    // Type filter
                    if (typeFilter) {
                        if (typeFilter === 'deposit' && transaction.amount <= 0) return false;
                        if (typeFilter === 'withdrawal' && transaction.amount >= 0) return false;
                    }
                    
                    // Date range filter
                    if (fromDate && transaction.date < fromDate) return false;
                    if (toDate && transaction.date > toDate) return false;
                    
                    // Amount filter
                    if (amountFilter) {
                        const amount = parseFloat(amountFilter.replace(/[,\.]/g, ''));
                        if (!isNaN(amount) && Math.abs(transaction.amount) < amount) return false;
                    }
                    
                    // Customer filter
                    if (customerFilter && !transaction.customer.toLowerCase().includes(customerFilter.toLowerCase())) {
                        return false;
                    }
                    
                    return true;
                });
                
                currentPage = 1; // Reset to first page
                renderTransactionsTable();
            }
            
            // Show transaction detail
            window.showTransactionDetail = function(transactionId) {
                const transaction = allTransactions.find(t => t.transactionId === transactionId);
                if (!transaction) return;
                
                const modal = document.getElementById('transaction-detail-modal');
                const content = document.getElementById('transaction-detail-content');
                
                if (!modal || !content) return;
                
                content.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-medium text-gray-600">Mã giao dịch:</label>
                            <p class="font-mono text-lg">${transaction.transactionId}</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">Loại giao dịch:</label>
                            <p>${getTransactionTypeBadge(transaction.type, transaction.amount)}</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">Ngày giờ:</label>
                            <p>${transaction.date} ${transaction.time}</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">Khách hàng:</label>
                            <p>${transaction.customer}</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">Số tiền:</label>
                            <p class="text-lg font-bold ${transaction.amount > 0 ? 'text-green-600' : 'text-red-600'}">
                                ${transaction.amount > 0 ? '+' : ''}${formatCurrency(transaction.amount)}
                            </p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">Phí giao dịch:</label>
                            <p>${formatCurrency(transaction.fees || 0)}</p>
                        </div>
                        <div class="col-span-2">
                            <label class="text-sm font-medium text-gray-600">Nội dung:</label>
                            <p>${transaction.content}</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">Trạng thái:</label>
                            <p>${getStatusBadge(transaction.status)}</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">Người xử lý:</label>
                            <p>${transaction.processor}</p>
                        </div>
                        <div class="col-span-2">
                            <label class="text-sm font-medium text-gray-600">Mã tham chiếu:</label>
                            <p class="font-mono">${transaction.reference || 'N/A'}</p>
                        </div>
                    </div>
                `;
                
                modal.classList.remove('hidden');
            };
            
            // Event listeners
            document.getElementById('filter-transactions')?.addEventListener('click', applyFilters);
            
            document.getElementById('reset-filters')?.addEventListener('click', function() {
                document.getElementById('transaction-type-filter').value = '';
                document.getElementById('from-date-filter').value = '';
                document.getElementById('to-date-filter').value = '';
                document.getElementById('amount-filter').value = '';
                document.getElementById('customer-filter').value = '';
                filteredTransactions = [...allTransactions];
                currentPage = 1;
                renderTransactionsTable();
            });
            
            document.getElementById('page-size')?.addEventListener('change', function() {
                pageSize = parseInt(this.value);
                currentPage = 1;
                renderTransactionsTable();
            });
            
            document.getElementById('refresh-data')?.addEventListener('click', function() {
                renderTransactionsTable();
            });
            
            document.getElementById('export-excel')?.addEventListener('click', function() {
                alert('Chức năng xuất Excel đang được phát triển...');
            });
            
            document.getElementById('close-transaction-detail')?.addEventListener('click', function() {
                document.getElementById('transaction-detail-modal').classList.add('hidden');
            });
            
            // Close modal when clicking outside
            document.getElementById('transaction-detail-modal')?.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.add('hidden');
                }
            });
            
            // Initial render
            renderTransactionsTable();
        };

        // ORDER MANAGEMENT FUNCTIONS
        window.handleOrderAction = function(orderId, action) {
            console.log('Order action:', orderId, action);
            
            switch(action) {
                case 'approve':
                    showNotification('Đang duyệt đơn hàng ' + orderId + '...', 'info');
                    setTimeout(() => {
                        updateOrderStatus(orderId, 'waiting_deposit', 'Đợi đặt cọc');
                        showNotification('Đơn hàng ' + orderId + ' đã được duyệt! Chờ khách đặt cọc.', 'success');
                    }, 1000);
                    break;
                    
                case 'check':
                    showNotification('Đang kiểm hàng ' + orderId + '...', 'info');
                    setTimeout(() => {
                        updateOrderStatus(orderId, 'waiting_payment', 'Đợi thanh toán');
                        showNotification('Kiểm hàng hoàn tất! ' + orderId + ' chờ thanh toán.', 'success');
                    }, 1500);
                    break;
                    
                case 'ship_to_vn':
                    showNotification('Đang chuyển hàng về Việt Nam...', 'info');
                    setTimeout(() => {
                        updateOrderStatus(orderId, 'in_transit_vn', 'Đến kho Việt');
                        showNotification('Hàng đã được chuyển về Việt Nam!', 'success');
                    }, 1200);
                    break;
                    
                case 'payment':
                    showPaymentModal(orderId);
                    break;
                    
                case 'deliver':
                    showNotification('Đang xử lý giao hàng...', 'info');
                    setTimeout(() => {
                        updateOrderStatus(orderId, 'delivered', 'Đã giao hàng');
                        showNotification('Đơn hàng ' + orderId + ' đã được giao thành công!', 'success');
                    }, 1000);
                    break;
            }
        };

        window.handleAdminAction = function(orderId, action) {
            console.log('=== ADMIN ACTION CALLED ===');
            console.log('Order ID:', orderId, 'Action:', action);
            
            // Prevent any default behavior
            if (typeof event !== 'undefined') {
                event.preventDefault();
                event.stopPropagation();
            }
            
            switch(action) {
                case 'approve':
                    console.log('Calling showApproveModal for:', orderId);
                    showApproveModal(orderId);
                    break;
                    
                case 'add_tracking':
                    console.log('Calling showTrackingModal for:', orderId);
                    showTrackingModal(orderId);
                    break;
                    
                case 'ship_to_vn':
                    showNotification('Đang chuyển hàng về Việt Nam...', 'info');
                    setTimeout(() => {
                        updateAdminOrderStatus(orderId, 'in_transit_vn', 'Đến kho Việt');
                        showNotification('Hàng đã được chuyển về Việt Nam!', 'success');
                    }, 1200);
                    break;
                    
                case 'check_goods':
                    showGoodsInspectionModal(orderId);
                    break;
                    
                case 'complete_check':
                    showNotification('Hoàn tất kiểm hàng...', 'info');
                    setTimeout(() => {
                        updateAdminOrderStatus(orderId, 'waiting_payment', 'Đợi thanh toán');
                        showNotification('Kiểm hàng hoàn tất! Thông báo khách thanh toán.', 'success');
                    }, 1000);
                    break;
                    
                case 'ship_order':
                    showNotification('Đang giao hàng...', 'info');
                    setTimeout(() => {
                        updateAdminOrderStatus(orderId, 'delivered', 'Đã giao hàng');
                        showNotification('Đơn hàng ' + orderId + ' đã được giao!', 'success');
                    }, 1000);
                    break;
            }
        };

        window.showOrderDetail = function(orderId) {
            console.log('=== ORDER DETAIL FUNCTION CALLED ===');
            console.log('Opening order detail for:', orderId);
            
            // Prevent any default actions
            if (typeof event !== 'undefined') {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // Find the order row to get data
            const orderRow = document.querySelector(`tr[data-order-id="${orderId}"]`);
            if (!orderRow) {
                console.error('Order row not found for:', orderId);
                showNotification('Không tìm thấy đơn hàng ' + orderId, 'error');
                return;
            }
            
            // Get order data from the row
            const customerName = orderRow.dataset.customer || 'N/A';
            const status = orderRow.dataset.status || 'unknown';
            console.log('Order data:', { orderId, customerName, status });
            
            // Check if modal exists
            const modal = document.getElementById('order-detail-modal');
            if (!modal) {
                console.error('Order detail modal not found!');
                showNotification('Không tìm thấy modal chi tiết đơn hàng', 'error');
                return;
            }
            
            // Update modal content with correct element IDs
            const detailOrderId = document.getElementById('detail-order-id');
            const detailCustomer = document.getElementById('detail-customer');
            const detailStatus = document.getElementById('detail-status');
            const detailOrderDate = document.getElementById('detail-order-date');
            
            console.log('Modal elements found:', {
                detailOrderId: !!detailOrderId,
                detailCustomer: !!detailCustomer,
                detailStatus: !!detailStatus,
                detailOrderDate: !!detailOrderDate
            });
            
            if (detailOrderId) detailOrderId.textContent = '#' + orderId;
            if (detailCustomer) detailCustomer.textContent = customerName;
            if (detailStatus) {
                detailStatus.textContent = getStatusText(status);
                detailStatus.className = getStatusBadgeClass(status).replace('inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium', 'px-2 py-1 text-xs rounded-full font-medium');
            }
            if (detailOrderDate) {
                // Get current date for demo
                const today = new Date();
                detailOrderDate.textContent = today.toLocaleDateString('vi-VN');
            }
            
            // Force show the modal directly
            console.log('Opening modal: order-detail-modal');
            modal.classList.remove('hidden');
            
            showNotification('Đã tải chi tiết đơn hàng ' + orderId, 'success');
            
            return false; // Prevent any further event propagation
        };

        // Helper function to get status text
        function getStatusText(status) {
            const statusTexts = {
                'pending_approval': 'Đợi duyệt',
                'waiting_deposit': 'Đợi đặt cọc',
                'deposit_confirmed': 'Đã đặt cọc',
                'ordered': 'Đã mua',
                'in_transit_jp': 'Đến kho Nhật',
                'in_transit_vn': 'Đến kho Việt',
                'checking': 'Đang kiểm hàng',
                'waiting_payment': 'Đợi thanh toán',
                'ready_to_ship': 'Sẵn chuyển',
                'delivered': 'Đã giao hàng'
            };
            return statusTexts[status] || status;
        }

        // Show approve order modal function
        window.showApproveModal = function(orderId) {
            console.log('=== SHOW APPROVE MODAL ===');
            console.log('Order ID:', orderId);
            
            // Check if modal exists
            const modal = document.getElementById('approve-order-modal');
            if (!modal) {
                console.error('Approve modal not found!');
                showNotification('Không tìm thấy modal duyệt đơn hàng', 'error');
                return;
            }
            
            const orderRow = document.querySelector(`tr[data-order-id="${orderId}"]`);
            if (orderRow) {
                const customer = orderRow.getAttribute('data-customer') || 'N/A';
                console.log('Found order row, customer:', customer);
                
                // Update approve modal content
                const approveOrderId = document.getElementById('approve-order-id');
                const approveCustomer = document.getElementById('approve-customer');
                
                if (approveOrderId) approveOrderId.textContent = '#' + orderId;
                if (approveCustomer) approveCustomer.textContent = customer;
                
                console.log('Updated modal content');
            } else {
                console.warn('Order row not found for ID:', orderId);
            }
            
            // Set up COD fee toggle functionality (includes setting default state)
            setupCODFeeToggle();
            
            // Try both openModal function and direct show
            if (typeof openModal === 'function') {
                console.log('Using openModal function');
                openModal('approve-order-modal');
            } else {
                console.log('Using direct modal show');
                modal.classList.remove('hidden');
            }
            
            console.log('Modal should now be visible');
        };

        // Show tracking modal function
        window.showTrackingModal = function(orderId) {
            console.log('=== SHOW TRACKING MODAL ===');
            console.log('Order ID:', orderId);
            
            // Check if modal exists
            const modal = document.getElementById('tracking-modal');
            if (!modal) {
                console.error('Tracking modal not found!');
                showNotification('Không tìm thấy modal tracking', 'error');
                return;
            }
            
            const orderRow = document.querySelector(`tr[data-order-id="${orderId}"]`);
            if (orderRow) {
                const customer = orderRow.getAttribute('data-customer') || 'N/A';
                console.log('Found order row, customer:', customer);
                
                // Update tracking modal content
                const trackingOrderId = document.getElementById('tracking-order-id');
                const trackingCustomer = document.getElementById('tracking-customer');
                
                if (trackingOrderId) trackingOrderId.textContent = '#' + orderId;
                if (trackingCustomer) trackingCustomer.textContent = customer;
                
                console.log('Updated tracking modal content');
            } else {
                console.warn('Order row not found for ID:', orderId);
            }
            
            // Try both openModal function and direct show
            if (typeof openModal === 'function') {
                console.log('Using openModal function');
                openModal('tracking-modal');
            } else {
                console.log('Using direct modal show');
                modal.classList.remove('hidden');
            }
            
            console.log('Tracking modal should now be visible');
        };

        // Global notification function
        window.showNotification = function(message, type = 'info') {
            console.log('Notification:', message, type);
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        };

        // Edit order function
        window.editOrder = function(orderId) {
            showNotification(`Chức năng chỉnh sửa đơn hàng ${orderId} sẽ được triển khai.`, 'info');
            // TODO: Implement edit order functionality
        };

        // Create order functionality
        window.showCreateOrderModal = function() {
            if (typeof openModal === 'function') {
                openModal('admin-create-order-modal');
            } else {
                const modal = document.getElementById('admin-create-order-modal');
                if (modal) modal.classList.remove('hidden');
            }
        };

        // Make openModal globally accessible if it exists
        if (typeof openModal !== 'undefined') {
            window.openModal = openModal;
        } else {
            // Define openModal if it doesn't exist
            window.openModal = function(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('hidden');
                } else {
                    console.error('Modal not found:', modalId);
                }
            };
        }

        // COD Fee Toggle Setup Function
        window.setupCODFeeToggle = function() {
            console.log('Setting up COD fee toggle');
            
            // Wait for modal content to be fully loaded
            setTimeout(() => {
                const radios = document.querySelectorAll('input[name="cod-fee-type"]');
                const fixedSection = document.getElementById('fixed-cod-section');
                
                console.log('Found COD fee radios:', radios.length);
                console.log('Found fixed section:', !!fixedSection);
                
                if (radios.length === 0) {
                    console.error('No COD fee radio buttons found!');
                    return;
                }
                
                // Remove existing event listeners to avoid duplicates
                radios.forEach(radio => {
                    // Clone node to remove all event listeners
                    const newRadio = radio.cloneNode(true);
                    radio.parentNode.replaceChild(newRadio, radio);
                });
                
                // Add new event listeners to the updated radios
                document.querySelectorAll('input[name="cod-fee-type"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        console.log('COD fee type changed to:', this.value);
                        const fixedSection = document.getElementById('fixed-cod-section');
                        const fixedAmountInput = document.getElementById('fixed-cod-amount');
                        
                        if (fixedSection) {
                            if (this.value === 'fixed') {
                                console.log('Showing fixed COD input');
                                fixedSection.classList.remove('hidden');
                                // Focus on input when shown
                                if (fixedAmountInput) {
                                    setTimeout(() => fixedAmountInput.focus(), 100);
                                }
                            } else {
                                console.log('Hiding fixed COD input');
                                fixedSection.classList.add('hidden');
                                // Clear input when hidden
                                if (fixedAmountInput) {
                                    fixedAmountInput.value = '';
                                }
                            }
                        } else {
                            console.error('Fixed COD section not found!');
                        }
                    });
                });
                
                // Set default state - "calculate later" should be selected
                const calculateLaterRadio = document.querySelector('input[name="cod-fee-type"][value="calculated"]');
                if (calculateLaterRadio && fixedSection) {
                    calculateLaterRadio.checked = true;
                    fixedSection.classList.add('hidden');
                    console.log('Set default: calculate later with hidden input');
                } else {
                    console.error('Could not set default state - elements not found');
                }
            }, 200);
        };

        // Show Goods Inspection Modal Function
        window.showGoodsInspectionModal = function(orderId) {
            console.log('=== SHOW GOODS INSPECTION MODAL ===');
            console.log('Order ID:', orderId);
            
            const modal = document.getElementById('goods-inspection-modal');
            if (!modal) {
                console.error('Goods inspection modal not found!');
                showNotification('Không tìm thấy modal kiểm hàng', 'error');
                return;
            }
            
            // Get order information from the table row
            const orderRow = document.querySelector(`tr[data-order-id="${orderId}"]`);
            let customer = 'N/A';
            let product = 'N/A';
            let codFeeSet = true; // Assume COD fee is set by default
            
            if (orderRow) {
                customer = orderRow.getAttribute('data-customer') || 'N/A';
                product = orderRow.getAttribute('data-product') || 'N/A';
                // Check if COD fee was set during approval - for demo, we'll show COD section randomly
                codFeeSet = Math.random() > 0.5; // Simulating some orders having COD fee set, others not
            }
            
            // Populate modal with order information
            document.getElementById('inspection-order-id').textContent = '#' + orderId;
            document.getElementById('inspection-customer').textContent = customer;
            document.getElementById('inspection-product').textContent = product;
            
            // Show/hide COD fee section based on whether it was previously set
            const codFeeSection = document.getElementById('cod-fee-section');
            if (!codFeeSet && codFeeSection) {
                codFeeSection.classList.remove('hidden');
                setupInspectionCODToggle();
            } else if (codFeeSection) {
                codFeeSection.classList.add('hidden');
            }
            
            // Reset form
            document.getElementById('goods-inspection-form').reset();
            document.getElementById('inspection-weight-rate').value = '50000';
            updateInspectionCalculation();
            
            // Show modal
            modal.classList.remove('hidden');
            
            // Focus on weight input
            setTimeout(() => {
                const weightInput = document.getElementById('inspection-weight');
                if (weightInput) weightInput.focus();
            }, 300);
        };

        // Setup COD fee toggle for inspection modal
        window.setupInspectionCODToggle = function() {
            console.log('Setting up inspection COD fee toggle');
            
            setTimeout(() => {
                const radios = document.querySelectorAll('input[name="inspection-cod-type"]');
                console.log('Found inspection COD radios:', radios.length);
                
                radios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        console.log('Inspection COD type changed to:', this.value);
                        const fixedSection = document.getElementById('inspection-fixed-cod-section');
                        const fixedAmountInput = document.getElementById('inspection-cod-amount');
                        
                        if (fixedSection) {
                            if (this.value === 'fixed') {
                                fixedSection.classList.remove('hidden');
                                if (fixedAmountInput) {
                                    setTimeout(() => fixedAmountInput.focus(), 100);
                                }
                            } else {
                                fixedSection.classList.add('hidden');
                                if (fixedAmountInput) {
                                    fixedAmountInput.value = '';
                                }
                            }
                            updateInspectionCalculation();
                        }
                    });
                });
                
                // Set default to "calculate later"
                const calculateLaterRadio = document.querySelector('input[name="inspection-cod-type"][value="calculated"]');
                if (calculateLaterRadio) {
                    calculateLaterRadio.checked = true;
                }
            }, 100);
        };

        // Update inspection calculation
        window.updateInspectionCalculation = function() {
            const weight = parseFloat(document.getElementById('inspection-weight')?.value) || 0;
            const weightRate = parseFloat(document.getElementById('inspection-weight-rate')?.value) || 50000;
            const codAmount = parseFloat(document.getElementById('inspection-cod-amount')?.value) || 0;
            const codType = document.querySelector('input[name="inspection-cod-type"]:checked')?.value;
            
            const weightFee = weight * weightRate;
            let codFee = 0;
            let codDisplay = 'Chưa thiết lập';
            
            if (codType === 'fixed' && codAmount > 0) {
                codFee = codAmount;
                codDisplay = codAmount.toLocaleString('vi-VN') + ' ₫';
            } else if (codType === 'calculated') {
                codDisplay = 'Tính sau';
            }
            
            const total = weightFee + (codType === 'fixed' ? codFee : 0);
            
            // Update display
            document.getElementById('calc-inspection-weight-fee').textContent = weightFee.toLocaleString('vi-VN') + ' ₫';
            document.getElementById('calc-inspection-cod-fee').textContent = codDisplay;
            document.getElementById('calc-inspection-total').textContent = total.toLocaleString('vi-VN') + ' ₫';
        };

        // Handle form submissions for order management
        document.addEventListener('DOMContentLoaded', function() {
            // Approve order form submission
            const approveForm = document.getElementById('approve-order-form');
            if (approveForm) {
                approveForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const orderId = document.getElementById('approve-order-id').textContent.replace('#', '');
                    const productType = document.getElementById('approve-product-type').value;
                    const codType = document.querySelector('input[name="cod-fee-type"]:checked')?.value;
                    
                    if (!productType || !codType) {
                        showNotification('Vui lòng điền đầy đủ thông tin!', 'error');
                        return;
                    }
                    
                    showNotification('Đang duyệt đơn hàng ' + orderId + '...', 'info');
                    setTimeout(() => {
                        updateAdminOrderStatus(orderId, 'waiting_deposit', 'Đợi đặt cọc');
                        showNotification('Đơn hàng ' + orderId + ' đã được duyệt! Thông báo khách đặt cọc.', 'success');
                    }, 1000);
                    
                    closeModal('approve-order-modal');
                    approveForm.reset();
                });
            }
            
            // Tracking form submission
            const trackingForm = document.getElementById('tracking-form');
            if (trackingForm) {
                trackingForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const orderId = document.getElementById('tracking-order-id').textContent.replace('#', '');
                    const trackingCode = document.getElementById('tracking-code').value.trim();
                    const carrier = document.getElementById('shipping-carrier').value;
                    
                    // Tracking code is optional
                    if (trackingCode || carrier) {
                        showNotification('Đang cập nhật thông tin vận chuyển...', 'info');
                        setTimeout(() => {
                            updateAdminOrderStatus(orderId, 'in_transit_jp', 'Đến kho Nhật');
                            
                            // Update tracking in table
                            const orderRow = document.querySelector(`tr[data-order-id="${orderId}"]`);
                            if (orderRow) {
                                const trackingCell = orderRow.querySelector('td:nth-child(4)');
                                if (trackingCell) {
                                    if (trackingCode) {
                                        trackingCell.innerHTML = `
                                            <a href="#" class="text-blue-600 hover:text-blue-800 text-xs font-medium">${trackingCode}</a>
                                            <div class="text-xs text-gray-500">Cân nặng: 0.0kg</div>
                                        `;
                                    } else {
                                        trackingCell.innerHTML = `
                                            <span class="text-gray-500 text-xs">Chưa có tracking</span>
                                            <div class="text-xs text-gray-500">Cân nặng: 0.0kg</div>
                                        `;
                                    }
                                }
                            }
                            
                            if (trackingCode) {
                                showNotification('Tracking code đã được thêm!', 'success');
                            } else {
                                showNotification('Đơn hàng đã chuyển sang trạng thái "Đến kho Nhật"!', 'success');
                            }
                        }, 800);
                    } else {
                        // Even without tracking, we can still update status
                        showNotification('Đang cập nhật trạng thái đơn hàng...', 'info');
                        setTimeout(() => {
                            updateAdminOrderStatus(orderId, 'in_transit_jp', 'Đến kho Nhật');
                            showNotification('Đơn hàng đã chuyển sang trạng thái "Đến kho Nhật"!', 'success');
                        }, 800);
                    }
                    
                    closeModal('tracking-modal');
                    trackingForm.reset();
                });
            }
            
            // Goods inspection form submission
            const inspectionForm = document.getElementById('goods-inspection-form');
            if (inspectionForm) {
                inspectionForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const orderId = document.getElementById('inspection-order-id').textContent.replace('#', '');
                    const weight = parseFloat(document.getElementById('inspection-weight').value);
                    const weightRate = parseFloat(document.getElementById('inspection-weight-rate').value) || 50000;
                    const notes = document.getElementById('inspection-notes').value.trim();
                    
                    if (!weight || weight <= 0) {
                        showNotification('Vui lòng nhập cân nặng hợp lệ!', 'error');
                        return;
                    }
                    
                    // Check COD fee if section is visible
                    const codSection = document.getElementById('cod-fee-section');
                    let codInfo = 'Đã thiết lập trước đó';
                    if (!codSection.classList.contains('hidden')) {
                        const codType = document.querySelector('input[name="inspection-cod-type"]:checked')?.value;
                        if (codType === 'fixed') {
                            const codAmount = parseFloat(document.getElementById('inspection-cod-amount').value);
                            if (!codAmount || codAmount <= 0) {
                                showNotification('Vui lòng nhập phí COD hợp lệ!', 'error');
                                return;
                            }
                            codInfo = `Phí COD: ${codAmount.toLocaleString('vi-VN')} ₫`;
                        } else {
                            codInfo = 'COD: Tính sau';
                        }
                    }
                    
                    const weightFee = weight * weightRate;
                    
                    showNotification('Đang xử lý kiểm hàng...', 'info');
                    setTimeout(() => {
                        // Update order status to "ready for delivery"
                        updateAdminOrderStatus(orderId, 'ready_delivery', 'Sẵn sàng giao');
                        
                        // Update weight information in table
                        const orderRow = document.querySelector(`tr[data-order-id="${orderId}"]`);
                        if (orderRow) {
                            const trackingCell = orderRow.querySelector('td:nth-child(4)');
                            if (trackingCell) {
                                const existingTracking = trackingCell.querySelector('a')?.textContent || 'Chưa có tracking';
                                trackingCell.innerHTML = `
                                    <a href="#" class="text-blue-600 hover:text-blue-800 text-xs font-medium">${existingTracking}</a>
                                    <div class="text-xs text-gray-500">Cân nặng: ${weight}kg</div>
                                    <div class="text-xs text-green-600">Phí cân: ${weightFee.toLocaleString('vi-VN')} ₫</div>
                                `;
                            }
                        }
                        
                        let successMsg = `Kiểm hàng hoàn tất! Cân nặng: ${weight}kg, Phí: ${weightFee.toLocaleString('vi-VN')} ₫`;
                        if (codInfo !== 'Đã thiết lập trước đó') {
                            successMsg += `, ${codInfo}`;
                        }
                        showNotification(successMsg, 'success');
                    }, 1000);
                    
                    closeModal('goods-inspection-modal');
                    inspectionForm.reset();
                });
            }
            
            // Add event listeners for real-time calculation updates in inspection modal
            document.addEventListener('input', function(e) {
                if (e.target.id === 'inspection-weight' || 
                    e.target.id === 'inspection-weight-rate' || 
                    e.target.id === 'inspection-cod-amount') {
                    updateInspectionCalculation();
                }
            });
            
            // COD fee type toggle
            document.querySelectorAll('input[name="cod-fee-type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const fixedSection = document.getElementById('fixed-cod-section');
                    if (fixedSection) {
                        if (this.value === 'fixed') {
                            fixedSection.classList.remove('hidden');
                        } else {
                            fixedSection.classList.add('hidden');
                        }
                    }
                });
            });

            // Create order button functionality
            const createOrderBtn = document.getElementById('create-order-btn');
            if (createOrderBtn) {
                createOrderBtn.addEventListener('click', function() {
                    showCreateOrderModal();
                });
            }
        });

        function updateOrderStatus(orderId, newStatus, statusText) {
            // Update client side status
            const row = document.querySelector(`tr[data-order-id="${orderId}"]`);
            if (row) {
                const statusBadge = row.querySelector('.px-2\\.5');
                if (statusBadge) {
                    statusBadge.textContent = statusText;
                    statusBadge.className = getStatusBadgeClass(newStatus);
                }
            }
        }

        function updateAdminOrderStatus(orderId, newStatus, statusText) {
            // Update admin side status
            const row = document.querySelector(`tr[data-order-id="${orderId}"]`);
            if (row) {
                const statusBadge = row.querySelector('.px-2');
                if (statusBadge) {
                    statusBadge.textContent = statusText;
                    statusBadge.className = getAdminStatusBadgeClass(newStatus);
                }
                row.setAttribute('data-status', newStatus);
                
                // Update actions based on new status
                updateRowActions(row, newStatus);
            }
        }

        function getStatusBadgeClass(status) {
            const classes = {
                'pending_approval': 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800',
                'waiting_deposit': 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800',
                'ordered': 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800',
                'in_transit_jp': 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800',
                'in_transit_vn': 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-cyan-100 text-cyan-800',
                'checking': 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-teal-100 text-teal-800',
                'waiting_payment': 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800',
                'ready_to_ship': 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800',
                'delivered': 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800'
            };
            return classes[status] || classes['pending_approval'];
        }

        function getAdminStatusBadgeClass(status) {
            const classes = {
                'pending_approval': 'px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded-full font-medium',
                'waiting_deposit': 'px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full font-medium',
                'ordered': 'px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full font-medium',
                'in_transit_jp': 'px-2 py-1 bg-indigo-100 text-indigo-800 text-xs rounded-full font-medium',
                'in_transit_vn': 'px-2 py-1 bg-cyan-100 text-cyan-800 text-xs rounded-full font-medium',
                'checking': 'px-2 py-1 bg-teal-100 text-teal-800 text-xs rounded-full font-medium',
                'waiting_payment': 'px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full font-medium',
                'ready_to_ship': 'px-2 py-1 bg-emerald-100 text-emerald-800 text-xs rounded-full font-medium',
                'delivered': 'px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium'
            };
            return classes[status] || classes['pending_approval'];
        }

        function updateRowActions(row, status) {
            const actionsCell = row.querySelector('td:last-child .flex');
            if (!actionsCell) return;
            
            const orderId = row.getAttribute('data-order-id');
            let newActions = '';
            
            switch(status) {
                case 'waiting_deposit':
                    newActions = `
                        <span class="text-gray-500 text-xs px-2 py-1">Chờ khách</span>
                        <button onclick="showOrderDetail('${orderId}')" class="text-blue-600 hover:text-blue-800 px-2 py-1">
                            <i class="fas fa-eye"></i>
                        </button>
                    `;
                    break;
                    
                case 'ordered':
                    newActions = `
                        <button onclick="handleAdminAction('${orderId}', 'add_tracking')" class="bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 text-xs rounded">
                            <i class="fas fa-plus mr-1"></i>Tracking
                        </button>
                        <button onclick="showOrderDetail('${orderId}')" class="text-blue-600 hover:text-blue-800 px-2 py-1">
                            <i class="fas fa-eye"></i>
                        </button>
                    `;
                    break;
                    
                case 'in_transit_jp':
                    newActions = `
                        <button onclick="handleAdminAction('${orderId}', 'ship_to_vn')" class="bg-indigo-500 hover:bg-indigo-600 text-white px-2 py-1 text-xs rounded">
                            <i class="fas fa-plane mr-1"></i>Chuyển VN
                        </button>
                        <button onclick="showOrderDetail('${orderId}')" class="text-blue-600 hover:text-blue-800 px-2 py-1">
                            <i class="fas fa-eye"></i>
                        </button>
                    `;
                    break;
                    
                case 'waiting_payment':
                    newActions = `
                        <span class="text-gray-500 text-xs px-2 py-1">Chờ khách</span>
                        <button onclick="showOrderDetail('${orderId}')" class="text-blue-600 hover:text-blue-800 px-2 py-1">
                            <i class="fas fa-eye"></i>
                        </button>
                    `;
                    break;
                    
                case 'ready_to_ship':
                    newActions = `
                        <button onclick="handleAdminAction('${orderId}', 'ship_order')" class="bg-emerald-500 hover:bg-emerald-600 text-white px-2 py-1 text-xs rounded">
                            <i class="fas fa-truck mr-1"></i>Giao
                        </button>
                        <button onclick="showOrderDetail('${orderId}')" class="text-blue-600 hover:text-blue-800 px-2 py-1">
                            <i class="fas fa-eye"></i>
                        </button>
                    `;
                    break;
                    
                case 'delivered':
                    newActions = `
                        <span class="text-green-600 bg-green-50 px-2 py-1 rounded-md border border-green-200 text-xs">
                            <i class="fas fa-check mr-1"></i>Hoàn thành
                        </span>
                        <button onclick="showOrderDetail('${orderId}')" class="text-blue-600 hover:text-blue-800 px-2 py-1">
                            <i class="fas fa-eye"></i>
                        </button>
                    `;
                    break;
            }
            
            actionsCell.innerHTML = newActions;
        }

        // TELESALES MANAGEMENT FUNCTIONS
        window.telesalesData = [];
        window.selectedCustomers = [];

        // Excel Import Functions
        window.handleFileSelect = function(input) {
            const file = input.files[0];
            if (!file) return;
            
            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                showNotification('File quá lớn! Vui lòng chọn file dưới 10MB', 'error');
                return;
            }
            
            showNotification('Đang đọc file Excel...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // In real implementation, you would use a library like SheetJS to read Excel
                    // For demo purposes, we'll simulate the data
                    const mockData = [
                        ['Nguyễn Văn Hoàng', 'Nam', '15/05/1990', '123 Lê Lợi, Q1, HCM', '0901111111', 'hoang@email.com', 'Facebook Ad', 'Quan tâm điện tử'],
                        ['Trần Thị Lan', 'Nữ', '22/08/1985', '456 Nguyễn Huệ, Q1, HCM', '0902222222', 'lan@email.com', 'Google Ad', 'Cần tư vấn'],
                        ['Lê Văn Minh', 'Nam', '10/12/1992', '789 Điện Biên Phủ, Q3, HCM', '0903333333', 'minh@email.com', 'Website', 'Khách tiềm năng'],
                        ['Phạm Thị Hoa', 'Nữ', '05/03/1988', '321 Võ Văn Tần, Q3, HCM', '0904444444', 'hoa@email.com', 'Zalo', 'Quan tâm thời trang']
                    ];
                    
                    window.telesalesData = mockData.map((row, index) => ({
                        id: 'IMP' + (index + 1).toString().padStart(3, '0'),
                        name: row[0],
                        gender: row[1],
                        birthday: row[2],
                        address: row[3],
                        phone: row[4],
                        email: row[5] || '',
                        source: row[6] || '',
                        note: row[7] || ''
                    }));
                    
                    showPreviewData();
                    showNotification('Đã đọc thành công ' + mockData.length + ' khách hàng', 'success');
                } catch (error) {
                    showNotification('Lỗi đọc file Excel: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        };

        function showPreviewData() {
            document.getElementById('upload-step').classList.add('hidden');
            document.getElementById('preview-step').classList.remove('hidden');
            document.getElementById('back-btn').classList.remove('hidden');
            document.getElementById('import-btn').classList.remove('hidden');
            
            document.getElementById('preview-count').textContent = window.telesalesData.length;
            
            const tbody = document.getElementById('preview-table-body');
            tbody.innerHTML = window.telesalesData.map(customer => `
                <tr>
                    <td class="p-2">${customer.name}</td>
                    <td class="p-2">${customer.gender}</td>
                    <td class="p-2">${customer.birthday}</td>
                    <td class="p-2">${customer.phone}</td>
                    <td class="p-2 text-xs">${customer.address}</td>
                </tr>
            `).join('');
        }

        window.goBackToUpload = function() {
            document.getElementById('preview-step').classList.add('hidden');
            document.getElementById('upload-step').classList.remove('hidden');
            document.getElementById('back-btn').classList.add('hidden');
            document.getElementById('import-btn').classList.add('hidden');
        };

        window.importCustomers = function() {
            showNotification('Đang import ' + window.telesalesData.length + ' khách hàng...', 'info');
            
            setTimeout(() => {
                // Add imported customers to the table
                const tbody = document.getElementById('customer-table-body');
                const newRows = window.telesalesData.map(customer => `
                    <tr data-customer-id="${customer.id}" data-telesale="" data-status="not_called">
                        <td class="p-3">
                            <input type="checkbox" class="customer-checkbox rounded" value="${customer.id}">
                        </td>
                        <td class="p-3">
                            <div class="font-medium">${customer.name}</div>
                            <div class="text-xs text-gray-500">${customer.gender} • ${customer.birthday}</div>
                        </td>
                        <td class="p-3">
                            <div class="font-medium">${customer.phone}</div>
                            <div class="text-xs text-gray-500">${customer.address}</div>
                        </td>
                        <td class="p-3">
                            <div class="text-xs text-gray-600">Import: ${new Date().toLocaleDateString('vi-VN')}</div>
                            <div class="text-xs text-gray-500">Nguồn: ${customer.source}</div>
                        </td>
                        <td class="p-3">
                            <span class="text-gray-400 text-xs">Chưa gán</span>
                        </td>
                        <td class="p-3 text-center">
                            <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full font-medium">Chưa gán</span>
                        </td>
                        <td class="p-3 text-center">
                            <div class="flex justify-center space-x-1">
                                <button onclick="viewCustomerDetail('${customer.id}')" class="text-blue-600 hover:text-blue-800 px-2 py-1">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="assignSingleCustomer('${customer.id}')" class="text-orange-600 hover:text-orange-800 px-2 py-1">
                                    <i class="fas fa-user-tag"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                tbody.innerHTML = newRows + tbody.innerHTML;
                
                // Update statistics
                updateTelesalesStats();
                
                // Close modal and reset
                const modal = document.getElementById('import-excel-modal');
                modal.classList.add('hidden');
                document.getElementById('excel-file-input').value = '';
                goBackToUpload();
                
                showNotification('Đã import thành công ' + window.telesalesData.length + ' khách hàng!', 'success');
            }, 2000);
        };

        window.downloadTemplate = function() {
            // Create a sample CSV template
            const csvContent = "data:text/csv;charset=utf-8," + 
                "Họ tên,Giới tính,Ngày sinh,Địa chỉ,Số điện thoại,Email,Nguồn khách hàng,Ghi chú\n" +
                "Nguyễn Văn A,Nam,01/01/1990,123 ABC Street,0901234567,email@example.com,Facebook,Khách tiềm năng\n" +
                "Trần Thị B,Nữ,15/05/1985,456 XYZ Street,0987654321,email2@example.com,Google,Quan tâm sản phẩm";
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "template_khach_hang.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // Customer Management Functions
        window.viewCustomerDetail = function(customerId) {
            console.log('Viewing customer detail:', customerId);
            openModal('customer-detail-modal');
        };

        window.editCustomerNote = function(customerId) {
            console.log('Editing customer note:', customerId);
            // Open note editing interface
        };

        window.callCustomer = function(customerId) {
            console.log('Calling customer:', customerId);
            openModal('call-status-modal');
        };

        window.assignSingleCustomer = function(customerId) {
            window.selectedCustomers = [customerId];
            document.getElementById('selected-count').textContent = '1';
            openModal('bulk-assign-modal');
        };

        // Bulk Assignment Functions
        window.confirmBulkAssign = function() {
            const telesaleId = document.getElementById('assign-telesale').value;
            const note = document.getElementById('assign-note').value;
            
            if (!telesaleId) {
                showNotification('Vui lòng chọn Telesale!', 'error');
                return;
            }
            
            showNotification('Đang gán ' + window.selectedCustomers.length + ' khách hàng...', 'info');
            
            setTimeout(() => {
                // Update customer rows
                window.selectedCustomers.forEach(customerId => {
                    const row = document.querySelector(`tr[data-customer-id="${customerId}"]`);
                    if (row) {
                        row.dataset.telesale = telesaleId;
                        row.dataset.status = 'not_called';
                        
                        // Update telesale column
                        const telesaleCell = row.children[4];
                        telesaleCell.innerHTML = `
                            <div class="font-medium text-blue-600">Nguyễn Văn A</div>
                            <div class="text-xs text-gray-500">${telesaleId}</div>
                        `;
                        
                        // Update status column
                        const statusCell = row.children[5];
                        statusCell.innerHTML = '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full font-medium">Chưa gọi</span>';
                        
                        // Update actions
                        const actionsCell = row.children[6];
                        actionsCell.innerHTML = `
                            <div class="flex justify-center space-x-1">
                                <button onclick="viewCustomerDetail('${customerId}')" class="text-blue-600 hover:text-blue-800 px-2 py-1">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="editCustomerNote('${customerId}')" class="text-green-600 hover:text-green-800 px-2 py-1">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="callCustomer('${customerId}')" class="text-purple-600 hover:text-purple-800 px-2 py-1">
                                    <i class="fas fa-phone"></i>
                                </button>
                            </div>
                        `;
                    }
                });
                
                // Clear selections
                window.selectedCustomers = [];
                document.querySelectorAll('.customer-checkbox').forEach(cb => cb.checked = false);
                document.getElementById('select-all-customers').checked = false;
                
                // Close modal
                const modal = document.getElementById('bulk-assign-modal');
                modal.classList.add('hidden');
                
                updateTelesalesStats();
                showNotification('Đã gán thành công khách hàng cho Telesale!', 'success');
            }, 1500);
        };

        // Call Status Functions
        window.saveCallStatus = function() {
            const status = document.querySelector('input[name="call-status"]:checked')?.value;
            const note = document.getElementById('call-note').value;
            
            if (!status || !note.trim()) {
                showNotification('Vui lòng chọn trạng thái và nhập ghi chú!', 'error');
                return;
            }
            
            showNotification('Đang lưu trạng thái cuộc gọi...', 'info');
            
            setTimeout(() => {
                // Update customer status in table
                // This would be implemented based on the selected customer
                
                const modal = document.getElementById('call-status-modal');
                modal.classList.add('hidden');
                
                updateTelesalesStats();
                showNotification('Đã lưu trạng thái cuộc gọi thành công!', 'success');
            }, 1000);
        };

        // Utility Functions
        function updateTelesalesStats() {
            const rows = document.querySelectorAll('#customer-table-body tr');
            let total = rows.length;
            let pending = 0, success = 0, failed = 0;
            
            rows.forEach(row => {
                const status = row.dataset.status;
                if (status === 'not_called') pending++;
                else if (status === 'success') success++;
                else if (status === 'failed') failed++;
            });
            
            document.getElementById('total-customers').textContent = total.toLocaleString();
            document.getElementById('pending-calls').textContent = pending.toLocaleString();
            document.getElementById('success-calls').textContent = success.toLocaleString();
            document.getElementById('failed-calls').textContent = failed.toLocaleString();
        }

        // Event Listeners for Telesales Management
        document.addEventListener('click', function(e) {
            if (e.target.closest('#import-excel-btn')) {
                openModal('import-excel-modal');
            }
            
            if (e.target.closest('#bulk-assign-btn')) {
                const checkedBoxes = document.querySelectorAll('.customer-checkbox:checked');
                if (checkedBoxes.length === 0) {
                    showNotification('Vui lòng chọn ít nhất một khách hàng!', 'error');
                    return;
                }
                
                window.selectedCustomers = Array.from(checkedBoxes).map(cb => cb.value);
                document.getElementById('selected-count').textContent = window.selectedCustomers.length;
                openModal('bulk-assign-modal');
            }
            
            // Handle select all checkbox
            if (e.target.id === 'select-all-customers') {
                const checkboxes = document.querySelectorAll('.customer-checkbox');
                checkboxes.forEach(cb => cb.checked = e.target.checked);
            }
        });

        // Re-initialize when content is loaded
        const originalLoadContent = loadContent;
        window.loadContent = async function(url, title, targetTab) {
            await originalLoadContent(url, title, targetTab);
            console.log('Content loaded:', url);
            
            // Initialize bank history modal for financial management
            if (url.includes('_financial-management.html')) {
                console.log('Financial management loaded, initializing bank history modal...');
                setTimeout(() => {
                    window.initBankHistoryModal();
                    console.log('Bank history modal initialized');
                }, 500);
            }
            
            // Initialize bank transaction history page
            if (url.includes('_bank-transaction-history.html')) {
                console.log('Bank transaction history loaded, initializing page...');
                setTimeout(() => {
                    window.initBankTransactionHistoryPage();
                    console.log('Bank transaction history page initialized');
                }, 300);
            }
            
            // Initialize telesales management
            if (url.includes('_telesales-management.html')) {
                console.log('Telesales management loaded, initializing...');
                setTimeout(() => {
                    updateTelesalesStats();
                    console.log('Telesales management initialized');
                }, 300);
            }
            
            // Initialize order management functions
            if (url.includes('_order-management.html')) {
                console.log('Order management loaded, initializing...');
                setTimeout(() => {
                    if (window.initOrderManagement) {
                        window.initOrderManagement();
                        console.log('Order management initialized');
                    } else {
                        console.error('initOrderManagement function not found');
                    }
                }, 500);
            }
        };
        
        // === DEFINE ORDER MANAGEMENT FUNCTIONS BEFORE INITIALIZATION ===
        // Define essential functions that need to be available immediately
        
        // Warehouse actions modal functionality
        window.showWarehouseActions = function(orderId) {
            console.log('showWarehouseActions called with orderId:', orderId);
            const modal = document.getElementById('warehouse-actions-modal');
            const titleElement = document.getElementById('warehouse-order-title');
            
            // Update modal title with order ID
            if (titleElement) {
                titleElement.textContent = `Đơn hàng #${orderId}`;
            }
            
            // Show modal
            if (modal) {
                modal.classList.remove('hidden');
            }
        };

        // Show warehouse services section for orders with status "Đến kho Nhật" or later
        window.showOrderDetail = function(orderId) {
            console.log('showOrderDetail called with orderId:', orderId);
            const modal = document.getElementById('order-detail-modal');
            const warehouseSection = document.getElementById('warehouse-services-section');
            
            // Get order row to check status
            const orderRow = document.querySelector(`[data-order-id="${orderId}"]`);
            const status = orderRow ? orderRow.getAttribute('data-status') : '';
            
            // Show warehouse services section if order has reached Japan warehouse or later
            const warehouseStatuses = ['in_transit_jp', 'in_transit_vn', 'checking', 'waiting_payment', 'ready_to_ship', 'delivered'];
            if (warehouseStatuses.includes(status)) {
                if (warehouseSection) {
                    warehouseSection.classList.remove('hidden');
                }
            } else {
                if (warehouseSection) {
                    warehouseSection.classList.add('hidden');
                }
            }
            
            // Show modal
            if (modal) {
                modal.classList.remove('hidden');
            }
            
            // Update modal content with order details (this would normally fetch from server)
            const detailOrderId = document.getElementById('detail-order-id');
            if (detailOrderId) {
                detailOrderId.textContent = `#${orderId}`;
            }
        };
        
        // Initialize order management page
        window.initOrderManagement = function() {
            console.log('Initializing order management...');
            
            // Debug: Check all required elements
            const warehouseModal = document.getElementById('warehouse-actions-modal');
            const orderDetailModal = document.getElementById('order-detail-modal');
            const warehouseForm = document.getElementById('warehouse-actions-form');
            const warehousePhotos = document.getElementById('warehouse-photos');
            
            console.log('Debug - Found elements:');
            console.log('- warehouse-actions-modal:', !!warehouseModal);
            console.log('- order-detail-modal:', !!orderDetailModal);
            console.log('- warehouse-actions-form:', !!warehouseForm);
            console.log('- warehouse-photos:', !!warehousePhotos);
            
            // Make sure functions are globally available
            if (!window.showWarehouseActions) {
                console.error('showWarehouseActions function not found');
            } else {
                console.log('✓ showWarehouseActions function available');
            }
            if (!window.showOrderDetail) {
                console.error('showOrderDetail function not found');
            } else {
                console.log('✓ showOrderDetail function available');
            }
            
            // Photo upload preview
            if (warehousePhotos) {
                console.log('Found warehouse photos input, adding event listener');
                warehousePhotos.addEventListener('change', function(e) {
                    const files = e.target.files;
                    const previewDiv = document.getElementById('photo-preview');
                    const previewGrid = document.getElementById('photo-preview-grid');
                    
                    if (files.length > 0) {
                        if (previewDiv) previewDiv.classList.remove('hidden');
                        if (previewGrid) previewGrid.innerHTML = ''; // Clear previous previews
                        
                        Array.from(files).forEach((file, index) => {
                            if (file.type.startsWith('image/')) {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    const imgDiv = document.createElement('div');
                                    imgDiv.className = 'relative';
                                    imgDiv.innerHTML = `
                                        <img src="${e.target.result}" alt="Preview ${index + 1}" 
                                             class="w-full h-20 object-cover rounded border">
                                        <button type="button" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center"
                                                onclick="this.parentElement.remove()">×</button>
                                    `;
                                    previewGrid.appendChild(imgDiv);
                                };
                                reader.readAsDataURL(file);
                            }
                        });
                    } else {
                        if (previewDiv) previewDiv.classList.add('hidden');
                    }
                });
            }
            
            // Warehouse form submission
            if (warehouseForm) {
                warehouseForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Get form data
                    const photoCompleted = document.getElementById('photo-completed')?.checked;
                    const repackageCompleted = document.getElementById('repackage-completed')?.checked;
                    const basicCountCompleted = document.getElementById('basic-count-completed')?.checked;
                    const detailedCountCompleted = document.getElementById('detailed-count-completed')?.checked;
                    
                    const photoFiles = document.getElementById('warehouse-photos')?.files;
                    const repackageNotes = document.getElementById('repackage-notes')?.value;
                    const basicActualQuantity = document.getElementById('basic-actual-quantity')?.value;
                    const detailedActualQuantity = document.getElementById('detailed-actual-quantity')?.value;
                    const itemCondition = document.getElementById('item-condition')?.value;
                    const detailedCountNotes = document.getElementById('detailed-count-notes')?.value;
                    
                    // Validate required actions
                    if (photoCompleted && (!photoFiles || photoFiles.length === 0)) {
                        alert('Vui lòng tải ảnh lên trước khi đánh dấu hoàn thành chụp ảnh.');
                        return;
                    }
                    
                    if (repackageCompleted && (!repackageNotes || !repackageNotes.trim())) {
                        alert('Vui lòng nhập ghi chú đóng gói trước khi đánh dấu hoàn thành repackage.');
                        return;
                    }
                    
                    if (basicCountCompleted && !basicActualQuantity) {
                        alert('Vui lòng nhập số lượng thực tế trước khi đánh dấu hoàn thành kiểm đếm.');
                        return;
                    }
                    
                    // Log warehouse actions
                    console.log('Warehouse actions saved:', {
                        photoCompleted,
                        repackageCompleted,
                        basicCountCompleted,
                        detailedCountCompleted,
                        photoFiles: photoFiles ? photoFiles.length : 0,
                        repackageNotes,
                        basicActualQuantity,
                        detailedActualQuantity,
                        itemCondition,
                        detailedCountNotes
                    });
                    
                    alert('Đã lưu thao tác kho hàng thành công!');
                    
                    // Close modal
                    const modal = document.getElementById('warehouse-actions-modal');
                    if (modal) {
                        modal.classList.add('hidden');
                    }
                    
                    // Reset form
                    this.reset();
                    const photoPreview = document.getElementById('photo-preview');
                    if (photoPreview) {
                        photoPreview.classList.add('hidden');
                    }
                });
            }

            // Close modal handlers
            const closeModalBtns = document.querySelectorAll('.close-modal-btn');
            console.log('Found', closeModalBtns.length, 'close modal buttons');
            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    console.log('Close modal button clicked');
                    const modal = this.closest('.modal-overlay');
                    if (modal) {
                        modal.classList.add('hidden');
                        console.log('Modal closed');
                    }
                });
            });

            // Close modal when clicking backdrop
            const modalOverlays = document.querySelectorAll('.modal-overlay');
            console.log('Found', modalOverlays.length, 'modal overlays');
            modalOverlays.forEach(overlay => {
                overlay.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.add('hidden');
                        console.log('Modal closed via backdrop click');
                    }
                });
            });
        };
        
        // === ORDER MANAGEMENT FUNCTIONS ===
        // These functions need to be available globally for order management page
        
        // Define functions first before initialization
        // Warehouse actions modal functionality
        window.showWarehouseActions = function(orderId) {
            console.log('showWarehouseActions called with orderId:', orderId);
            const modal = document.getElementById('warehouse-actions-modal');
            const titleElement = document.getElementById('warehouse-order-title');
            
            // Update modal title with order ID
            if (titleElement) {
                titleElement.textContent = `Đơn hàng #${orderId}`;
            }
            
            // Show modal
            if (modal) {
                modal.classList.remove('hidden');
            }
        };

        // Show warehouse services section for orders with status "Đến kho Nhật" or later
        window.showOrderDetail = function(orderId) {
            console.log('showOrderDetail called with orderId:', orderId);
            const modal = document.getElementById('order-detail-modal');
            const warehouseSection = document.getElementById('warehouse-services-section');
            
            // Get order row to check status
            const orderRow = document.querySelector(`[data-order-id="${orderId}"]`);
            const status = orderRow ? orderRow.getAttribute('data-status') : '';
            
            // Show warehouse services section if order has reached Japan warehouse or later
            const warehouseStatuses = ['in_transit_jp', 'in_transit_vn', 'checking', 'waiting_payment', 'ready_to_ship', 'delivered'];
            if (warehouseStatuses.includes(status)) {
                if (warehouseSection) {
                    warehouseSection.classList.remove('hidden');
                }
            } else {
                if (warehouseSection) {
                    warehouseSection.classList.add('hidden');
                }
            }
            
            // Show modal
            if (modal) {
                modal.classList.remove('hidden');
            }
            
            // Update modal content with order details (this would normally fetch from server)
            const detailOrderId = document.getElementById('detail-order-id');
            if (detailOrderId) {
                detailOrderId.textContent = `#${orderId}`;
            }
        };
        
        // Initialize order management page
        window.initOrderManagement = function() {
            console.log('Initializing order management...');
            
            // Debug: Check all required elements
            const warehouseModal = document.getElementById('warehouse-actions-modal');
            const orderDetailModal = document.getElementById('order-detail-modal');
            const warehouseForm = document.getElementById('warehouse-actions-form');
            const warehousePhotos = document.getElementById('warehouse-photos');
            
            console.log('Debug - Found elements:');
            console.log('- warehouse-actions-modal:', !!warehouseModal);
            console.log('- order-detail-modal:', !!orderDetailModal);
            console.log('- warehouse-actions-form:', !!warehouseForm);
            console.log('- warehouse-photos:', !!warehousePhotos);
            
            // Make sure functions are globally available
            if (!window.showWarehouseActions) {
                console.error('showWarehouseActions function not found');
            } else {
                console.log('✓ showWarehouseActions function available');
            }
            if (!window.showOrderDetail) {
                console.error('showOrderDetail function not found');
            } else {
                console.log('✓ showOrderDetail function available');
            }
            
            // Photo upload preview
            if (warehousePhotos) {
                console.log('Found warehouse photos input, adding event listener');
                warehousePhotos.addEventListener('change', function(e) {
                    const files = e.target.files;
                    const previewDiv = document.getElementById('photo-preview');
                    const previewGrid = document.getElementById('photo-preview-grid');
                    
                    if (files.length > 0) {
                        if (previewDiv) previewDiv.classList.remove('hidden');
                        if (previewGrid) previewGrid.innerHTML = ''; // Clear previous previews
                        
                        Array.from(files).forEach((file, index) => {
                            if (file.type.startsWith('image/')) {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    const imgDiv = document.createElement('div');
                                    imgDiv.className = 'relative';
                                    imgDiv.innerHTML = `
                                        <img src="${e.target.result}" alt="Preview ${index + 1}" 
                                             class="w-full h-20 object-cover rounded border">
                                        <div class="absolute top-1 right-1 bg-black bg-opacity-50 text-white text-xs px-1 rounded">
                                            ${index + 1}
                                        </div>
                                    `;
                                    if (previewGrid) previewGrid.appendChild(imgDiv);
                                };
                                reader.readAsDataURL(file);
                            }
                        });
                    } else {
                        if (previewDiv) previewDiv.classList.add('hidden');
                    }
                });
            }

            // Warehouse actions form submission
            const warehouseActionsForm = document.getElementById('warehouse-actions-form');
            if (warehouseActionsForm) {
                console.log('Found warehouse actions form, adding submit event listener');
                warehouseActionsForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const photoCompleted = document.getElementById('photo-completed')?.checked;
                    const repackageCompleted = document.getElementById('repackage-completed')?.checked;
                    const basicCountCompleted = document.getElementById('basic-count-completed')?.checked;
                    const detailedCountCompleted = document.getElementById('detailed-count-completed')?.checked;
                    
                    const photoFiles = document.getElementById('warehouse-photos')?.files;
                    const repackageNotes = document.getElementById('repackage-notes')?.value;
                    const basicActualQuantity = document.getElementById('basic-actual-quantity')?.value;
                    const detailedActualQuantity = document.getElementById('detailed-actual-quantity')?.value;
                    const itemCondition = document.getElementById('item-condition')?.value;
                    const detailedCountNotes = document.getElementById('detailed-count-notes')?.value;
                    
                    // Validate required actions
                    if (photoCompleted && (!photoFiles || photoFiles.length === 0)) {
                        alert('Vui lòng tải ảnh lên trước khi đánh dấu hoàn thành chụp ảnh.');
                        return;
                    }
                    
                    if (repackageCompleted && (!repackageNotes || !repackageNotes.trim())) {
                        alert('Vui lòng nhập ghi chú đóng gói trước khi đánh dấu hoàn thành repackage.');
                        return;
                    }
                    
                    if (basicCountCompleted && !basicActualQuantity) {
                        alert('Vui lòng nhập số lượng thực tế trước khi đánh dấu hoàn thành kiểm đếm.');
                        return;
                    }
                    
                    // Simulate saving warehouse actions
                    const actions = [];
                    if (photoCompleted) actions.push('Chụp ảnh');
                    if (repackageCompleted) actions.push('Repackage');
                    if (basicCountCompleted) actions.push('Kiểm đếm');
                    
                    alert(`Đã lưu thành công các thao tác kho hàng: ${actions.join(', ')}`);
                    
                    // Close modal
                    const modal = document.getElementById('warehouse-actions-modal');
                    if (modal) {
                        modal.classList.add('hidden');
                    }
                    
                    // Reset form
                    this.reset();
                    const photoPreview = document.getElementById('photo-preview');
                    if (photoPreview) {
                        photoPreview.classList.add('hidden');
                    }
                });
            }

            // Close modal handlers
            const closeModalBtns = document.querySelectorAll('.close-modal-btn');
            console.log('Found', closeModalBtns.length, 'close modal buttons');
            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    console.log('Close modal button clicked');
                    const modal = this.closest('.modal-overlay');
                    if (modal) {
                        modal.classList.add('hidden');
                        console.log('Modal closed');
                    }
                });
            });

            // Close modal when clicking backdrop
            const modalOverlays = document.querySelectorAll('.modal-overlay');
            console.log('Found', modalOverlays.length, 'modal overlays');
            modalOverlays.forEach(overlay => {
                overlay.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.add('hidden');
                        console.log('Modal closed via backdrop click');
                    }
                });
            });
        };
    </script>
</body>

</html>